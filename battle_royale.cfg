#textdomain wesnoth-multiplayer

#scrapped, since custom colors unfortunately require the add-on to be installed for players besides host to work
#[color_range]#used for bot-only sides
#    id=battle_royale_yellow
#    name=_"Yellow"
#    rgb=E7ED2D,FFFFFF,000000,EDCB0C
#[/color_range]

#change between human/ai for testing

#define BATTLE_ROYALE_CONTROLLER
ai#enddef

#define BATTLE_ROYALE_ITEM_LOCATION_FILTER
[not]
    terrain=X*^*,Q*^*,*^X*,*^Xm,_off^_usr,Wo*^*#never spawns items on impassable terrain
    [or]
        find_in=battle_royale_loot_tiles
    [/or]
[/not]
#enddef

#define BATTLE_ROYALE_SIDE_SETTINGS
        gold=50
        income=-2
        village_gold=1
        [ai]
        leader_ignores_keep=yes
        leader_aggression=0.7
        aggression=1.0
#might have caused AI to get stuck at times, possibly refusing to go through this terrain. removed for now
#        [avoid]
#            terrain=Ur^Efm
#        [/avoid]
        [goal]
            name=target
            [criteria]
                canrecruit=yes
            [/criteria]
            value=25
        [/goal]
        [goal]
            name=target_location
            [criteria]
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=5
            [/filter_location]
            [/criteria]
            value=30
        [/goal]
        village_value=0.1
        [/ai]        
#enddef

#define BATTLE_ROYALE_MICROAI SIDE ENEMYSIDE
#        [micro_ai]
#            side={SIDE}
#            ai_type=hang_out
#            action=add
#            id=battleroyale_movetocenter
#            [filter]
#                canrecruit=yes
#            [filter_location]
#            [not]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=5
#            [/not]
#            [/filter_location]
#            [/filter]
#            [filter_location]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=2
#            [/filter_location]
#            ca_score=30000#relatively low CA score, as other actions are higher priority
#        [/micro_ai]
        [micro_ai]
            side={SIDE}
#            ai_type=hang_out
            ai_type=goto
            action=add
            id=battleroyale_movetocenter_when_near_void
            [filter]
##commented out, so that spawned allies also flee from void
##                canrecruit=yes
#            [filter_location]
#            [not]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=5
#            [/not]
#            [and]
#                terrain=Xv
#                radius=4
#            [/and]
#            [/filter_location]
            [filter_location]
                terrain=Ur^Efm
            [/filter_location]
            [/filter]
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=2
            [/filter_location]
            ca_score=195000#very high CA score, as fleeing from the void is more important than combat/items
            unique_goals=yes
            remove_movement=no
        [/micro_ai]
#        [micro_ai]
#            side={SIDE}
#            ai_type=hang_out
#            action=add
#            id=battleroyale_chaseenemy
#            [filter]
#                canrecruit=yes
#            [filter_location]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=5
#            [/filter_location]
#            [/filter]
#            [filter_location]
#            [filter]
#            canrecruit=yes
#            [filter_side]
#            [enemy_of]
#            side={SIDE}
#            [/enemy_of]
#            [/filter_side]
#            [/filter]
#            [/filter_location]
#            ca_score=30000#relatively low CA score, as other actions are higher priority
#        [/micro_ai]
#enddef

#define BATTLE_ROYALE_MICROAI_ITEMS SIDE ENEMYSIDE
        #AI for 40p and 100p matches is slightly simplified - it ignores far away items and only picks up nearby ones. should make AI turns slightly faster
        [if]
        {VARIABLE_CONDITIONAL battle_royale_enemyside greater_than_equal_to 40}
        [else]
        [micro_ai]
            side={SIDE}
            ai_type=goto
            action=add
            ca_id=battleroyale_get_items
            [filter]
                [not]
                    side={ENEMYSIDE}#AI creatures/ghosts side
                [/not]
                [filter_location]
                    find_in=battle_royale_loot_tiles
                    radius=10
                [/filter_location]
            [/filter]
            [filter_location]
                find_in=battle_royale_loot_tiles
                [not]
                    terrain=Ur^Efm#taking items on tiles about to be consumed by void is a guaranteed death for AI, as the goto micro ai stops movement
                [/not]
                [filter_vision]
                    side={SIDE}
                    visible=yes
                    respect_fog=yes
                [/filter_vision]
            [/filter_location]
            ca_score=70000#priority is lower than to attack
            remove_movement=no
            unique_goals=yes
        [/micro_ai]
        [/else]
        [/if]
        [micro_ai]
            side={SIDE}
            ai_type=goto
            action=add
            ca_id=battleroyale_get_items_near

            [filter]
                [not]
                    side={ENEMYSIDE}#AI creatures/ghosts side
                [/not]
                [filter_location]
                    find_in=battle_royale_loot_tiles
                    radius=4
                [/filter_location]
            [/filter]
            [filter_location]
                find_in=battle_royale_loot_tiles
                [not]
                    terrain=Ur^Efm#taking items on tiles about to be consumed by void is a guaranteed death for AI, as the goto micro ai stops movement
                [/not]
                [filter_vision]
                    side={SIDE}
                    visible=yes
                    respect_fog=yes
                [/filter_vision]
            [/filter_location]
            ca_score=150000#getting nearby items is higher priority than attack
            remove_movement=no
            unique_goals=yes
        [/micro_ai]
#enddef

#shared settings between battle royale scenarios and item mod:

#define BATTLE_ROYALE_SHARED_SETTINGS
    [checkbox]
        id=battleroyale_item_mod_disablesummons
        default=no
        name="Disable Summons"
        description="Disable unit-spawning items, like rat cage,mausoleum,cloning circle and more (including the necronomicon). If you want to play just as one character (in an RPG map, for example), this could be useful."
    [/checkbox]
    [checkbox]
        id=battleroyale_item_mod_disableskins
        default=no
        name="Disable Skins"
        description="Disables the 'Random Skin' common item."
    [/checkbox]
#enddef

#define BATTLE_ROYALE_SETTINGS
[options]
#        [checkbox]
#            id=battleroyale_respawn
#            default=yes
#            name="Enable Ghosts"
#            description="When players die, AI-controlled ghosts of their unit are spawned some time after."
#        [/checkbox]
        [checkbox]
            id=battleroyale_noghost
            default=no
            name="Disable Ghosts"
            description="Disables the AI-controlled ghosts that spawn some time after players die."
        [/checkbox]
        [checkbox]
            id=battleroyale_noshrink
            default=no
            name="Disable Shrinking Map"
            description="Disables the map shrinking over the course of the match"
        [/checkbox]
        [checkbox]
            id=battleroyale_noloot
            default=no
            name="Disable Loot"
            description="Disables random items that spawn on the map."
        [/checkbox]
        [checkbox]
            id=battleroyale_see_items_in_fog
            default=no
            name="Can see items in fog"
            description="If enabled, you will be able to see items through fog."
        [/checkbox]
        {BATTLE_ROYALE_SHARED_SETTINGS}
[/options]
#enddef

#define BATTLE_ROYALE_SPAWNITEM X Y TEXT TEXT_COLOR IMAGE HALO NAME MESSAGE EFFECT
{VARIABLE br_tmp_x {X}}
{VARIABLE br_tmp_y {Y}}
[label]
    text={TEXT}
    x,y=$br_tmp_x,$br_tmp_y
    color={TEXT_COLOR}
    visible_in_fog=$battleroyale_see_items_in_fog
[/label]
[set_variables]
    name=battle_royale_loot_tiles
    mode=append
    [value]
        x=$br_tmp_x
        y=$br_tmp_y
    [/value]
[/set_variables]
[item]
    x=$br_tmp_x
    y=$br_tmp_y
    name=battleroyale_item_{IMAGE}
    image={IMAGE}
    halo={HALO}
    visible_in_fog=$battleroyale_see_items_in_fog
[/item]
[event]
    name=battleroyale_item_pickup
    delayed_variable_substitution=no
    first_time_only=yes
    [filter]
        x,y=$br_tmp_x,$br_tmp_y
#commented out, as the side/AI check is now done later for the sake of compatibility with item mod
#UPD: this is also now handled inside the item pickup moveto wrapper event lower in the file
#        [not]
#            side=$battle_royale_enemyside#AI creatures/ghosts side
#        [/not]
    [/filter]

#    {IF_VAR battle_royale_itemeffect_after_clear not_equals yes (
#    [then]
        {EFFECT}
#    [/then]
#    )}
    [remove_item]
        x,y=$br_tmp_x,$br_tmp_y
        image=battleroyale_item_{IMAGE}
    [/remove_item]
    [label]
        text=""
        x,y=$br_tmp_x,$br_tmp_y
    [/label]
    #messages are only shown if the item is taken by a human side:
    [lua]
        code=<<
local result = wesnoth.sync.evaluate_single(
  function()
    return { value = "no" }
  end,
  function()
    -- Called only on the client handling the current side, if it is an AI.
    return { value = "yes" }
  end)
wml.variables["br_is_ai"] = result.value
        >>
    [/lua]
    [floating_text]
       x,y=$br_tmp_x,$br_tmp_y
       text=_"picked up item"
    [/floating_text]
    {IF_VAR br_is_ai not_equals yes (
    [then]
    [message]
        speaker=narrator
        caption={NAME}
        side_for=$|side_number
        image={IMAGE}"~SCALE(144,144)"
        message={MESSAGE}
    [/message]
    [/then]
    )}
#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$|battle_royale_loot_tiles.length
    [/variable]
    [do]
        {IF_VAR battle_royale_loot_tiles[$|c].x equals $br_tmp_x (
        [and]
            {VARIABLE_CONDITIONAL battle_royale_loot_tiles[$|c].y equals $br_tmp_y}
        [/and]
        [then]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$|c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        )}
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}

#    {IF_VAR battle_royale_itemeffect_after_clear equals yes (
#    [then]
#        {EFFECT}
#    [/then]
#    )}

#    {CLEAR_VARIABLE battle_royale_itemeffect_after_clear}

[/event]
{CLEAR_VARIABLE br_tmp_x,br_tmp_y}
#enddef

#different item rarities have different colors

#define BATTLE_ROYAL_ITEM_CASE_COMMON NUM TEXT IMAGE MESSAGE CODE
[case]
   value={NUM}
#   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Common)" 100,100,255 {IMAGE} () {TEXT} {MESSAGE} {CODE}}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT} 100,100,255 {IMAGE} () {TEXT} {MESSAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYAL_ITEM_CASE_RARE NUM TEXT IMAGE MESSAGE CODE
[case]
   value={NUM}
#   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Rare)" 200,0,255 {IMAGE} () {TEXT} {MESSAGE} {CODE}}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT} 200,0,255 {IMAGE} () {TEXT} {MESSAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYAL_ITEM_CASE_LEGENDARY NUM TEXT IMAGE HALO MESSAGE CODE
[case]
   value={NUM}
#   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Legendary)" 255,255,0 {IMAGE} {HALO} {TEXT} {MESSAGE} {CODE}}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT} 255,255,0 {IMAGE} {HALO} {TEXT} {MESSAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_COMMON X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    id=battleroyale_spawn_item_common
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_RARE X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    id=battleroyale_spawn_item_rare
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    id=battleroyale_spawn_item_legendary
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON X Y ITEM_NUM_TYPE
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
{VARIABLE battle_royale_force_specific_itemspawn yes}
{VARIABLE battle_royale_item_type {ITEM_NUM_TYPE}}
[fire_event]
    id=battleroyale_spawn_item_common
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y,battle_royale_force_specific_itemspawn}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_RARE X Y ITEM_NUM_TYPE
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
{VARIABLE battle_royale_force_specific_itemspawn yes}
{VARIABLE battle_royale_item_type {ITEM_NUM_TYPE}}
[fire_event]
    id=battleroyale_spawn_item_rare
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y,battle_royale_force_specific_itemspawn}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_LEGENDARY X Y ITEM_NUM_TYPE
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
{VARIABLE battle_royale_force_specific_itemspawn yes}
{VARIABLE battle_royale_item_type {ITEM_NUM_TYPE}}
[fire_event]
    id=battleroyale_spawn_item_legendary
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y,battle_royale_force_specific_itemspawn}
#enddef





#used for lootboxes and other multi-item drop items
#define BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED TIMES X Y CODE
{REPEAT {TIMES} (

    {VARIABLE tmp_itemplace_radius 0}
    [while]
        {VARIABLE_CONDITIONAL tmp_itemplace_radius less_than 10}#failsafe just in case the code gets stuck in some very rare edge case
        [and]
        [not]
            {VARIABLE_CONDITIONAL itemplace_locs.length greater_than 0}
        [/not]
        [/and]
        [do]
        [store_locations]
            include_borders=no
            {BATTLE_ROYALE_ITEM_LOCATION_FILTER}
            [and]
                x,y={X},{Y}
                radius=$|tmp_itemplace_radius
            [/and]
            variable=itemplace_locs
        [/store_locations]
        {VARIABLE_OP tmp_itemplace_radius add 1}
        [/do]
    [/while]

    {VARIABLE tmp_unoccupied_item.x $|itemplace_locs[0].x}
    {VARIABLE tmp_unoccupied_item.y $|itemplace_locs[0].y}

    {CODE}

    {CLEAR_VARIABLE itemplace_locs,tmp_itemplace_radius,tmp_unoccupied_item}
)}
#enddef

#used for mob drops and anything else that isn't called from another item
#define BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT TIMES X Y CODE
{REPEAT {TIMES} (

    {VARIABLE tmp_itemplace_radius 0}
    [while]
        {VARIABLE_CONDITIONAL tmp_itemplace_radius less_than 10}#failsafe just in case the code gets stuck in some very rare edge case
        [and]
        [not]
            {VARIABLE_CONDITIONAL itemplace_locs.length greater_than 0}
        [/not]
        [/and]
        [do]
        [store_locations]
            include_borders=no
            {BATTLE_ROYALE_ITEM_LOCATION_FILTER}
            [and]
                x,y={X},{Y}
                radius=$tmp_itemplace_radius
            [/and]
            variable=itemplace_locs
        [/store_locations]
        {VARIABLE_OP tmp_itemplace_radius add 1}
        [/do]
    [/while]

        {VARIABLE tmp_unoccupied_item.x $itemplace_locs[0].x}
        {VARIABLE tmp_unoccupied_item.y $itemplace_locs[0].y}

    {CODE}

    {CLEAR_VARIABLE itemplace_locs,tmp_itemplace_radius,tmp_unoccupied_item}
)}
#enddef

#define BATTLE_ROYALE_ITEM_INCREASE_RESISTANCE_WITH_FALLOFF TYPE
    {VARIABLE tmp_visible_resistance $|unit.resistance.{TYPE}|}
    {VARIABLE_OP tmp_visible_resistance sub 100}
    {VARIABLE_OP tmp_visible_resistance multiply -1}
#    [chat]
#        message="{TYPE} resistance: $|tmp_visible_resistance|"
#    [/chat]
    [if]
    {VARIABLE_CONDITIONAL tmp_visible_resistance greater_than_equal_to 90}
    [then]
        {VARIABLE tmp_falloff_resistance 1}
    [/then]
    [elseif]
    {VARIABLE_CONDITIONAL tmp_visible_resistance greater_than_equal_to 80}
    [then]
        {VARIABLE tmp_falloff_resistance 2}
    [/then]
    [/elseif]
    [elseif]
    {VARIABLE_CONDITIONAL tmp_visible_resistance greater_than_equal_to 50}
    [then]
        {VARIABLE tmp_falloff_resistance 5}
    [/then]
    [/elseif]
    [else]
        {VARIABLE tmp_falloff_resistance 10}
    [/else]
    [/if]
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                {TYPE}=-$|tmp_falloff_resistance|
            [/resistance]
        [/effect]
    [/object]
    {CLEAR_VARIABLE tmp_falloff_resistance}
    {CLEAR_VARIABLE tmp_visible_resistance}
#enddef

#using events/fire_event instead of macros, as macros create crash-causing macro recursion issues with lootbox
#define BATTLE_ROYALE_ITEM_SPAWN_EVENTS
#[event]
#    name=battleroyale_spawn_item_common
#    first_time_only=no
#    {VARIABLE_OP battle_royale_item_type rand 1..10}
#    [fire_event]
#        name=battleroyale_spawn_item_common_specific_type
#    [/fire_event]
#    {CLEAR_VARIABLE battle_royale_item_type}
#
#[/event]

#item pickup is handled via custom event, because since the item-pickup events always first_time_only, it is impossible to make proper "don't pick up if the unit is AI" lua code inside the moveto event itself without tedious lua_function filter shenanigans.
[event]
    name=moveto
    id=battleroyale_itempickup_moveto_event
    first_time_only=no
    [filter]
        [filter_location]
            find_in=battle_royale_loot_tiles
        [/filter_location]
    [/filter]
    #check if the moveto unit is AI, the third argument is the side the code runs for
    [lua]
        code=<<

local result = wesnoth.sync.evaluate_single(
  function()
    return { value = "no" }
  end,
  function()
    -- Called only on the client handling the current side, if it is an AI.
    return { value = "yes" }
  end, wml.variables["unit.side"])
wml.variables["br_is_ai"] = result.value
        >>
    [/lua]
    [if]
    {VARIABLE_CONDITIONAL br_is_ai equals yes}
    [and]
        {VARIABLE_CONDITIONAL battle_royale_item_mod equals yes}
    [/and]
    [and]
        {VARIABLE_CONDITIONAL battleroyale_mod_ai_pickup equals yes}
    [/and]
    [or]
        {VARIABLE_CONDITIONAL battle_royale_item_mod equals yes}
        [and]
            {VARIABLE_CONDITIONAL br_is_ai equals no}
        [/and]
    [/or]
    [or]
        {VARIABLE_CONDITIONAL unit.side not_equals $battle_royale_enemyside}
        [and]
            {VARIABLE_CONDITIONAL battle_royale_item_mod not_equals yes}
        [/and]
    [/or]
    [then]
    [fire_event]
        name=battleroyale_item_pickup
        [primary_unit]
            x,y=$x1,$y1
        [/primary_unit]
    [/fire_event]
    [/then]
    [/if]
    {CLEAR_VARIABLE br_is_ai}
[/event]

[event]
    id=battleroyale_spawn_item_common
    first_time_only=no
    {IF_VAR battle_royale_force_specific_itemspawn not_equals yes (
    [then]
        #some options can prevent certain items from spawning
         #replaced number ids with text ids, so I don't have to care about exact order of switch cases anymore, plus makes the 'spawn specific item' code more readable
        {VARIABLE battleroyale_commonrand potion_heal,potion_exp,potion_speed,potion_strength,elven_cloak,poison_bottle,armor_iron,armor_wardamulet,legendary_fragment}
        {IF_VAR battleroyale_item_mod_disablesummons equals yes (
        [else]
        {VARIABLE battleroyale_commonrand $battleroyale_commonrand|,rat_cage,bonestack}
        [/else]
        )}
        {IF_VAR battleroyale_item_mod_disableskins equals yes (
        [else]
        {VARIABLE battleroyale_commonrand $battleroyale_commonrand|,random_skin}
        [/else]
        )}
        {IF_VAR battleroyale_item_mod_disableportals equals yes (
        [else]
        {VARIABLE battleroyale_commonrand $battleroyale_commonrand|,portal}
        [/else]
        )}
        {VARIABLE_OP battle_royale_item_type rand $battleroyale_commonrand|}
    [/then]
    )}
[switch]
    variable=battle_royale_item_type
    {BATTLE_ROYAL_ITEM_CASE_COMMON potion_heal _"Heal Potion" "items/potion-red.png" _"Health restored to full" (
    [sound]
        name=potion.ogg
    [/sound]
    [heal_unit]
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        amount=full
        animate=yes
    [/heal_unit]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON potion_exp _"EXP Potion" "items/potion-blue.png" _"You gain 16 experience" (
    [sound]
        name=potion.ogg
    [/sound]
    [modify_unit]
        [filter]
            id=$|unit.id
        [/filter]
        experience="$|($|unit.experience + 16)"
    [/modify_unit]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON elven_cloak _"Elven Cloak" "items/cloak-green.png" _"Wearing an elven cloak allows you to hide in forests, sets your forest defense to 70%, and sets forest movecost to 1. Each cloak you take after the first one increases forest defense by 5%, up to 90% max" (

    [modify_unit]
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        {VARIABLE_OP battleroyale_elvencloaks add 1}
    [/modify_unit]

    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
            formula="wml_vars.battleroyale_elvencloaks = 1"
        [/filter]
        [effect]
            apply_to=defense
            replace=yes
            [defense]
                forest=30
            [/defense]
        [/effect]
        [effect]
            apply_to=movement_costs
            replace=yes
            [movement_costs]
                forest=1
            [/movement_costs]
        [/effect]
        [effect]
            apply_to=new_ability
            [abilities]
                {ABILITY_AMBUSH}
            [/abilities]
        [/effect]
    [/object]

    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
            formula="wml_vars.battleroyale_elvencloaks > 1"
            [and]
            formula="wml_vars.battleroyale_elvencloaks < 6"
            [/and]
        [/filter]
        [effect]
            apply_to=defense
            replace=no
            [defense]
                forest=-5
            [/defense]
        [/effect]
    [/object]

    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON poison_bottle _"Poison Bottle" "items/potion-poison.png" _"All your current attacks gain poison. When you take multiple poison bottles, gain 15% more damage against poisoned enemies for each poison bottle after the first one." (
    [modify_unit]
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        {VARIABLE_OP battleroyale_poisonbottles add 1}
    [/modify_unit]

    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=attack
            [not]
                special_id=poison
            [/not]
            [set_specials]
                mode=append
                {WEAPON_SPECIAL_POISON}
            [/set_specials]
        [/effect]
    [/object]

    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
            formula="wml_vars.battleroyale_poisonbottles = 2"
        [/filter]
        [effect]
            apply_to=new_ability
            [abilities]
                [damage]
                    id=battleroyale_poison_damage_bonus
                    name= _ "poison bottle"
                    description= _ "Deals more damage to poisoned enemies (15% per poison bottle you take, after the first one)"
                    multiply="(1 + ((attacker.wml_vars.battleroyale_poisonbottles - 1) * 0.15))"
                    apply_to=self
                    active_on=offense
                    [filter_opponent]
                        [filter_wml]
                            [status]
                                poisoned=yes
                            [/status]
                        [/filter_wml]
                    [/filter_opponent]
                [/damage]
                [damage]
                    id=battleroyale_poison_damage_bonus2
                    multiply="(1 + ((defender.wml_vars.battleroyale_poisonbottles - 1) * 0.15))"
                    apply_to=self
                    active_on=defense
                    [filter_opponent]
                        [filter_wml]
                            [status]
                                poisoned=yes
                            [/status]
                        [/filter_wml]
                    [/filter_opponent]
                [/damage]
            [/abilities]
        [/effect]
    [/object]


    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON rat_cage _"Rat Cage" "units/monsters/giant-rat.png~BLIT(items/cage.png)" _"Summoned four Giant Rats" (
        {REPEAT 4 (
           [unit]
               type=Giant Rat
               side=$|side_number
               generate_name=yes
               random_traits=yes
               placement=map
               passable=yes
               x,y=$|x1,$|y1
           [/unit]
        )}
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON armor_iron _"Iron Armor" "items/armor.png" _"Increases your physical resistances by 10%

If a specific resistance is 50% or above, it is increased by 5% instead
If a specific resistance is 80% or above, it is increased by 2% instead
If a specific resistance is 90% or above, it is increased by 1% instead" (
#    [object]
#        duration=forever
#        silent=yes
#        [filter]
#            x,y=$|x1,$|y1
#        [/filter]
#        [effect]
#            apply_to=resistance
#            replace=no
#            [resistance]
#                blade=-10
#                pierce=-10
#                impact=-10
#            [/resistance]
#        [/effect]
#    [/object]
    {BATTLE_ROYALE_ITEM_INCREASE_RESISTANCE_WITH_FALLOFF blade}
    {BATTLE_ROYALE_ITEM_INCREASE_RESISTANCE_WITH_FALLOFF pierce}
    {BATTLE_ROYALE_ITEM_INCREASE_RESISTANCE_WITH_FALLOFF impact}
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON armor_wardamulet _"Warding Amulet" "items/ankh-necklace.png" _"Increases your magical resistances by 10%

If a specific resistance is 50% or above, it is increased by 5% instead
If a specific resistance is 80% or above, it is increased by 2% instead
If a specific resistance is 90% or above, it is increased by 1% instead" (
#    [object]
#        duration=forever
#        silent=yes
#        [filter]
#            x,y=$|x1,$|y1
#        [/filter]
#        [effect]
#            apply_to=resistance
#            replace=no
#            [resistance]
#                arcane=-10
#                fire=-10
#                cold=-10
#            [/resistance]
#        [/effect]
#    [/object]
    {BATTLE_ROYALE_ITEM_INCREASE_RESISTANCE_WITH_FALLOFF arcane}
    {BATTLE_ROYALE_ITEM_INCREASE_RESISTANCE_WITH_FALLOFF fire}
    {BATTLE_ROYALE_ITEM_INCREASE_RESISTANCE_WITH_FALLOFF cold}
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON potion_strength _"Strength Potion" "items/potion-yellow.png" _"All your attacks gain 1 more damage. You gain 6 more max HP" (
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=attack
            increase_damage=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase=6
            increase_total=6
        [/effect]        
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON potion_speed _"Speed Potion" "items/potion-grey.png" _"Gain 1 more movement" (
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON random_skin _"Random Skin" "misc/blank-hex.png~BLIT(items/box.png~SCALE(50,50)~GS()~BLEND(0,0,255,0.3),11,11)" _"Get a random skin (recolor effect on your unit, replaces any previous skins. Purely visual, no gameplay effects)" (

        {VARIABLE_OP tmp_skin_type_rand rand 1..15}
        [switch]
            variable=tmp_skin_type_rand
            [case]
                value=1
                {VARIABLE tmp_imagemod "~GS()"}
            [/case]
            [case]
                value=2
                {VARIABLE tmp_imagemod "~NEG()"}
            [/case]
            [case]
                value=3
                {VARIABLE tmp_imagemod "~BW(100)"}
            [/case]
            [case]
                value=4
                {VARIABLE tmp_imagemod "~BLEND(0,0,0,1)"}
            [/case]
            [case]
                value=5
                {VARIABLE tmp_imagemod "~GS()~BLEND(255,0,0,0.3)"}
            [/case]
            [case]
                value=6
                {VARIABLE tmp_imagemod "~GS()~BLEND(255,255,255,0.3)"}
            [/case]
            [case]
                value=7
                {VARIABLE tmp_imagemod "~GS()~BLEND(0,0,255,0.3)"}
            [/case]
            [case]
                value=8
                {VARIABLE tmp_imagemod "~GS()~BLEND(0,0,0,0.3)"}
            [/case]
            [case]
                value=9
                {VARIABLE tmp_imagemod "~SEPIA()"}
            [/case]
            [case]
                value=10
                {VARIABLE tmp_imagemod "~FL(vert)"}
            [/case]
            [case]
                value=11
                {VARIABLE tmp_imagemod "~GS()~BLEND(200,0,255,0.3)"}
            [/case]
            [case]
                value=12
                {VARIABLE tmp_imagemod "~GS()~BLEND(255,200,0,0.3)"}
            [/case]
            [case]
                value=13
                {VARIABLE tmp_imagemod "~O(60%)"}
            [/case]
            [case]
                value=14
                {VARIABLE tmp_imagemod "~FL(horiz)"}
            [/case]
            [case]
                value=15
                {VARIABLE tmp_imagemod "~BL(3)"}
            [/case]
        [/switch]

        [object]
            duration=forever
            silent=yes
            [filter]
                x,y=$|x1,$|y1
            [/filter]
            [effect]
                apply_to=image_mod
#                add=$|tmp_imagemod
                replace=$|tmp_imagemod
            [/effect]
        [/object]


        {CLEAR_VARIABLE tmp_skin_type_rand}
        {CLEAR_VARIABLE tmp_imagemod}

    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON legendary_fragment _"Legendary Fragment" "items/talisman-ankh.png~NO_TOD_SHIFT()" _"If you collect 4 of these fragments (can be carried by different units), you will get a <span color='#ffff00'>Legendary</span> item. Unlike most other items, this one can be dropped on death after being picked up." (
    [modify_unit]
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        {VARIABLE_OP battleroyale_fragments add 1}
    [/modify_unit]

    [store_unit]
        [filter]
            side=$|side_number
            formula="wml_vars.battleroyale_fragments > 0"
        [/filter]
        variable=tmp_fragment_units
        kill=no
    [/store_unit]

    {VARIABLE tmp_current_side_fragments 0}

    [foreach]
        array=tmp_fragment_units
        index_var=i
        [do]
            {VARIABLE_OP tmp_current_side_fragments add $|this_item.variables.battleroyale_fragments}
        [/do]
    [/foreach]

    {IF_VAR tmp_current_side_fragments greater_than_equal_to 4 (
    [then]
        {VARIABLE tmp_leftover_fragments $|tmp_current_side_fragments}
        {VARIABLE_OP tmp_leftover_fragments sub 4}

        {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED $|tmp_leftover_fragments $|x1 $|y1 (
            {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y 11}#spawns one fragment
        )}

        [foreach]
            array=tmp_fragment_units
            index_var=i
            [do]
                [modify_unit]
                    [filter]
                        id=$|this_item.id
                    [/filter]
                    {CLEAR_VARIABLE battleroyale_fragments}
                [/modify_unit]
            [/do]
        [/foreach]

        [sound]
            name={SOUND_LIST:HOLY}
        [/sound]
        [sound]
            name=lightning.ogg
        [/sound]

        [floating_text]
           x,y=$|x1,$|y1
           text=_"<span color='#ffff00'>fragments merged!</span>"
        [/floating_text]

        [delay]
            time=100
        [/delay]

        {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 1 $|x1 $|y1 (
            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
        )}
    [/then]
    [else]
        [floating_text]
           x,y=$|x1,$|y1
           text=_"$|tmp_current_side_fragments|/4 fragments"
        [/floating_text]
        [delay]
            time=100
        [/delay]
    [/else]
    )}

    {CLEAR_VARIABLE tmp_current_side_fragments,tmp_fragment_units,tmp_leftover_fragments}

    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON portal _"Portal" "scenery/whirlpool.png~BLEND(200,0,255,0.3)~NO_TOD_SHIFT()" _"Teleports you to a random location, avoiding the void" (

    [sound]
        name=magic-faeriefire.ogg
    [/sound]

#first try to teleport to desirable tiles, if that fails, teleport anywhere that isn't void or about to be consumed by void

    [store_locations]
        [not]
            terrain=X*^*,Ur^Efm#never teleports units to the void, or tiles about to be consumed by void
        [/not]
        #teleporting too close to the portal kinda defeats the purpose of it, after all
        [not]
            x,y=$|x1,$|y1
            radius=5
        [/not]
        [and]
            find_in=battle_royale_loot_tiles
            radius=3
        [/and]
        variable=battleroyale_portal_locs
    [/store_locations]

    {IF_VAR battleroyale_portal_locs.length greater_than 0 (
    [else]
    [store_locations]
        [not]
            terrain=X*^*,Ur^Efm#never teleports units to the void, or tiles about to be consumed by void
        [/not]
        variable=battleroyale_portal_locs
    [/store_locations]
    [/else]
    )}

    {VARIABLE tmp_portal_random_limit $|battleroyale_portal_locs.length}
    {VARIABLE_OP tmp_portal_random_limit sub 1}
    {RANDOM 0..$|tmp_portal_random_limit}

    {TELEPORT_UNIT x,y=$|x1,$|y1 $|battleroyale_portal_locs[$|random].x $|battleroyale_portal_locs[$|random].y}
    [redraw]
        clear_shroud=yes
    [/redraw]
    [scroll_to]
        side=$|side_number
        x,y=$|battleroyale_portal_locs[$|random].x,$|battleroyale_portal_locs[$|random].y
    [/scroll_to]
    {CLEAR_VARIABLE tmp_portal_random_limit}

    )}

    {BATTLE_ROYAL_ITEM_CASE_COMMON bonestack _"Bone Stack" "items/bonestack.png" _"Summoned a random lvl1 skeleton" (
        {VARIABLE_OP tmp_br_skeltype rand "Skeleton","Skeleton Archer"}
        [unit]
            type=$|tmp_br_skeltype
            side=$|side_number
            generate_name=yes
            random_traits=yes
            placement=map
            passable=yes
            x,y=$|x1,$|y1
        [/unit]
        {CLEAR_VARIABLE tmp_br_skeltype}
    )}

    #can't drop randomly. it's marked as rare despite being in the common itempool for the sake of being more convenient for potion chest's code. It's an easter egg item that can only drop from potion chests
    {BATTLE_ROYAL_ITEM_CASE_RARE potion_iris _"Iris Potion" "items/potion-blue.png~BLEND(200,0,255,0.3)" _"Potion brewed from iris flowers, swaps the unit's gender" (
    [if]
        [have_unit]
            x,y=$|x1,$|y1
            gender=female
        [/have_unit]
        [then]
            {MODIFY_UNIT x,y=$|x1,$|y1 gender male}
        [/then]
        [else]
            {MODIFY_UNIT x,y=$|x1,$|y1 gender female}
        [/else]
    [/if]
    )}

    [/switch]
[/event]
[event]
    id=battleroyale_spawn_item_rare
    first_time_only=no
    {IF_VAR battle_royale_force_specific_itemspawn not_equals yes (
    [then]
        #some options can prevent certain items from spawning
        {VARIABLE battleroyale_rarerand spectral_cloak,lootbox,berserker_axe,elven_bow,charger_amulet,vampire_amulet,potion_chest,armor_chest,druid_staff,trickster_ring}
        {IF_VAR battleroyale_item_mod_disablesummons equals yes (
        [else]
        {VARIABLE battleroyale_rarerand $battleroyale_rarerand|,mausoleum,temple}
        [/else]
        )}
        {VARIABLE_OP battle_royale_item_type rand $battleroyale_rarerand|}
    [/then]
    )}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_RARE spectral_cloak _"Spectral Cloak" "items/cloak-green.png~GS()~O(60%)" _"Wearing the spectral cloak gives you the following benefits: 
-nightstalk ability
-skirmisher ability
-1 more movement
-1 movement cost on flat/forest/sand/hills/mountains/frozen/cave terrain
Each cloak you take after the first one increases movement by 2 instead of 1" (
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_spectralcloaks add 1}
                [/modify_unit]

                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        formula="wml_vars.battleroyale_spectralcloaks = 1"
                    [/filter]

                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            flat=1
                            forest=1
                            sand=1
                            hills=1
                            mountains=1
                            frozen=1
                            cave=1
                        [/movement_costs]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_NIGHTSTALK}
                            {ABILITY_SKIRMISHER}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
#                    [effect]
#                        apply_to=image_mod
#                        add="~O(70%)"
#                    [/effect]
                [/object]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        formula="wml_vars.battleroyale_spectralcloaks > 1"
                    [/filter]
                    [effect]
                        apply_to=movement
                        increase=2
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE lootbox _"Lootbox" "items/box.png" _"The lootbox drops three random items next to is tile - they can be <span color='#6464ff'>Common</span>, <span color='#c800ff'>Rare</span>, or even <span color='#ffff00'>Legendary</span>!" (

                    {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 3 $|x1 $|y1 (
#                        [chat]
#                            message="$this_item.x|,$this_item.y|"
#                        [/chat]
#                        [chat]
#                            message="$|this_item.x|,$|this_item.y|"
#                        [/chat]
                        {VARIABLE_OP tmp_lootbox_type_rand rand 1..10}
                        {IF_VAR tmp_lootbox_type_rand equals 1 (
                        [then]
                            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                        [/then]
                        [elseif]
                            {VARIABLE_CONDITIONAL tmp_lootbox_type_rand less_than_equal_to 3}
                            [then]
                            {BATTLE_ROYALE_SPAWN_ITEM_RARE $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                            [/then]
                        [/elseif]
                        [else]
                            {BATTLE_ROYALE_SPAWN_ITEM_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                        [/else]
                        )}
                        {CLEAR_VARIABLE tmp_lootbox_type_rand}
                    )}

                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE berserker_axe _"Berserker Axe" "items/axe.png" _"A powerful axe used by dwarven berserkers, it allows the wielder to attack extremely quickly. Picking it up multiple times makes the weapon more powerful" (
                #if the wielder already had the weapon, give more damage/strikes, but without times per level, to make it less ridiculous
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [has_attack]
                            name=berserker axe
                        [/has_attack]
                    [/filter]

                    [effect]
                        apply_to=attack
                        name=berserker axe
                        increase_damage=1
                        increase_attacks=1
                    [/effect]
                [/object]

                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [not]
                            [has_attack]
                                name=berserker axe
                            [/has_attack]
                        [/not]
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=berserker axe
                        description= _"berserker axe"
                        type=blade
                        range=melee
                        [specials]
                            {WEAPON_SPECIAL_BERSERK}
                        [/specials]
                        icon=attacks/frenzy.png
                        damage=6
                        number=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=berserker axe
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=berserker axe
                            [/filter_attack]
                    
                            start_time=-200
                    
                            [frame]
                            duration=300
                            [/frame]
                    
                            {SOUND:HIT_AND_MISS axe.ogg {SOUND_LIST:MISS} -100}
                        [/attack_anim]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE mausoleum _"Mausoleum" "misc/blank-hex.png~BLIT(scenery/mausoleum01.png~CROP(36,30,80,80))" _"Summoned a Wraith" (
                    [sound]
                        name=wail.wav
                    [/sound]
                    [unit]
                        type=Wraith
                        generate_name=yes
                        random_traits=yes
                        placement=map
                        passable=yes
                        x,y=$|x1,$|y1
                        side=$|side_number
                    [/unit]
                )}

                {BATTLE_ROYAL_ITEM_CASE_RARE temple _"Temple" "scenery/temple1.png" _"A White Mage joins your team" (
                    [sound]
                        name={SOUND_LIST:HOLY}
                    [/sound]
                    [unit]
                        type=White Mage
                        generate_name=yes
                        random_traits=yes
                        random_gender=yes
                        placement=map
                        passable=yes
                        x,y=$|x1,$|y1
                        side=$|side_number
                    [/unit]
                )}

#                {BATTLE_ROYAL_ITEM_CASE_RARE 6 _"Iris Potion" "items/potion-blue.png~BLEND(200,0,255,0.3)" _"Potion brewed from iris flowers, swaps the #unit's gender" (
#                [if]
#                    [have_unit]
#                        x,y=$|x1,$|y1
#                        gender=female
#                    [/have_unit]
#                    [then]
#                        {MODIFY_UNIT x,y=$|x1,$|y1 gender male}
#                    [/then]
#                    [else]
#                        {MODIFY_UNIT x,y=$|x1,$|y1 gender female}
#                    [/else]
#                [/if]
#                )}

#WIP commented out for now (not sure how well the concept fits yet tho)

#                {BATTLE_ROYAL_ITEM_CASE_RARE 6 _"Dark Altar" "items/altar-evil.png" _"The altar teleports away somewhere..." (
#
#                [message]
#                    speaker=narrator
#                    caption=_"???"
#                    side_for=$|side_number
##                    image="portraits/undead/spectre.png~O(90%)~BLEND(0,0,0,0.8)"
#                    image="portraits/jinn.png"
#                    message=_"Mortal. I can offer you power... for a price."
#                    [option]
#                        image="attacks/blank-attack.png"
#                        description=_"Leave the altar"
#                        [command]
#                            [message]
#                                speaker=narrator
#                                caption=_"???"
#                                side_for=$|side_number
#                                image="portraits/undead/spectre.png~O(90%)~BLEND(0,0,0,0.8)"
#                                message=_"Not interested in my offer? Very well, I'll find someone else..."
#                            [/message]
#                        [/command]
#                    [/option]
#                    [option]
#                        image="attacks/baneblade.png"
#                        description=_"Spend <span color='#ff0000'>50%</span> of your current <span color='#ff0000'>max HP</span>"
#                        [command]
#                        [/command]
#                    [/option]
#                    [option]
#                        image="attacks/touch-undead.png"
#                        description=_"Transform into a Lich"
#                        [command]
#                            [message]
#                                speaker=narrator
#                                caption=_"???"
#                                side_for=$|side_number
#                                image="portraits/undead/spectre.png~O(90%)~BLEND(0,0,0,0.8)"
#                                message=_"Very well"
#                            [/message]
#                            {TRANSFORM_UNIT x,y=$|x1,$|y1 Lich}
#                        [/command]
#                    [/option]
#                [/message]
#
##first try to teleport to desirable tiles, if that fails, teleport anywhere that isn't void or about to be consumed by void
#
#                [store_locations]
#                    {BATTLE_ROYALE_ITEM_LOCATION_FILTER}
#                    #teleporting too close to the original position kinda defeats the purpose of it, after all
#                    [not]
#                        x,y=$|x1,$|y1
#                        radius=3
#                    [/not]
#                    #but unlike portal, the altar doesn't teleport too far away either
#                    [and]
#                        x,y=$|x1,$|y1
#                        radius=10
#                    [/and]
#                    variable=battleroyale_portal_locs
#                [/store_locations]
#            
#                {IF_VAR battleroyale_portal_locs.length greater_than 0 (
#                [else]
#                [store_locations]
#                    [not]
#                        terrain=X*^*,Ur^Efm#never teleports units to the void, or tiles about to be consumed by void
#                    [/not]
#                    variable=battleroyale_portal_locs
#                [/store_locations]
#                [/else]
#                )}
#            
#                {VARIABLE tmp_portal_random_limit $|battleroyale_portal_locs.length}
#                {VARIABLE_OP tmp_portal_random_limit sub 1}
#                {RANDOM 0..$|tmp_portal_random_limit}
#
#                {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 1 $|battleroyale_portal_locs[$|random].x $|battleroyale_portal_locs[$|random].y (
#
#                    {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_RARE $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y 6}
#
#                )}
#
#                {CLEAR_VARIABLE tmp_portal_random_limit}
#
#                )}

#                {BATTLE_ROYAL_ITEM_CASE_RARE 6 _"TODO" "items/book4.png" _"TODO" (
#                )}

                {BATTLE_ROYAL_ITEM_CASE_RARE elven_bow _"Elven Bow" "items/bow-elven.png" _"A powerful bow used by elven marksmen, it is capable of shooting quite accurately. Taking the weapon multiple times make it more powerful" (
                #if the wielder already had the weapon, give more damage/strikes, but without times per level, to make it less ridiculous
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [has_attack]
                            name=elven bow
                        [/has_attack]
                    [/filter]

                    [effect]
                        apply_to=attack
                        name=elven bow
                        increase_damage=1
                        increase_attacks=1
                    [/effect]
                [/object]

                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [not]
                            [has_attack]
                                name=elven bow
                            [/has_attack]
                        [/not]
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=elven bow
                        description= _"elven bow"
                        type=pierce
                        range=ranged
                        [specials]
                            {WEAPON_SPECIAL_MARKSMAN}
                        [/specials]
                        icon=attacks/bow-elven-magic.png
                        damage=6
                        number=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=elven bow
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=elven bow
                            [/filter_attack]
                            start_time=-250
                            missile_start_time=-150
                    
                            [missile_frame]
                                duration=150
                                image="projectiles/missile-n.png"
                                image_diagonal="projectiles/missile-ne.png"
                            [/missile_frame]
                    
                            [frame]
                                duration=300
                            [/frame]
                    
                            {SOUND:HIT_AND_MISS bow.ogg bow-miss.ogg -225}
                        [/attack_anim]
                    [/effect]
                [/object]
                )}

               {BATTLE_ROYAL_ITEM_CASE_RARE charger_amulet _"Charger Amulet" "items/ankh-necklace.png~GS()~BLEND(255,0,0,0.3)" _"All your attacks gain charge, including weapons picked up after taking this item, and you gain +5 max hp. Charger amulets after the first one give you +2 damage on all attacks instead of charge and +8 hp instead of +5." (

                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_chargeramulets add 1}
                [/modify_unit]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        formula="wml_vars.battleroyale_chargeramulets = 1"
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {WEAPON_SPECIAL_CHARGE}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=6
                        increase_total=6
                    [/effect]        
                [/object]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        formula="wml_vars.battleroyale_chargeramulets > 1"
                    [/filter]
                    [effect]
                        apply_to=attack
                        increase_damage=1
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=8
                        increase_total=8
                    [/effect]        
                [/object]
                )}

                {BATTLE_ROYAL_ITEM_CASE_RARE vampire_amulet _"Vampire Amulet" "items/necklace-bone.png" _"All your attacks gain drain, including weapons picked up after taking this item. Taking the item multiple times takes the drain 10% stronger per amulet." (
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_vampireamulets add 1}
                [/modify_unit]
            
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        formula="wml_vars.battleroyale_vampireamulets = 1"
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [drains]
                                id=battleroyale_vampire_amulet_drain
                                name= _ "vampire amulet drain"
                                description= _ "Same as the 'drains' weapon special. However, drains 10% more health per additional vampire amulet you have."
                                #drains takes values in literal percentage instead of multiplication
                                value="(40 + attacker.wml_vars.battleroyale_vampireamulets * 10)"
                                apply_to=self
                                active_on=offense
                            [/drains]
                            [drains]
                                id=battleroyale_vampire_amulet_drain2
                                value="(40 + defender.wml_vars.battleroyale_vampireamulets * 10)"
                                apply_to=self
                                active_on=defense
                            [/drains]
                        [/abilities]
                    [/effect]
                [/object]
                )}

                {BATTLE_ROYAL_ITEM_CASE_RARE potion_chest "Potion Chest" "items/chest-plain-closed.png" _"You find several potions in the chest. Has a small chance to drop a unique rare potion." (
                    {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 4 $|x1 $|y1 (
                        #small chance of getting Iris Potion, an easter egg item
                        {VARIABLE_OP tmp_potion_type rand potion_heal,potion_exp,potion_speed,potion_strength,potion_heal,potion_exp,potion_speed,potion_strength,potion_iris}
                        {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y $|tmp_potion_type}
                    )}
                    {CLEAR_VARIABLE tmp_potion_type}
                )}


                {BATTLE_ROYAL_ITEM_CASE_RARE armor_chest "Armor Chest" "items/chest-plain-closed.png~GS()" _"You find some armor in the chest" (

                    {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 3 $|x1 $|y1 (
                        {VARIABLE_OP tmp_itemrand_type rand armor_iron,armor_wardamulet}
                        {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y $|tmp_itemrand_type}
                    )}
                    {CLEAR_VARIABLE tmp_itemrand_type}
                )}

                {BATTLE_ROYAL_ITEM_CASE_RARE druid_staff _"Druid Staff" "items/staff-druid.png" _"Used by elven druids, this staff allows the wielder to slow foes, heal allies, and regenerate health each turn. Taking the weapon multiple times makes the ensnare attack slightly stronger, and increases healing/regeneration by 2" (
                [sound]
                    name=entangle.wav
                [/sound]
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_druidstaves add 1}
                [/modify_unit]
                #if the wielder already had the weapon, give more damage/strikes, but without times per level, to make it less ridiculous

                #TODO: maybe make staff-stacking also give more healing
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [has_attack]
                            name=druid staff ensnare
                        [/has_attack]
                    [/filter]

                    [effect]
                        apply_to=attack
                        name=druid staff ensnare
                        increase_damage=1
                        increase_attacks=1
                    [/effect]
                [/object]


                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [not]
                            [has_attack]
                                name=druid staff ensnare
                            [/has_attack]
                        [/not]
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                             [heals]
                                 value="(6 + self.wml_vars.battleroyale_druidstaves * 2)"
                                 id=healing
                                 affect_allies=yes
                                 name= _ "druid staff healing"
                                 female_name= _ "female^druid staff healing"
                                 description=  _ "Combination of heals + 8, unpoison and regeneration. Healing/regen is also increased by 2 for each druid staff you take after the first one"
                                 affect_self=yes
                                 poison=cured
                                 [affect_adjacent]
                                 [/affect_adjacent]
                             [/heals]

#                            {ABILITY_CURES}
#                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_attack
                        name=druid staff ensnare
                        description= _"ensnare"
                        type=impact
                        range=ranged
                        [specials]
                            {WEAPON_SPECIAL_SLOW}
                        [/specials]
                        icon=attacks/entangle.png
                        damage=2
                        number=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=druid staff ensnare
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=druid staff ensnare
                            [/filter_attack]
                            missile_start_time=-200
                            [missile_frame]
                                offset=1.0
                                duration=200
                                image="projectiles/entangle.png"
                                image_diagonal="projectiles/entangle.png"
                            [/missile_frame]
                            start_time=-300
                            [frame]
                                duration=600
                                halo="halo/elven/nature-halo[1~8].png"
                                halo_x,halo_y=0,-12
                            [/frame]
                            attack_sound_start_time=-75
                            [attack_sound_frame]
                                sound=entangle.wav
                            [/attack_sound_frame]
                        [/attack_anim]
                    [/effect]
                [/object]
                )}

                {BATTLE_ROYAL_ITEM_CASE_RARE trickster_ring _"Trickster Ring" "items/ring-silver.png" _"Wearing the trickster ring gives you the following benefits: 
-concealment ability
-You can move 1 tile after attacking per trickster ring you have
-all your attacks gain a weaker version of backstab (multiplied by 1.5 instead of 2, plus 0.15 per each additional ring you have)" (
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_tricksterrings add 1}
                [/modify_unit]
            
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        formula="wml_vars.battleroyale_tricksterrings = 1"
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=battleroyale_tricksterring
                                name= _ "trickster ring"
                                description= _ "After attacking, gain 1 MP per trickster ring you have."
                            [/dummy]
                            [damage]
                                id=battleroyale_trickster_backstap
                                name= _ "trickster backstab"
                                description= _ "Same as the 'backstab' weapon special. However, multiplies damage damage by 1.5 instead of 2, plus 0.15 per additional trickster ring you have."
                                multiply="(1.35 + attacker.wml_vars.battleroyale_tricksterrings * 0.15)"
                                active_on=offense
                                [filter_opponent]
                                    formula="
                                        enemy_of(self, flanker) and not flanker.petrified
                                    where
                                        flanker = unit_at(direction_from(loc, other.facing))
                                    "
                                [/filter_opponent]
                            [/damage]
                            {ABILITY_CONCEALMENT}
                        [/abilities]
                    [/effect]
                [/object]
                )}

            [/switch]
[/event]
[event]
    id=battleroyale_spawn_item_legendary
    first_time_only=no
    {IF_VAR battle_royale_force_specific_itemspawn not_equals yes (
    [then]
        #some options can prevent certain items from spawning
        {VARIABLE battleroyale_legendrand sceptre_of_fire,lightbringer,big_lootbox,phoenix_heart,all_seeing_eye,ring_of_fury,bottomless_backpack,eldritch_blade}
        {IF_VAR battleroyale_item_mod_disablesummons equals yes (
        [else]
        {VARIABLE battleroyale_legendrand $battleroyale_legendrand|,cloning_circle,necronomicon,dragon_statue}
        [/else]
        )}
        {VARIABLE_OP battle_royale_item_type rand $battleroyale_legendrand|}
    [/then]
    )}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY sceptre_of_fire _"Sceptre of Fire" "items/sceptre-of-fire.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(255,0,0,1):150" _"This ancient Sceptre was forged by the great Dwarves of the Heart Mountains. A symbol of the kingship of Wesnoth, the Sceptre has the power to shoot fireballs at enemies of the bearer! Taking the weapon multiple times makes it stronger" (
                [sound]
                    name=fire.wav
                [/sound]
                #if the wielder already had the weapon, give more damage/strikes, but without times per level, to make it less ridiculous
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [has_attack]
                            name=sceptre of fire
                        [/has_attack]
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=sceptre of fire
                        increase_damage=1
                        increase_attacks=1
                    [/effect]
                [/object]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [not]
                            [has_attack]
                                name=sceptre of fire
                            [/has_attack]
                        [/not]
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=sceptre of fire
                        description= _"sceptre of fire"
                        type=fire
                        range=ranged
                        [specials]
                            {WEAPON_SPECIAL_MAGICAL}
                        [/specials]
                        icon=attacks/fireball.png
                        damage=8
                        number=4
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=sceptre of fire
                        increase_damage=3
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=sceptre of fire
                            [/filter_attack]
                            {MISSILE_FRAME_FIREBALL_XY -16 -21}
                            start_time=-300
                            [frame]
                                sound=fire.wav
                                duration=200
                            [/frame]
                        [/attack_anim]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY cloning_circle _"Cloning Circle" "scenery/summoning-center.png~BLEND(0,255,0,0.5)" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(0,255,0,1):150" _"Summoned an identical copy of $|unit.name|" (
                [sound]
                    name=magic-faeriefire.ogg
                [/sound]
                [store_unit]
                   [filter]
                       id=$|unit.id
                   [/filter]
                   variable=tmp_cloned_unit
                   kill=no
                [/store_unit]
                [unstore_unit]
                   variable=tmp_cloned_unit
                   find_vacant=yes
                [/unstore_unit]
                {CLEAR_VARIABLE tmp_cloned_unit}
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY lightbringer _"Lightbringer" "items/sword-holy.png~NO_TOD_SHIFT()" "halo/illuminates-aura.png" _"The Lightbringer is an ancient paladin sword, capable of slicing through any unholy abominations with ease. Wielding this holy blade also grants the following passive benefits:
- illuminates ability
- alignment is set to lawful
- +30% arcane resistance
Taking the weapon multiple times makes it stronger, and applies the arcane resistance buff again." (
                [sound]
                    name={SOUND_LIST:HOLY}
                [/sound]
                #if the wielder already had the weapon, give more damage/strikes, but without times per level, to make it less ridiculous
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [has_attack]
                            name=lightbringer
                        [/has_attack]
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=lightbringer
                        increase_damage=1
                        increase_attacks=1
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            arcane=-30
                        [/resistance]
                    [/effect]
                    #just in case another item changed the alignment before
                    [effect]
                        apply_to=alignment
                        set=lawful
                    [/effect]
                [/object]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [not]
                            [has_attack]
                                name=lightbringer
                            [/has_attack]
                        [/not]
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=lightbringer
                        description=_"lightbringer"
                        icon=attacks/sword-holy.png
                        type=arcane
                        range=melee
                        [specials]
                            {WEAPON_SPECIAL_MAGICAL}
                        [/specials]
                        damage=8
                        number=3
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=lightbringer
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=lightbringer
                            [/filter_attack]
                        
                            start_time=-200
                        
                            [frame]
                            duration=300
                            sound={SOUND_LIST:HOLY_MISS}
                            [/frame]
                        
                            {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                        [/attack_anim]
                    [/effect]
                    [effect]
                        apply_to=alignment
                        set=lawful
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_ILLUMINATES}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=halo
                        halo="halo/illuminates-aura.png"
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            arcane=-30
                        [/resistance]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY necronomicon _"Necronomicon" "items/book5.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(0,0,0,1):150" _"When a living unit (either ally or enemy) dies in a 2-tile radius from this unit, they are revived as a soul thrall of the resurrecting unit's side. Soul thralls have -40% damage/max hitpoints/exp/max exp, their level is reduced by 1, and the alignment changes to chaotic.

Every necronomicon you take after the first one will summon a random lvl3 undead unit instead." (
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_necronomicons add 1}
                [/modify_unit]
                [sound]
                    name=magic-dark-big.ogg
                [/sound]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        formula="wml_vars.battleroyale_necronomicons = 1"
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=battle_royale_necronomicon
                                name=_"necronomicon"
                                description= _"When a living unit (either ally or enemy) dies in a 2-tile radius from this unit, they are revived as a soul thrall of the resurrecting unit's side. Soul thralls have -40% damage/max hitpoints/exp/max exp, their level is reduced by 1, and the alignment changes to chaotic. If a dying unit is the radius of both an ally and enemy unit with this ability, the ally takes priority."
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                [if]
                [have_unit]
                    x,y=$|x1,$|y1
                    formula="wml_vars.battleroyale_necronomicons > 1"
                [/have_unit]
                [then]
                    {VARIABLE_OP tmp_battleroyale_undeadtype rand "Lich,Draug,Banebow,Ghast,Spectre,Nightgaunt,Death Knight"}
                    [unit]
                        type=$|tmp_battleroyale_undeadtype
                        generate_name=yes
                        random_traits=yes
                        placement=map
                        passable=yes
                        x,y=$|x1,$|y1
                        side=$|side_number
                    [/unit]
                    {CLEAR_VARIABLE tmp_battleroyale_undeadtype}
                [/then]
                [/if]
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY big_lootbox _"Big Lootbox" "items/box.png~SCALE(108,108)~CROP(17,29,72,72)" () _"The lootbox drops five random items next to is tile - they can be <span color='#6464ff'>Common</span>, <span color='#c800ff'>Rare</span>, or even <span color='#ffff00'>Legendary</span>!" (

                    {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 5 $|x1 $|y1 (
#                        [chat]
#                            message="$this_item.x|,$this_item.y|"
#                        [/chat]
#                        [chat]
#                            message="$|this_item.x|,$|this_item.y|"
#                        [/chat]
                        {VARIABLE_OP tmp_lootbox_type_rand rand 1..10}
                        {IF_VAR tmp_lootbox_type_rand equals 1 (
                        [then]
                            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                        [/then]
                        [elseif]
                            {VARIABLE_CONDITIONAL tmp_lootbox_type_rand less_than_equal_to 3}
                            [then]
                            {BATTLE_ROYALE_SPAWN_ITEM_RARE $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                            [/then]
                        [/elseif]
                        [else]
                            {BATTLE_ROYALE_SPAWN_ITEM_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                        [/else]
                        )}
                        {CLEAR_VARIABLE tmp_lootbox_type_rand}
                    )}

                )}

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY phoenix_heart _"Phoenix's Heart" "items/ball-magenta.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(255,0,0,1):150" _"On death, you revive once with full hitpoints (but if you pick up multiple phoenix hearts you can revive multiple times). +20% fire resistance. Does NOT protect from dying to the void." (
                [sound]
                    name=fire.wav
                [/sound]
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_phoenixrevives add 1}
                [/modify_unit]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            fire=-20
                        [/resistance]
                    [/effect]
                [/object]
                )}

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY all_seeing_eye _"All-seeing Eye" "items/ball-blue.png" "halo/misc/leadership-flare-[1~13].png:50" _"All your attacks gain 30% chance to hit (including weapons picked up after this item), and your vision range is massively increased. Picking up multiple eyes stacks the chance to hit bonus, and each eye after the first one grants 32 exp." (
                [sound]
                    name=magic-faeriefire-miss.ogg
                [/sound]
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_all_seeing_eyes add 1}
                [/modify_unit]
                [modify_unit]
                    [filter]
                        id=$|unit.id
                        formula="wml_vars.battleroyale_all_seeing_eyes > 1"
                    [/filter]
                    experience="$|($|unit.experience + 32)"
                [/modify_unit]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=vision
                        set=99
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [chance_to_hit]
                                id=battle_royale_all_seeing_eye
                                name=_"all seeing eye"
                                description=_"All attacks gain 30% more chance to hit per All-seeing Eye you have."
                                add="(30 * attacker.wml_vars.battleroyale_all_seeing_eyes)"
                                apply_to=self
                                active_on=offense
                            [/chance_to_hit]
                            [chance_to_hit]
                                id=battle_royale_all_seeing_eye2
                                add="(30 * defender.wml_vars.battleroyale_all_seeing_eyes)"
                                apply_to=self
                                active_on=defense
                            [/chance_to_hit]
                        [/abilities]
                    [/effect]
                [/object]
                [redraw]
                    clear_shroud=yes
                [/redraw]
                )}

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY ring_of_fury _"Ring of Fury" "items/ring-red.png" "halo/misc/leadership-flare-[1~13].png~BLEND(255,0,0,1):50" _"You can attack 1 more time per turn (including different targets). Your moves and attacks are restored for this turn." (
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=max_attacks
                        increase=1
                    [/effect]
                [/object]
                [heal_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    restore_attacks=yes
                    restore_statuses=no
                    moves=full
                    amount=0
                [/heal_unit]
                )}

                #TODO: maybe replace halo with something more unique

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY dragon_statue _"Dragon Statue" "items/dragonstatue.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(255,0,0,1):150" _"Spawns an allied Drake Flameheart"(
                    [sound]
                        name={SOUND_LIST:DRAKE_HIT}
                    [/sound]
                    [unit]
                        type=Drake Flameheart
                        generate_name=yes
                        random_traits=yes
                        placement=map
                        passable=yes
                        x,y=$|x1,$|y1
                        side=$|side_number
                    [/unit]
                )}

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY bottomless_backpack _"Bottomless Backpack" "items/leather-pack.png" "halo/elven/shyde-stationary-halo[1~6].png:150" _"Once every 2 turns, spawn a random <span color='#6464ff'>Common</span> item next to you, with a chance to spawn a <span color='#c800ff'>Rare</span> item instead. If you take multiple backpacks, you get multiple items at once." (
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_bottomless_backpacks add 1}
                    {VARIABLE_OP battleroyale_bottomless_backpack_timer add 2}#to ensure an item spawns immediately on next turn after taking the backpack
                [/modify_unit]
                )}

                #another legendary sword. lower stats than lightbringer, but very powerful abilities to compensate. main goal is to make it easier to kill strong players, especially ones that have a lot of resistance buffs

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY eldritch_blade _"Eldritch Blade" "items/sword-wraith.png~NO_TOD_SHIFT()" "halo/darkens-aura.png~SCALE(144,144)" _"This strange sword seems to defy known laws of this universe.
-ignores enemy resistances
-the enemy cannot retaliate
Taking the weapon multiple times makes it stronger." (
                [sound]
                    name=magic-dark-big.ogg
                [/sound]
                #if the wielder already had the weapon, give more damage/strikes, but without times per level, to make it less ridiculous
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [has_attack]
                            name=eldritch_blade
                        [/has_attack]
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=eldritch_blade
                        increase_damage=1
                        increase_attacks=1
                    [/effect]
                [/object]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                        [not]
                            [has_attack]
                                name=eldritch_blade
                            [/has_attack]
                        [/not]
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=eldritch_blade
                        description=_"eldritch blade"
                        icon=attacks/baneblade.png
                        type=eldritch
                        range=melee
                        [specials]
                            {WEAPON_SPECIAL_MAGICAL}
                            [disable]
                                id=battle_royale_nocounter
                                name=_"no-counter"
                                description=_"When used offensively, this attack makes the opponent unable to retaliate."
                                active_on=offense
                                apply_to=opponent
                            [/disable]
                        [/specials]
                        #weakest legendary in terms of base stats, but compensates for that with its abilities
                        damage=6
                        number=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=eldritch_blade
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=eldritch_blade
                            [/filter_attack]
                        
                            start_time=-200
                        
                            [frame]
                            duration=300
                            sound=magic-dark-big.ogg
                            [/frame]
                        
                            {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                        [/attack_anim]
                    [/effect]
                [/object]
                )}


            [/switch]
[/event]
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_COMMON NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| common items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            {BATTLE_ROYALE_ITEM_LOCATION_FILTER}
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_COMMON $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_RARE NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| rare items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            {BATTLE_ROYALE_ITEM_LOCATION_FILTER}
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_RARE $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| legendary items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            {BATTLE_ROYALE_ITEM_LOCATION_FILTER}
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef


#define BATTLE_ROYALE_SHRINK_MAP TURN_WARN TURN RADIUS
[event]
    name=turn {TURN_WARN}
    delayed_variable_substitution=no
    [terrain]
        [not]
            x,y=$($map_size.width|/2),$($map_size.height|/2)
            radius={RADIUS}
        [/not]
        [not]
            terrain=Xv
        [/not]
        terrain=Ur^Efm
        layer=both
    [/terrain]
    [sound]
        name=rumble.ogg
    [/sound]
[/event]
[event]
    name=turn {TURN}
    delayed_variable_substitution=no
    [terrain]
        [not]
            x,y=$($map_size.width|/2),$($map_size.height|/2)
            radius={RADIUS}
        [/not]
        terrain=Xv
        layer=both
    [/terrain]
    [sound]
        name=magic-dark-big.ogg
    [/sound]

#clear all items on void

#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$|battle_royale_loot_tiles.length
    [/variable]
    [do]
#        [chat]
#            message="while loop"
#        [/chat]
#        [chat]
#            message="$|battle_royale_loot_tiles[$|c].x|,$|battle_royale_loot_tiles[$|c].y|"
#        [/chat]
        [if]
        [have_location]
            x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            terrain=Xv
        [/have_location]
        [then]
            [remove_item]
                x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            [/remove_item]
            [label]
                text=""
                x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            [/label]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$|c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        [/if]
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}
    [kill]
        [filter_location]
            terrain=Xv
        [/filter_location]
        animate=yes
        fire_event=yes
    [/kill]
[/event]
#enddef

#new, much more convenient to edit macro:

#define BATTLE_ROYALE_SHRINK_MAP_NEW TURN_WARN TURN RADIUS_VAR PERCENTVAR PERCENTAGE_TO_ADD
[event]
    name=turn {TURN_WARN}
    delayed_variable_substitution=no
    {VARIABLE_OP {PERCENTVAR} add {PERCENTAGE_TO_ADD}}
    [terrain]
        [not]
            x,y=$($map_size.width|/2),$($map_size.height|/2)
            radius="$((${RADIUS_VAR} * ${PERCENTVAR}) / 100)"
        [/not]
        [not]
            terrain=Xv
        [/not]
        terrain=Ur^Efm
        layer=both
    [/terrain]
    [sound]
        name=rumble.ogg
    [/sound]
[/event]
[event]
    name=turn {TURN}
    delayed_variable_substitution=no
    [terrain]
        [not]
            x,y=$($map_size.width|/2),$($map_size.height|/2)
            radius="$((${RADIUS_VAR} * ${PERCENTVAR}) / 100)"
        [/not]
        terrain=Xv
        layer=both
    [/terrain]
    [sound]
        name=magic-dark-big.ogg
    [/sound]

#clear all items on void

#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$|battle_royale_loot_tiles.length
    [/variable]
    [do]
#        [chat]
#            message="while loop"
#        [/chat]
#        [chat]
#            message="$|battle_royale_loot_tiles[$|c].x|,$|battle_royale_loot_tiles[$|c].y|"
#        [/chat]
        [if]
        [have_location]
            x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            terrain=Xv
        [/have_location]
        [then]
            [remove_item]
                x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            [/remove_item]
            [label]
                text=""
                x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            [/label]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$|c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        [/if]
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}
    [kill]
        [filter_location]
            terrain=Xv
        [/filter_location]
        animate=yes
        fire_event=yes
    [/kill]
[/event]
#enddef

#define BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC
[event]
    name=start
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
    [then]

    {VARIABLE max_radius "$(($map_size.width| + $map_size.height|) / 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 2 "$($max_radius)"}
#    {BATTLE_ROYALE_SHRINK_MAP 3 "$($max_radius - 2)"}
#    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius - 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 5 "$($max_radius - 6)"}
    [event]
        name=turn 2
        [chat]
            speaker="Battle Royale"
            message="WARNING: the map will start shrinking every two turns at turn 4, stay away from the edge of the map or you'll get killed!"
        [/chat]        
    [/event]

    {BATTLE_ROYALE_SHRINK_MAP 3 4 "$($max_radius)"}
    {BATTLE_ROYALE_SHRINK_MAP 5 6 "$($max_radius * 0.9)"}
    {BATTLE_ROYALE_SHRINK_MAP 7 8 "$($max_radius * 0.8)"}
    {BATTLE_ROYALE_SHRINK_MAP 9 10 "$($max_radius * 0.7)"}
    {BATTLE_ROYALE_SHRINK_MAP 11 12 "$($max_radius * 0.6)"}
    {BATTLE_ROYALE_SHRINK_MAP 13 14 "$($max_radius * 0.5)"}
    {BATTLE_ROYALE_SHRINK_MAP 15 16 "$($max_radius * 0.4)"}
    {BATTLE_ROYALE_SHRINK_MAP 17 18 "$($max_radius * 0.3)"}
    [/then]
    [/if]
[/event]
#enddef

#define BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC_MORE_FORGIVING
[event]
    name=start
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
    [then]

    {VARIABLE max_radius "$(($map_size.width| + $map_size.height|) / 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 2 "$($max_radius)"}
#    {BATTLE_ROYALE_SHRINK_MAP 3 "$($max_radius - 2)"}
#    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius - 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 5 "$($max_radius - 6)"}
    [event]
        name=turn 2
        [chat]
            speaker="Battle Royale"
            message="WARNING: the map will start shrinking every two turns at turn 4, stay away from the edge of the map or you'll get killed!"
        [/chat]        
    [/event]

    {BATTLE_ROYALE_SHRINK_MAP 3 4 "$($max_radius * 1.15)"}
    {BATTLE_ROYALE_SHRINK_MAP 5 6 "$($max_radius)"}
    {BATTLE_ROYALE_SHRINK_MAP 7 8 "$($max_radius * 0.9)"}
    {BATTLE_ROYALE_SHRINK_MAP 9 10 "$($max_radius * 0.8)"}
    {BATTLE_ROYALE_SHRINK_MAP 11 12 "$($max_radius * 0.7)"}
    {BATTLE_ROYALE_SHRINK_MAP 13 14 "$($max_radius * 0.6)"}
    {BATTLE_ROYALE_SHRINK_MAP 15 16 "$($max_radius * 0.5)"}
    {BATTLE_ROYALE_SHRINK_MAP 17 18 "$($max_radius * 0.4)"}
    {BATTLE_ROYALE_SHRINK_MAP 19 20 "$($max_radius * 0.3)"}
    [/then]
    [/if]
[/event]
#enddef

#intended for colossal maze (and probably other really big maps), map takes twice as long to shrink, but also has slightly lower minimum radius

#define BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC_COLOSSAL
[event]
    name=start
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
    [then]

    {VARIABLE max_radius "$(($map_size.width| + $map_size.height|) / 4)"}
    {VARIABLE max_initial_percent 120}
#    {BATTLE_ROYALE_SHRINK_MAP 2 "$($max_radius)"}
#    {BATTLE_ROYALE_SHRINK_MAP 3 "$($max_radius - 2)"}
#    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius - 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 5 "$($max_radius - 6)"}
    [event]
        name=turn 2
        [chat]
            speaker="Battle Royale"
            message="WARNING: the map will start shrinking every two turns at turn 4, stay away from the edge of the map or you'll get killed!"
        [/chat]        
    [/event]

    #new experimental macro, since it's easier to adjust exact changes than normally

    {BATTLE_ROYALE_SHRINK_MAP_NEW 3 4 max_radius max_initial_percent 0}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 5 6 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 7 8 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 9 10 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 11 12 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 13 14 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 15 16 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 17 18 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 19 20 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 21 22 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 23 24 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 25 26 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 27 28 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 29 30 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 31 32 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 33 34 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 35 36 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 37 38 max_radius max_initial_percent -5}
    {BATTLE_ROYALE_SHRINK_MAP_NEW 39 40 max_radius max_initial_percent -5}




#    {BATTLE_ROYALE_SHRINK_MAP 3 4 "$($max_radius * 1.2)"}
#    {BATTLE_ROYALE_SHRINK_MAP 5 6 "$($max_radius * 1.15)"}
#    {BATTLE_ROYALE_SHRINK_MAP 7 8 "$($max_radius * 1.1)"}
#    {BATTLE_ROYALE_SHRINK_MAP 9 10 "$($max_radius * 1.05)"}
#    {BATTLE_ROYALE_SHRINK_MAP 9 10 "$($max_radius * 1.05)"}
#
#
#    {BATTLE_ROYALE_SHRINK_MAP 9 10 "$($max_radius * 0.95)"}
#    {BATTLE_ROYALE_SHRINK_MAP 11 12 "$($max_radius * 0.9)"}
#    {BATTLE_ROYALE_SHRINK_MAP 13 14 "$($max_radius * 0.85)"}
#    {BATTLE_ROYALE_SHRINK_MAP 15 16 "$($max_radius * 0.8)"}
#    {BATTLE_ROYALE_SHRINK_MAP 17 18 "$($max_radius * 0.75)"}
#    {BATTLE_ROYALE_SHRINK_MAP 19 20 "$($max_radius * 0.7)"}
#    {BATTLE_ROYALE_SHRINK_MAP 21 22 "$($max_radius * 0.65)"}
#    {BATTLE_ROYALE_SHRINK_MAP 23 24 "$($max_radius * 0.6)"}
#    {BATTLE_ROYALE_SHRINK_MAP 25 26 "$($max_radius * 0.55)"}
#    {BATTLE_ROYALE_SHRINK_MAP 27 28 "$($max_radius * 0.5)"}
#    {BATTLE_ROYALE_SHRINK_MAP 29 30 "$($max_radius * 0.45)"}
#    {BATTLE_ROYALE_SHRINK_MAP 31 32 "$($max_radius * 0.4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 33 34 "$($max_radius * 0.35)"}
#    {BATTLE_ROYALE_SHRINK_MAP 35 36 "$($max_radius * 0.3)"}
#    {BATTLE_ROYALE_SHRINK_MAP 37 38 "$($max_radius * 0.25)"}
#    {BATTLE_ROYALE_SHRINK_MAP 39 40 "$($max_radius * 0.2)"}
    [/then]
    [/if]
[/event]
#enddef

#define BATTLE_ROYALE_SPAWNENEMEIES TURN NUMBER TYPE
    [event]
       name=side turn {TURN}
       [filter_condition]
            {VARIABLE_CONDITIONAL side_number equals $battle_royale_enemyside}
       [/filter_condition]
        {SCATTER_UNITS {NUMBER} {TYPE} 2 (

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                terrain=Ur^Efm,_off^_usr,Q*,W*,*^X*,X*,*^V*,Ce*,Ch,Ch*,Cv*,Co*,Cu*,Ct*#,K*
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=$battle_royale_enemyside
            generate_name=yes
            random_traits=yes
            placement=map
            passable=yes
        )}
    [/event]
#enddef

#define BATTLE_ROYALE_SIDES
    [side]
        side=1
        team_name=1
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name=_""
        canrecruit=yes
#        controller={BATTLE_ROYALE_CONTROLLER}
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_""
        canrecruit=yes
#        controller={BATTLE_ROYALE_CONTROLLER}
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=9
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
        hidden=yes
        no_leader=yes
        color=teal

        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYLAE_BOT_SIDE NUM
    [side]
        side={NUM}
        team_name={NUM}
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
        controller=ai
        controller_lock=yes
#scrapped
#        color=battle_royale_yellow
        color=black
        x,y=1,1
        placement=map
        passable=yes
    [/side]
#enddef

#define BATTLE_ROYALE_SIDES_20
    [side]
        side=1
        team_name=1
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    #bot-locked sides:
    {BATTLE_ROYLAE_BOT_SIDE 9}
    {BATTLE_ROYLAE_BOT_SIDE 10}
    {BATTLE_ROYLAE_BOT_SIDE 11}
    {BATTLE_ROYLAE_BOT_SIDE 12}
    {BATTLE_ROYLAE_BOT_SIDE 13}
    {BATTLE_ROYLAE_BOT_SIDE 14}
    {BATTLE_ROYLAE_BOT_SIDE 15}
    {BATTLE_ROYLAE_BOT_SIDE 16}
    {BATTLE_ROYLAE_BOT_SIDE 17}
    {BATTLE_ROYLAE_BOT_SIDE 18}
    {BATTLE_ROYLAE_BOT_SIDE 19}
    [side]
        side=20
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
        hidden=yes
        no_leader=yes
        color=teal
        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYALE_SIDES_40
    [side]
        side=1
        team_name=1
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    #bot-locked sides:
    {BATTLE_ROYLAE_BOT_SIDE 9}
    {BATTLE_ROYLAE_BOT_SIDE 10}
    {BATTLE_ROYLAE_BOT_SIDE 11}
    {BATTLE_ROYLAE_BOT_SIDE 12}
    {BATTLE_ROYLAE_BOT_SIDE 13}
    {BATTLE_ROYLAE_BOT_SIDE 14}
    {BATTLE_ROYLAE_BOT_SIDE 15}
    {BATTLE_ROYLAE_BOT_SIDE 16}
    {BATTLE_ROYLAE_BOT_SIDE 17}
    {BATTLE_ROYLAE_BOT_SIDE 18}
    {BATTLE_ROYLAE_BOT_SIDE 19}
    {BATTLE_ROYLAE_BOT_SIDE 20}
    {BATTLE_ROYLAE_BOT_SIDE 21}
    {BATTLE_ROYLAE_BOT_SIDE 22}
    {BATTLE_ROYLAE_BOT_SIDE 23}
    {BATTLE_ROYLAE_BOT_SIDE 24}
    {BATTLE_ROYLAE_BOT_SIDE 25}
    {BATTLE_ROYLAE_BOT_SIDE 26}
    {BATTLE_ROYLAE_BOT_SIDE 27}
    {BATTLE_ROYLAE_BOT_SIDE 28}
    {BATTLE_ROYLAE_BOT_SIDE 29}
    {BATTLE_ROYLAE_BOT_SIDE 30}
    {BATTLE_ROYLAE_BOT_SIDE 31}
    {BATTLE_ROYLAE_BOT_SIDE 32}
    {BATTLE_ROYLAE_BOT_SIDE 33}
    {BATTLE_ROYLAE_BOT_SIDE 34}
    {BATTLE_ROYLAE_BOT_SIDE 35}
    {BATTLE_ROYLAE_BOT_SIDE 36}
    {BATTLE_ROYLAE_BOT_SIDE 37}
    {BATTLE_ROYLAE_BOT_SIDE 38}
    {BATTLE_ROYLAE_BOT_SIDE 39}
    [side]
        side=40
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
#        hidden=yes
        no_leader=yes
        color=teal
        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYALE_SIDES_100
    [side]
        side=1
        team_name=1
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    #bot-locked sides:
    {BATTLE_ROYLAE_BOT_SIDE 9}
    {BATTLE_ROYLAE_BOT_SIDE 10}
    {BATTLE_ROYLAE_BOT_SIDE 11}
    {BATTLE_ROYLAE_BOT_SIDE 12}
    {BATTLE_ROYLAE_BOT_SIDE 13}
    {BATTLE_ROYLAE_BOT_SIDE 14}
    {BATTLE_ROYLAE_BOT_SIDE 15}
    {BATTLE_ROYLAE_BOT_SIDE 16}
    {BATTLE_ROYLAE_BOT_SIDE 17}
    {BATTLE_ROYLAE_BOT_SIDE 18}
    {BATTLE_ROYLAE_BOT_SIDE 19}
    {BATTLE_ROYLAE_BOT_SIDE 20}
    {BATTLE_ROYLAE_BOT_SIDE 21}
    {BATTLE_ROYLAE_BOT_SIDE 22}
    {BATTLE_ROYLAE_BOT_SIDE 23}
    {BATTLE_ROYLAE_BOT_SIDE 24}
    {BATTLE_ROYLAE_BOT_SIDE 25}
    {BATTLE_ROYLAE_BOT_SIDE 26}
    {BATTLE_ROYLAE_BOT_SIDE 27}
    {BATTLE_ROYLAE_BOT_SIDE 28}
    {BATTLE_ROYLAE_BOT_SIDE 29}
    {BATTLE_ROYLAE_BOT_SIDE 30}
    {BATTLE_ROYLAE_BOT_SIDE 31}
    {BATTLE_ROYLAE_BOT_SIDE 32}
    {BATTLE_ROYLAE_BOT_SIDE 33}
    {BATTLE_ROYLAE_BOT_SIDE 34}
    {BATTLE_ROYLAE_BOT_SIDE 35}
    {BATTLE_ROYLAE_BOT_SIDE 36}
    {BATTLE_ROYLAE_BOT_SIDE 37}
    {BATTLE_ROYLAE_BOT_SIDE 38}
    {BATTLE_ROYLAE_BOT_SIDE 39}
    {BATTLE_ROYLAE_BOT_SIDE 40}
    {BATTLE_ROYLAE_BOT_SIDE 41}
    {BATTLE_ROYLAE_BOT_SIDE 42}
    {BATTLE_ROYLAE_BOT_SIDE 43}
    {BATTLE_ROYLAE_BOT_SIDE 44}
    {BATTLE_ROYLAE_BOT_SIDE 45}
    {BATTLE_ROYLAE_BOT_SIDE 46}
    {BATTLE_ROYLAE_BOT_SIDE 47}
    {BATTLE_ROYLAE_BOT_SIDE 48}
    {BATTLE_ROYLAE_BOT_SIDE 49}
    {BATTLE_ROYLAE_BOT_SIDE 50}
    {BATTLE_ROYLAE_BOT_SIDE 51}
    {BATTLE_ROYLAE_BOT_SIDE 52}
    {BATTLE_ROYLAE_BOT_SIDE 53}
    {BATTLE_ROYLAE_BOT_SIDE 54}
    {BATTLE_ROYLAE_BOT_SIDE 55}
    {BATTLE_ROYLAE_BOT_SIDE 56}
    {BATTLE_ROYLAE_BOT_SIDE 57}
    {BATTLE_ROYLAE_BOT_SIDE 58}
    {BATTLE_ROYLAE_BOT_SIDE 59}
    {BATTLE_ROYLAE_BOT_SIDE 60}
    {BATTLE_ROYLAE_BOT_SIDE 61}
    {BATTLE_ROYLAE_BOT_SIDE 62}
    {BATTLE_ROYLAE_BOT_SIDE 63}
    {BATTLE_ROYLAE_BOT_SIDE 64}
    {BATTLE_ROYLAE_BOT_SIDE 65}
    {BATTLE_ROYLAE_BOT_SIDE 66}
    {BATTLE_ROYLAE_BOT_SIDE 67}
    {BATTLE_ROYLAE_BOT_SIDE 68}
    {BATTLE_ROYLAE_BOT_SIDE 69}
    {BATTLE_ROYLAE_BOT_SIDE 70}
    {BATTLE_ROYLAE_BOT_SIDE 71}
    {BATTLE_ROYLAE_BOT_SIDE 72}
    {BATTLE_ROYLAE_BOT_SIDE 73}
    {BATTLE_ROYLAE_BOT_SIDE 74}
    {BATTLE_ROYLAE_BOT_SIDE 75}
    {BATTLE_ROYLAE_BOT_SIDE 76}
    {BATTLE_ROYLAE_BOT_SIDE 77}
    {BATTLE_ROYLAE_BOT_SIDE 78}
    {BATTLE_ROYLAE_BOT_SIDE 79}
    {BATTLE_ROYLAE_BOT_SIDE 80}
    {BATTLE_ROYLAE_BOT_SIDE 81}
    {BATTLE_ROYLAE_BOT_SIDE 82}
    {BATTLE_ROYLAE_BOT_SIDE 83}
    {BATTLE_ROYLAE_BOT_SIDE 84}
    {BATTLE_ROYLAE_BOT_SIDE 85}
    {BATTLE_ROYLAE_BOT_SIDE 86}
    {BATTLE_ROYLAE_BOT_SIDE 87}
    {BATTLE_ROYLAE_BOT_SIDE 88}
    {BATTLE_ROYLAE_BOT_SIDE 89}
    {BATTLE_ROYLAE_BOT_SIDE 90}
    {BATTLE_ROYLAE_BOT_SIDE 91}
    {BATTLE_ROYLAE_BOT_SIDE 92}
    {BATTLE_ROYLAE_BOT_SIDE 93}
    {BATTLE_ROYLAE_BOT_SIDE 94}
    {BATTLE_ROYLAE_BOT_SIDE 95}
    {BATTLE_ROYLAE_BOT_SIDE 96}
    {BATTLE_ROYLAE_BOT_SIDE 97}
    {BATTLE_ROYLAE_BOT_SIDE 98}
    {BATTLE_ROYLAE_BOT_SIDE 99}
    [side]
        side=100
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
#        hidden=yes
        no_leader=yes
        color=teal
        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYALE_EVENTS ENEMYSIDE
    [event]
        name=start
        [objectives]
            [objective]
                description= _ "Eliminate all other leaders"
#                show_turn_counter=yes
                condition=win
            [/objective]
            [objective]
                description= _ "Death of your leader"
                condition=lose
            [/objective]
            [note]
                description=_"There are various items scattered across the map, which provides powerful buffs when stepped on. Additionally, killed side $battle_royale_enemyside| enemies drop an item (stronger enemies drop rarer loot, level 0 enemies drop nothing. However, there is a 1 in 5 chance for enemies to drop loot from one level higher than their own)"
                [show_if]
                    {VARIABLE_CONDITIONAL battleroyale_noloot not_equals yes}
                [/show_if]
            [/note]
            [note]
                description=_"Items have three different rarities shown by their color - <span color='#6464ff'>Common</span>, <span color='#c800ff'>Rare</span> and <span color='#ffff00'>Legendary</span>"
                [show_if]
                    {VARIABLE_CONDITIONAL battleroyale_noloot not_equals yes}
                [/show_if]
            [/note]
            [note]
                description=_"Starting at turn 4, the map will shrink every two turns. The map shrinks in a hexagonal shape, so corners are erased first."
                [show_if]
                    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
                [/show_if]
            [/note]
            [note]
                description=_"Dead leaders eventually turn into side $battle_royale_enemyside| ghosts"
                [show_if]
                    {VARIABLE_CONDITIONAL battleroyale_noghost not_equals yes}
                [/show_if]
            [/note]
            delayed_variable_substitution=yes
        [/objectives]
    [/event]
    [event]
       name=prestart
        [store_unit]
                [filter]
                canrecruit=yes
                [/filter]
                variable=contestants
                kill=no
        [/store_unit]
        [store_map_dimensions]
        [/store_map_dimensions]
        {VARIABLE battle_royale_enemyside {ENEMYSIDE}}
        {FOREACH contestants i}

        {VARIABLE_OP teleportx rand 1..$map_size.width}
        {VARIABLE_OP teleporty rand 1..$map_size.height}
        {TELEPORT_UNIT id=$contestants[$i].id $teleportx $teleporty}
        {NEXT i}
        {CLEAR_VARIABLE contestants}
        {CLEAR_VARIABLE teleportx}
        {CLEAR_VARIABLE teleporty}
        [store_map_dimensions]
        [/store_map_dimensions]
        {VARIABLE tmp_ai_index 1}
        {VARIABLE tmp_br_ran_out_of_sides no}
        [while]
            {VARIABLE_CONDITIONAL tmp_br_ran_out_of_sides equals no}
#            [and]
#                {VARIABLE_CONDITIONAL tmp_ai_index less_than_equal_to $battle_royale_enemyside}
#            [/and]
            [do]
                [store_side]
                    side=$tmp_ai_index
                    variable=tmp_br_aiside
                [/store_side]
                [if]
                {VARIABLE_CONDITIONAL tmp_br_aiside.side greater_than 0}
                [then]
                {BATTLE_ROYALE_MICROAI $tmp_ai_index $battle_royale_enemyside}
                {BATTLE_ROYALE_MICROAI_ITEMS $tmp_ai_index $battle_royale_enemyside}
                [/then]
                [else]
                    {VARIABLE tmp_br_ran_out_of_sides yes}
                [/else]
                [/if]
                {VARIABLE_OP tmp_ai_index add 1}
                {CLEAR_VARIABLE tmp_br_aiside}
            [/do]
        [/while]
        {CLEAR_VARIABLE tmp_ai_index}
        {CLEAR_VARIABLE tmp_br_ran_out_of_sides}
        [micro_ai]
            side=$battle_royale_enemyside
#            ai_type=hang_out
            ai_type=goto
            action=add
            id=battleroyale_movetocenter_when_near_void_enemy
            [filter]
##commented out, so that spawned allies also flee from void
##                canrecruit=yes
#            [filter_location]
#            [not]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=5
#            [/not]
#            [and]
#                terrain=Xv
#                radius=4
#            [/and]
#            [/filter_location]
            [filter_location]
                terrain=Ur^Efm
            [/filter_location]
            [/filter]
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=2
            [/filter_location]
            ca_score=195000#very high CA score, as fleeing from the void is more important than combat/items
            unique_goals=no
            remove_movement=no
        [/micro_ai]

#        {BATTLE_ROYALE_MICROAI 1 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 2 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 3 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 4 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 5 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 6 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 7 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 8 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 9 {ENEMYSIDE}}
    [/event]
    [event]
        name=start
        id=battleroyale_leader_quick_buff
        #gives leaders with less than 6 moves (except units with 0 moves just in case to avoid breaking other add-ons) the quick trait to make them more viable:

        [modify_unit]
            [filter]
                canrecruit=yes
                formula="max_moves < 6"
            [/filter]
            {TRAIT_QUICK}
        [/modify_unit]
        #hacky workaround in case the side 1 gains the extra move
        [heal_unit]
            [filter]
                canrecruit=yes
                formula="moves < max_moves"
            [/filter]
            moves=full
            animate=no
        [/heal_unit]
    [/event]
    [event]
       name=die
       id=battleroyale_fogclear_event
       first_time_only=no
       [if]
       [have_unit]
            side=$unit.side
            [not]
                [filter_location]
                    terrain=Xv
                [/filter_location]
            [/not]
       [/have_unit]
       [else]
       [modify_side]
            side=$unit.side
            fog=no
       [/modify_side]
       [redraw]
           clear_shroud=yes
       [/redraw]
       [/else]
       [/if]
    [/event]
    [event]
        name=die
        id=battleroyale_elimination_event
        first_time_only=no
        [filter]
          canrecruit=yes
        [/filter]
        #TODO: maybe only show the elimination message once all leaders are dead
        [if]
        [have_unit]
         id=$second_unit.id
         canrecruit=yes
        [not]
         side=$battle_royale_enemyside
        [/not]
        [/have_unit]
        [and]
        [not]
        [have_unit]
         id=$unit.id
         terrain=Xv
        [/have_unit]        
        [/not]
        [/and]
        [then]
        [chat]
        speaker="Battle Royale"
        message="$second_unit.name| eliminated $unit.name|"
        [/chat]
        [/then]
        [elseif]
        [have_unit]
            id=$second_unit.id
            canrecruit=no
        [/have_unit]
        [and]
        [not]
        [have_unit]
         id=$unit.id
         terrain=Xv
        [/have_unit]        
        [/not]
        [/and]
        [then]
     
        [store_unit_type]
            type=$second_unit.type
            variable=tmp_br_killer_type
        [/store_unit_type]
 
        [chat]
        speaker="Battle Royale"
        message="$unit.name| has been eliminated by a $tmp_br_killer_type.name|"
        [/chat]

        {CLEAR_VARIABLE tmp_br_killer_type}
 
 
        [/then]
        [/elseif]
        [elseif]
        [have_unit]
         id=$unit.id
         terrain=Xv
        [/have_unit]
        [then]
        [chat]
        speaker="Battle Royale"
        message="$unit.name| has been consumed by the void at the map border"
        [/chat]
        [/then]
        [/elseif]
        [else]
        [chat]
        speaker="Battle Royale"
        message="$unit.name| has been eliminated"
        [/chat]
        [/else]
        [/if]
        {IF_VAR battleroyale_noghost not_equals yes (
        [then]
        [store_unit]
                [filter]
                x,y=$x1,$y1
                [not]
                   race=undead
                [/not]
                [/filter]
                variable=contestant_ghost
                kill=no
                mode=append
        [/store_unit]
        [/then])}
    [/event]
    [event]
        name=new turn
        first_time_only=yes
        [filter_condition]
            {VARIABLE_CONDITIONAL turn_number equals "$($battle_royale_ghostturn - 1)"}
            [and]
                {VARIABLE_CONDITIONAL battleroyale_noghost not_equals yes}
            [/and]
        [/filter_condition]
        [sound]
            name=wail.wav
        [/sound]
        [chat]
            speaker="Battle Royale"
            message="You can hear a ghostly wail... Prepare to fight the spirits of dead enemies!"
        [/chat]
    [/event]
    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
#            {VARIABLE_CONDITIONAL side_number equals $battle_royale_enemyside}
#            [and]
                {VARIABLE_CONDITIONAL turn_number greater_than_equal_to $battle_royale_ghostturn}
#            [/and]
            [and]
                {VARIABLE_CONDITIONAL battleroyale_noghost not_equals yes}
            [/and]
        [/filter_condition]

        [foreach]
           array=contestant_ghost
           index_var=i
           [do]

       {VARIABLE this_item.side $battle_royale_enemyside}
#       {VARIABLE_OP this_item.max_hitpoints multiply 0.8}
       {VARIABLE this_item.hitpoints $this_item.max_hitpoints}
       {VARIABLE this_item.race undead}
       {VARIABLE this_item.canrecruit no}

        [random_placement]
             num_items=1
             variable=random_placement_location
             allow_less=yes
             min_distance=0
             [filter_location]
                 include_borders=no
                 [not]
                    terrain=Ur^Efm,X*,Q*,W*,_off^_usr
                    #try to avoid spawning ghosts next to players
                    [or]
                        [filter]
                            canrecruit=yes
                        [/filter]
                        radius=2
                    [/or]
                 [/not]
             [/filter_location]
             [command]
                {VARIABLE this_item.x $random_placement_location.x}
                {VARIABLE this_item.y $random_placement_location.y}
             [/command]
        [/random_placement]

        {CLEAR_VARIABLE random_placement_location}
        [unstore_unit]
             variable=this_item
             find_vacant=yes
        [/unstore_unit]
        [object]
         silent=yes
         duration=forever
         [filter]
            id=$this_item.id
         [/filter]
         [effect]
            apply_to=image_mod
            add="~O(60%)~CS(-20,-70,0)"
         [/effect]
         [effect]
             apply_to=resistance
             replace=no
             [resistance]
                 arcane=30#arcane resistance nerf for realism, since they are undead
             [/resistance]
         [/effect]
        [/object]
        [modify_unit]
         [filter]
            id=$this_item.id
         [/filter]
         {TRAIT_UNDEAD}
        [/modify_unit]
        [sound]
             name=wail.wav
        [/sound]
        [delay]
             time=200
        [/delay]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE contestant_ghost}
    [/event]
#now configured in scenario files
#    {BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC}
    {BATTLE_ROYALE_ITEMSCATTER_EVENT}
    {BATTLE_ROYALE_ITEM_SPAWN_EVENTS}
    {BATTLE_ROYALE_ITEMDROP_EVENTS}
    {BATTLEROYALE_ITEM_EFFECT_EVENTS}
#enddef

#define BATTLE_ROYALE_ITEMSCATTER_EVENT
    [event]
        name=start
        id=battleroyale_scatteritems
        [store_map_dimensions]
        [/store_map_dimensions]

        {IF_VAR battleroyale_noloot not_equals yes (
        [and]
            {VARIABLE_CONDITIONAL battleroyale_item_mod_noscatter not_equals yes}
        [/and]
        [then]

        #calculate the area of the map, distribute the number of items accordingly
        {VARIABLE br_map_area "$($map_size.width| * $map_size.height|)"}

        [if]
            {VARIABLE_CONDITIONAL battle_royale_item_mod equals yes}
            [then]
                {VARIABLE br_tmp_loot "$($br_map_area| * $battleroyale_item_mod_scatter_multiplier_percentage| / 100)"}#if using item mod, use multiplier in [options] instead of calculating based on enemy side
            [/then]
            [else]
                {VARIABLE br_tmp_loot "$($br_map_area| * (6 + ($battle_royale_enemyside|) / 3 ) / 9)"}#the more sides there is, the higher loot chance, but it scales somewhat slowly
            [/else]
        [/if]

        {VARIABLE br_tmp_loot "$($br_tmp_loot| / 80)"} 

#        {BATTLE_ROYALE_SCATTER_ITEMS_COMMON "$($br_map_area / 80)"}
#        {BATTLE_ROYALE_SCATTER_ITEMS_RARE "$($br_map_area / 240)"}
#        {BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY "$(1 + $br_map_area / 900)"}
        {BATTLE_ROYALE_SCATTER_ITEMS_COMMON "$($br_tmp_loot|)"}
        {BATTLE_ROYALE_SCATTER_ITEMS_RARE "$($br_tmp_loot| / 3)"}
        {BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY "$(1 + $br_tmp_loot| / 11)"}

        {CLEAR_VARIABLE br_map_area}

        {CLEAR_VARIABLE br_tmp_loot}

        [/then]
        )}
    [/event]
#enddef

#define BATTLE_ROYALE_ITEMDROP_EVENTS
[event]
    name=die
    id=battleroyale_deathloot_event
    first_time_only=no
    [filter]
#removed this part of the filter (for the sake of compatibility with the royale item mod), as it is now checked later
#        side=$battle_royale_enemyside
        #enemies killed by void do not drop items
        [not]
        [filter_location]
            terrain=Xv
        [/filter_location]
        [/not]
    [/filter]
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noloot not_equals yes}
    [then]

    #check if the enemy is AI, the third argument is the side the code runs for
    [lua]
        code=<<

--not needed fortunately, since wml.variables["unit.side"] worked
--        local lootenemy = wesnoth.units.find_on_map { x = wml.variables["x1"], y = wml.variables["y1"]}


local result = wesnoth.sync.evaluate_single(
  function()
    return { value = "no" }
  end,
  function()
    -- Called only on the client handling the current side, if it is an AI.
    return { value = "yes" }
  end, wml.variables["unit.side"])
wml.variables["br_is_ai"] = result.value
        >>
    [/lua]

    [if]
    {VARIABLE_CONDITIONAL br_is_ai equals yes}
    [and]
        {VARIABLE_CONDITIONAL battle_royale_item_mod equals yes}
    [/and]
    [and]
        {VARIABLE_CONDITIONAL battleroyale_mod_ai_drop equals yes}
    [/and]
    [or]
        {VARIABLE_CONDITIONAL battle_royale_item_mod equals yes}
        [and]
            {VARIABLE_CONDITIONAL battleroyale_mod_ai_drop equals no}
        [/and]
    [/or]
    [or]
        {VARIABLE_CONDITIONAL unit.side equals $battle_royale_enemyside}
    [/or]
    [then]

    {VARIABLE tmp_loot_level $unit.level}

    {VARIABLE_OP tmp_br_bonus_loot rand 1..5}
    {IF_VAR tmp_br_bonus_loot equals 1 (
    [and]
        {VARIABLE_CONDITIONAL unit.level greater_than_equal_to 0}#failsafe to prevent this code triggering on negative level units and giving a false bonus loot message
    [/and]
    [then]
        {VARIABLE_OP tmp_loot_level add 1}
        [sound]
            name={SOUND_LIST:HOLY}
        [/sound]
        [floating_text]
           x,y=$x1,$y1
           text=_"<span color='#ffff00'>bonus loot!</span>"
        [/floating_text]
    [/then]
    )}
    {CLEAR_VARIABLE tmp_br_bonus_loot}


    [switch]
        variable=tmp_loot_level
        [case]
            value=0
            #no loot unless a player gets lucky and successfully for bonus loot, in which case drops a common item
        [/case]
        [case]
            value=1
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_COMMON $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=2
#            {BATTLE_ROYALE_SPAWN_ITEM_RARE $x1 $y1}
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_RARE $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=3
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=4
#            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $x1 $y1}
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_RARE $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=5
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 2 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        #if the enemy level is above 5 (failsafe just in case someone is using some unusual add-ons. negative level units are ignored), just drop even more legendaries proportionally to level
        #besides being a failsafe, this helps test legendary items by setting an enemy unit's level to something high via debug and killing it
        [else]
            {IF_VAR unit.level greater_than 0 (
            [then]
                {VARIABLE tmp_br_legend_drops $unit.level}
                {VARIABLE_OP tmp_br_legend_drops sub 3}
                {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT $tmp_br_legend_drops $x1 $y1 (
                        {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
                )}
                {CLEAR_VARIABLE tmp_br_legend_drops}
            [/then]
            )}
        [/else]
    [/switch]
    [/then]
    [/if]
    [/then]
    [/if]

    {CLEAR_VARIABLE tmp_loot_level}
    {CLEAR_VARIABLE br_is_ai}
[/event]

[event]
    name=die
    id=battleroyale_deathfragment_event
    first_time_only=no
    [filter]
        [not]
        [filter_location]
            terrain=Xv
        [/filter_location]
        [/not]
    [/filter]
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noloot not_equals yes}
    [and]
        {VARIABLE_CONDITIONAL unit.variables.battleroyale_fragments greater_than 0}
    [/and]
    [then]
        {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT $unit.variables.battleroyale_fragments $x1 $y1 (
            {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON $tmp_unoccupied_item.x $tmp_unoccupied_item.y legendary_fragment}
        )}
    [/then]
    [/if]
[/event]

[event]
    name=start
    id=battle_royale_itemmod_ai
    [filter_condition]
        {VARIABLE_CONDITIONAL battle_royale_item_mod equals yes}
        [and]
            {VARIABLE_CONDITIONAL battleroyale_mod_ai_pickup equals yes}
        [/and]
    [/filter_condition]

        {VARIABLE tmp_ai_index 1}
        {VARIABLE tmp_br_ran_out_of_sides no}
        [while]
            {VARIABLE_CONDITIONAL tmp_br_ran_out_of_sides equals no}
#            [and]
#                {VARIABLE_CONDITIONAL tmp_ai_index less_than_equal_to $battle_royale_enemyside}
#            [/and]
            [do]
                [store_side]
                    side=$tmp_ai_index
                    variable=tmp_br_aiside
                [/store_side]
                [if]
                {VARIABLE_CONDITIONAL tmp_br_aiside.side greater_than 0}
                [then]
#"retreat from void" code is not needed for the item mod
#                {BATTLE_ROYALE_MICROAI $tmp_ai_index $battle_royale_enemyside}
                {BATTLE_ROYALE_MICROAI_ITEMS $tmp_ai_index $battle_royale_enemyside}
                [/then]
                [else]
                    {VARIABLE tmp_br_ran_out_of_sides yes}
                [/else]
                [/if]
                {VARIABLE_OP tmp_ai_index add 1}
                {CLEAR_VARIABLE tmp_br_aiside}
            [/do]
        [/while]
        {CLEAR_VARIABLE tmp_ai_index}
        {CLEAR_VARIABLE tmp_br_ran_out_of_sides}
[/event]
#enddef

#define BATTLEROYALE_ITEM_EFFECT_EVENTS
[event]
    name=die
    id=battle_royale_necronomicon_event
    first_time_only=no
    [filter]
        [not]
            [filter_wml]
                [status]
                    not_living="yes"
                [/status]
            [/filter_wml]
        [/not]
        [filter_location]
            [filter]
                ability=battle_royale_necronomicon
#            [filter_side]
#            [allied_with]
#                side=$unit.side
#            [/allied_with]
#            [/filter_side]
            [not]
                id=$unit.id #to prevent the unit from self-reviving
            [/not]
            [/filter]
            radius=2
        [/filter_location]
    [/filter]

#NO LONGER NEEDED DUE TO CHANGED EVENT ORDER
#    #workaround to make loot drop even from enemies killed with necronomicon
#
#    [fire_event]
#        id=battleroyale_deathloot_event
#        [primary_unit]
#            x,y=$x1,$y1
#        [/primary_unit]
#    [/fire_event]

#do several different [store_unit]s by priority: if there is a resurrecter of same side, use him, if not, check if there is an ally resurrecter, if not, pick any including enemy

    [store_unit]
        [filter]
            side=$unit.side
            ability=battle_royale_necronomicon
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]

    {IF_VAR battle_royale_necronomiconer.length greater_than 0 (
    [else]
    [store_unit]
        [filter]
            ability=battle_royale_necronomicon
            [filter_side]
            [allied_with]
                side=$unit.side
            [/allied_with]
            [/filter_side]
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]
    [/else]
    )}

    {IF_VAR battle_royale_necronomiconer.length greater_than 0 (
    [else]
    [store_unit]
        [filter]
            ability=battle_royale_necronomicon
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]
    [/else]
    )}

    [if]
    [have_unit]
        id=$battle_royale_necronomiconer[0].id
    [/have_unit]
    [then]

    [sound]
        name=magic-dark-big.ogg
    [/sound]

    {VARIABLE unit.side $battle_royale_necronomiconer[0].side}
    {VARIABLE unit.canrecruit no}
    {IF_VAR unit.level greater_than 0 (
    [then]
    {VARIABLE_OP unit.level sub 1}
    [/then]
    )}
    [unstore_unit]
        variable=unit
        find_vacant=no
    [/unstore_unit]

    [modify_unit]
        [filter]
            id=$unit.id
            [not]
                trait=undead
            [/not]
        [/filter]
        {TRAIT_UNDEAD}
    [/modify_unit]

        [heal_unit]
            [filter]
                id=$unit.id
            [/filter]
            amount=full
            animate=no
            restore_statuses=yes
        [/heal_unit]

    [object]
        silent=yes
        duration=forever

        [filter]
            id=$unit.id
        [/filter]

        [effect]
            apply_to=hitpoints
            increase=-40%
            increase_total=-40%
        [/effect]        

        [effect]
            apply_to=attack
            increase_damage=-40%
        [/effect]

        [effect]
            apply_to=new_ability
            [abilities]
                [dummy]
                    id=battle_royale_shade#for reducing level on post advance
                [/dummy]
            [/abilities]
        [/effect]

        [effect]
            apply_to=alignment
            set=chaotic
        [/effect]

        [effect]
            apply_to=image_mod
            add="~GS()~BLEND(125,0,125,0.4)~O(50%)"
        [/effect]

        [effect]
            apply_to=experience
            increase=-40%
        [/effect]

        [effect]
            apply_to=max_experience
            increase=-40%
        [/effect]

    [/object]

    [/then]
    [/if]

    {CLEAR_VARIABLE battle_royale_necronomiconer}
[/event]
#event to ensure amlas don't reduce soul level
[event]
    name=pre advance
    id=battle_royale_necronomicon_shade_reduce_level_pre
    first_time_only=no
    [filter]
        ability=battle_royale_shade
        [not]
            [filter_wml]
                advances_to=""
            [/filter_wml]
        [/not]
    [/filter]
    {VARIABLE tmp_battle_royale_reduce_soul_level yes}
[/event]
#reduces shade level by 1 during post advance, as variable changes don't persist on levelup:
[event]
    name=post advance
    id=battle_royale_necronomicon_shade_reduce_level
    first_time_only=no
    [filter]
        ability=battle_royale_shade
    [/filter]

    {IF_VAR unit.level greater_than 0 (
    [and]
    {VARIABLE_CONDITIONAL tmp_battle_royale_reduce_soul_level equals yes}
    [/and]
    [then]
    {VARIABLE_OP unit.level sub 1}
    [/then]
    )}

    [unstore_unit]
        variable=unit
        find_vacant=no
    [/unstore_unit]

    {CLEAR_VARIABLE tmp_battle_royale_reduce_soul_level}
[/event]
[event]
    name=last breath
    id=battle_royale_phoenixheart_event
    first_time_only=no
    [filter]
        [filter_location]
            [not]
                terrain=Xv#the phoenix heart does not save players from void
            [/not]
        [/filter_location]
    [/filter]
    {IF_VAR unit.variables.battleroyale_phoenixrevives greater_than 0 (
    [then]
        [modify_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            {VARIABLE_OP battleroyale_phoenixrevives sub 1}
        [/modify_unit]
        [floating_text]
           x,y=$x1,$y1
           text=_"<span color='#00ff00'>revived</span>"
        [/floating_text]
        {IF_VAR unit.variables.battleroyale_phoenixrevives greater_than 0 (
        [then]
        [delay]
            time=150
        [/delay]
        [floating_text]
           x,y=$x1,$y1
           text=_"$unit.variables.battleroyale_phoenixrevives| revives left"
        [/floating_text]
        [/then]
        )}
        [heal_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=full
            animate=yes
        [/heal_unit]
    [/then]
    )}
[/event]
[event]
    name=side turn
    id=battle_royale_bottomless_backpack_event
    first_time_only=no
    [store_unit]
        [filter]
            formula="wml_vars.battleroyale_bottomless_backpacks > 0"
            side=$side_number
            [not]
            [filter_wml]
            [status]
                petrified=yes
            [/status]
            [/filter_wml]
            [/not]
        [/filter]
        variable=br_bottomless_backpack_unit
        kill=no
    [/store_unit]
    [foreach]
        array=br_bottomless_backpack_unit
        index_var=i
        [do]
            {IF_VAR this_item.variables.battleroyale_bottomless_backpack_timer greater_than_equal_to 2 (
            [then]
            [modify_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                {VARIABLE battleroyale_bottomless_backpack_timer 0}
            [/modify_unit]
            [floating_text]
               x,y=$this_item.x,$this_item.y
               text=_"opened bottomless backpack"
            [/floating_text]
            [sound]
                name=magicmissile.wav
            [/sound]
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT $this_item.variables.battleroyale_bottomless_backpacks| $this_item.x $this_item.y (
                {VARIABLE_OP tmp_backpack_rarity_rand rand 1..5}
                {IF_VAR tmp_backpack_rarity_rand equals 1 (
                [then]
                    {BATTLE_ROYALE_SPAWN_ITEM_RARE $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
                [/then]
                [else]
                    {BATTLE_ROYALE_SPAWN_ITEM_COMMON $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
                [/else]
                )}
                {CLEAR_VARIABLE tmp_backpack_rarity_rand}
            )}

            [/then]
            )}
            [modify_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                {VARIABLE_OP battleroyale_bottomless_backpack_timer add 1}
            [/modify_unit]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE br_bottomless_backpack_unit}
[/event]
[event]
    name=attack end
    id=battle_royale_tricksterring_event
    first_time_only=no
    [filter]
        formula="wml_vars.battleroyale_tricksterrings > 0"
    [/filter]
    [modify_unit]
        [filter]
            id=$unit.id
        [/filter]
        moves="$($unit.moves| + $unit.variables.battleroyale_tricksterrings|)"
    [/modify_unit]
    [floating_text]
       x,y=$x1,$y1
       text=_"<span color='#00ff00'>+$unit.variables.battleroyale_tricksterrings| moves</span>"
    [/floating_text]
[/event]
#enddef