#textdomain wesnoth-multiplayer

#change between human/ai for testing

#define BATTLE_ROYALE_CONTROLLER
ai#enddef

#define BATTLE_ROYALE_SIDE_SETTINGS
        gold=50
        income=-2
        village_gold=1
        [ai]
        leader_ignores_keep=yes
        leader_aggression=0.7
        aggression=1.0
        [avoid]
            terrain=Ur^Efm
        [/avoid]
        [goal]
            name=target
            [criteria]
                canrecruit=yes
            [/criteria]
            value=25
        [/goal]
        [goal]
            name=target_location
            [criteria]
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=5
            [/filter_location]
            [/criteria]
            value=30
        [/goal]
        village_value=0.1
        [/ai]        
#enddef

#define BATTLE_ROYALE_MICROAI SIDE ENEMYSIDE
#        [micro_ai]
#            side={SIDE}
#            ai_type=hang_out
#            action=add
#            id=battleroyale_movetocenter
#            [filter]
#                canrecruit=yes
#            [filter_location]
#            [not]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=5
#            [/not]
#            [/filter_location]
#            [/filter]
#            [filter_location]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=2
#            [/filter_location]
#            ca_score=30000#relatively low CA score, as other actions are higher priority
#        [/micro_ai]
        [micro_ai]
            side={SIDE}
#            ai_type=hang_out
            ai_type=goto
            action=add
            id=battleroyale_movetocenter_when_near_void
            [filter]
##commented out, so that spawned allies also flee from void
##                canrecruit=yes
#            [filter_location]
#            [not]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=5
#            [/not]
#            [and]
#                terrain=Xv
#                radius=4
#            [/and]
#            [/filter_location]
            [filter_location]
                terrain=Ur^Efm
            [/filter_location]
            [/filter]
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=2
            [/filter_location]
            ca_score=195000#very high CA score, as fleeing from the void is more important than combat/items
            unique_goals=yes
            remove_movement=no
        [/micro_ai]
#        [micro_ai]
#            side={SIDE}
#            ai_type=hang_out
#            action=add
#            id=battleroyale_chaseenemy
#            [filter]
#                canrecruit=yes
#            [filter_location]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=5
#            [/filter_location]
#            [/filter]
#            [filter_location]
#            [filter]
#            canrecruit=yes
#            [filter_side]
#            [enemy_of]
#            side={SIDE}
#            [/enemy_of]
#            [/filter_side]
#            [/filter]
#            [/filter_location]
#            ca_score=30000#relatively low CA score, as other actions are higher priority
#        [/micro_ai]
        #AI for 40p and 100p matches is slightly simplified - it ignores far away items and only picks up nearby ones. should make AI turns slightly faster
        [if]
        {VARIABLE_CONDITIONAL battle_royale_enemyside greater_than_equal_to 40}
        [else]
        [micro_ai]
            side={SIDE}
            ai_type=goto
            action=add
            ca_id=battleroyale_get_items
            [filter]
                [not]
                    side={ENEMYSIDE}#AI creatures/ghosts side
                [/not]
                [filter_location]
                    [not]
                        terrain=Ur^Efm#taking items on tiles about to be consumed by void is a guaranteed death for AI, as the goto micro ai stops movement
                    [/not]
                    [and]
                        find_in=battle_royale_loot_tiles
                        radius=10
                    [/and]
                [/filter_location]
            [/filter]
            [filter_location]
                find_in=battle_royale_loot_tiles
            [/filter_location]
            ca_score=70000#priority is lower than to attack
            remove_movement=no
            unique_goals=yes
        [/micro_ai]
        [/else]
        [/if]
        [micro_ai]
            side={SIDE}
            ai_type=goto
            action=add
            ca_id=battleroyale_get_items_near

            [filter]
                [not]
                    side={ENEMYSIDE}#AI creatures/ghosts side
                [/not]
                [filter_location]
                    [not]
                        terrain=Ur^Efm#taking items on tiles about to be consumed by void is a guaranteed death for AI, as the goto micro ai stops movement
                    [/not]
                    [and]
                        find_in=battle_royale_loot_tiles
                        radius=4
                    [/and]
                [/filter_location]
            [/filter]
            [filter_location]
                find_in=battle_royale_loot_tiles
            [/filter_location]
            ca_score=150000#getting nearby items is higher priority than attack
            remove_movement=no
            unique_goals=yes
        [/micro_ai]
#enddef

#define BATTLE_ROYALE_SETTINGS
[options]
#        [checkbox]
#            id=battleroyale_respawn
#            default=yes
#            name="Enable Ghosts"
#            description="When players die, AI-controlled ghosts of their unit are spawned some time after."
#        [/checkbox]
        [checkbox]
            id=battleroyale_noghost
            default=no
            name="Disable Ghosts"
            description="Disables the AI-controlled ghosts that spawn some time after players die."
        [/checkbox]
        [checkbox]
            id=battleroyale_noshrink
            default=no
            name="Disable Shrinking Map"
            description="Disables the map shrinking over the course of the match"
        [/checkbox]
        [checkbox]
            id=battleroyale_noloot
            default=no
            name="Disable Loot"
            description="Disables random items that spawn on the map."
        [/checkbox]
        [checkbox]
            id=battleroyale_see_items_in_fog
            default=no
            name="Can see items in fog"
            description="If enabled, you will be able to see items through fog."
        [/checkbox]
[/options]
#enddef

#define BATTLE_ROYALE_SPAWNITEM X Y TEXT TEXT_COLOR IMAGE HALO NAME MESSAGE EFFECT
{VARIABLE br_tmp_x {X}}
{VARIABLE br_tmp_y {Y}}
[label]
    text={TEXT}
    x,y=$br_tmp_x,$br_tmp_y
    color={TEXT_COLOR}
    visible_in_fog=$battleroyale_see_items_in_fog
[/label]
[set_variables]
    name=battle_royale_loot_tiles
    mode=append
    [value]
        x=$br_tmp_x
        y=$br_tmp_y
    [/value]
[/set_variables]
[item]
    x=$br_tmp_x
    y=$br_tmp_y
    name=battleroyale_item_{IMAGE}
    image={IMAGE}
    halo={HALO}
    visible_in_fog=$battleroyale_see_items_in_fog
[/item]
[event]
    name=moveto
    delayed_variable_substitution=no
    [filter]
        x,y=$br_tmp_x,$br_tmp_y
        [not]
            side=$battle_royale_enemyside#AI creatures/ghosts side
        [/not]
    [/filter]
#    {IF_VAR battle_royale_itemeffect_after_clear not_equals yes (
#    [then]
        {EFFECT}
#    [/then]
#    )}
    [remove_item]
        x,y=$br_tmp_x,$br_tmp_y
        image=battleroyale_item_{IMAGE}
    [/remove_item]
    [label]
        text=""
        x,y=$br_tmp_x,$br_tmp_y
    [/label]
    #messages are only shown if the item is taken by a human side:
    [lua]
        code=<<
local result = wesnoth.sync.evaluate_single(
  function()
    return { value = "no" }
  end,
  function()
    -- Called only on the client handling the current side, if it is an AI.
    return { value = "yes" }
  end)
wml.variables["br_is_ai"] = result.value
        >>
    [/lua]
    [floating_text]
       x,y=$br_tmp_x,$br_tmp_y
       text=_"picked up item"
    [/floating_text]
    {IF_VAR br_is_ai not_equals yes (
    [then]
    [message]
        speaker=narrator
        caption={NAME}
        side_for=$|side_number
        image={IMAGE}"~SCALE(144,144)"
        message={MESSAGE}
    [/message]
    [/then]
    )}
    {CLEAR_VARIABLE br_is_ai}
#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$|battle_royale_loot_tiles.length
    [/variable]
    [do]
        {IF_VAR battle_royale_loot_tiles[$|c].x equals $br_tmp_x (
        [and]
            {VARIABLE_CONDITIONAL battle_royale_loot_tiles[$|c].y equals $br_tmp_y}
        [/and]
        [then]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$|c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        )}
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}

#    {IF_VAR battle_royale_itemeffect_after_clear equals yes (
#    [then]
#        {EFFECT}
#    [/then]
#    )}

#    {CLEAR_VARIABLE battle_royale_itemeffect_after_clear}

[/event]
{CLEAR_VARIABLE br_tmp_x,br_tmp_y}
#enddef

#different item rarities have different colors

#define BATTLE_ROYAL_ITEM_CASE_COMMON NUM TEXT IMAGE MESSAGE CODE
[case]
   value={NUM}
#   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Common)" 100,100,255 {IMAGE} () {TEXT} {MESSAGE} {CODE}}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT} 100,100,255 {IMAGE} () {TEXT} {MESSAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYAL_ITEM_CASE_RARE NUM TEXT IMAGE MESSAGE CODE
[case]
   value={NUM}
#   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Rare)" 200,0,255 {IMAGE} () {TEXT} {MESSAGE} {CODE}}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT} 200,0,255 {IMAGE} () {TEXT} {MESSAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYAL_ITEM_CASE_LEGENDARY NUM TEXT IMAGE HALO MESSAGE CODE
[case]
   value={NUM}
#   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Legendary)" 255,255,0 {IMAGE} {HALO} {TEXT} {MESSAGE} {CODE}}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT} 255,255,0 {IMAGE} {HALO} {TEXT} {MESSAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_COMMON X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    name=battleroyale_spawn_item_common
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_RARE X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    name=battleroyale_spawn_item_rare
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    name=battleroyale_spawn_item_legendary
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON X Y ITEM_NUM_TYPE
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
{VARIABLE battle_royale_force_specific_itemspawn yes}
{VARIABLE battle_royale_item_type {ITEM_NUM_TYPE}}
[fire_event]
    name=battleroyale_spawn_item_common
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y,battle_royale_force_specific_itemspawn}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_RARE X Y ITEM_NUM_TYPE
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
{VARIABLE battle_royale_force_specific_itemspawn yes}
{VARIABLE battle_royale_item_type {ITEM_NUM_TYPE}}
[fire_event]
    name=battleroyale_spawn_item_rare
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y,battle_royale_force_specific_itemspawn}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_LEGENDARY X Y ITEM_NUM_TYPE
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
{VARIABLE battle_royale_force_specific_itemspawn yes}
{VARIABLE battle_royale_item_type {ITEM_NUM_TYPE}}
[fire_event]
    name=battleroyale_spawn_item_legendary
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y,battle_royale_force_specific_itemspawn}
#enddef





#used for lootboxes and other multi-item drop items
#define BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED TIMES X Y CODE
{REPEAT {TIMES} (

    {VARIABLE tmp_itemplace_radius 0}
    [while]
        {VARIABLE_CONDITIONAL tmp_itemplace_radius less_than 10}#failsafe just in case the code gets stuck in some very rare edge case
        [and]
        [not]
            {VARIABLE_CONDITIONAL itemplace_locs.length greater_than 0}
        [/not]
        [/and]
        [do]
        [store_locations]
            [not]
                terrain=X*^*,Q*^*,*^X*#never spawns items on impassable terrain
                [or]
                    find_in=battle_royale_loot_tiles
                [/or]
            [/not]
            [and]
                x,y={X},{Y}
                radius=$|tmp_itemplace_radius
            [/and]
            variable=itemplace_locs
        [/store_locations]
        {VARIABLE_OP tmp_itemplace_radius add 1}
        [/do]
    [/while]

    {VARIABLE tmp_unoccupied_item.x $|itemplace_locs[0].x}
    {VARIABLE tmp_unoccupied_item.y $|itemplace_locs[0].y}

    {CODE}

    {CLEAR_VARIABLE itemplace_locs,tmp_itemplace_radius,tmp_unoccupied_item}
)}
#enddef

#used for mob drops and anything else that isn't called from another item
#define BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT TIMES X Y CODE
{REPEAT {TIMES} (

    {VARIABLE tmp_itemplace_radius 0}
    [while]
        {VARIABLE_CONDITIONAL tmp_itemplace_radius less_than 10}#failsafe just in case the code gets stuck in some very rare edge case
        [and]
        [not]
            {VARIABLE_CONDITIONAL itemplace_locs.length greater_than 0}
        [/not]
        [/and]
        [do]
        [store_locations]
            [not]
                terrain=X*^*,Q*^*#never spawns items on impassable terrain
                [or]
                    find_in=battle_royale_loot_tiles
                [/or]
            [/not]
            [and]
                x,y={X},{Y}
                radius=$tmp_itemplace_radius
            [/and]
            variable=itemplace_locs
        [/store_locations]
        {VARIABLE_OP tmp_itemplace_radius add 1}
        [/do]
    [/while]

        {VARIABLE tmp_unoccupied_item.x $itemplace_locs[0].x}
        {VARIABLE tmp_unoccupied_item.y $itemplace_locs[0].y}

    {CODE}

    {CLEAR_VARIABLE itemplace_locs,tmp_itemplace_radius,tmp_unoccupied_item}
)}
#enddef

#using events/fire_event instead of macros, as macros create crash-causing macro recursion issues with lootbox
#define BATTLE_ROYALE_ITEM_SPAWN_EVENTS
#[event]
#    name=battleroyale_spawn_item_common
#    first_time_only=no
#    {VARIABLE_OP battle_royale_item_type rand 1..10}
#    [fire_event]
#        name=battleroyale_spawn_item_common_specific_type
#    [/fire_event]
#    {CLEAR_VARIABLE battle_royale_item_type}
#
#[/event]


[event]
    name=battleroyale_spawn_item_common
    first_time_only=no
    {IF_VAR battle_royale_force_specific_itemspawn not_equals yes (
    [then]
        {VARIABLE_OP battle_royale_item_type rand 1..12}
    [/then]
    )}
[switch]
    variable=battle_royale_item_type
    {BATTLE_ROYAL_ITEM_CASE_COMMON 1 _"Heal Potion" "items/potion-red.png" _"Health restored to full" (
    [sound]
        name=potion.ogg
    [/sound]
    [heal_unit]
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        amount=full
        animate=yes
    [/heal_unit]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 2 _"EXP Potion" "items/potion-blue.png" _"You gain 16 experience" (
    [sound]
        name=potion.ogg
    [/sound]
    [store_unit]
       [filter]
           id=$|unit.id
       [/filter]
       variable=tmp_exppotion_unit
    [/store_unit]
    {VARIABLE_OP tmp_exppotion_unit.experience add 16}
    [unstore_unit]
       variable=tmp_exppotion_unit
       find_vacant=no
    [/unstore_unit]
    {CLEAR_VARIABLE tmp_exppotion_unit}
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 3 _"Elven Cloak" "items/cloak-green.png" _"Wearing an elven cloak allows you to hide in forests, sets your forest defense to 70%, and sets forest movecost to 1" (
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=defense
            replace=yes
            [defense]
                forest=30
            [/defense]
        [/effect]
        [effect]
            apply_to=movement_costs
            replace=yes
            [movement_costs]
                forest=1
            [/movement_costs]
        [/effect]
        [effect]
            apply_to=new_ability
            [abilities]
                {ABILITY_AMBUSH}
            [/abilities]
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 4 _"Poison Bottle" "items/potion-poison.png" _"All your current attacks gain poison" (
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=attack
            [set_specials]
                mode=append
                {WEAPON_SPECIAL_POISON}
            [/set_specials]
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 5 _"Rat Cage" "units/monsters/giant-rat.png~BLIT(items/cage.png)" _"Summoned four Giant Rats" (
        {REPEAT 4 (
           [unit]
               type=Giant Rat
               side=$|side_number
               generate_name=yes
               random_traits=yes
               placement=map
               passable=yes
               x,y=$|x1,$|y1
           [/unit]
        )}
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 6 _"Iron Armor" "items/armor.png" _"Increases your physical resistances by 10%" (
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                blade=-10
                pierce=-10
                impact=-10
            [/resistance]
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 7 _"Warding Amulet" "items/ankh-necklace.png" _"Increases your magical resistances by 10%" (
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                arcane=-10
                fire=-10
                cold=-10
            [/resistance]
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 8 _"Strength Potion" "items/potion-yellow.png" _"All your attacks gain 1 more damage. You gain 5 more max HP" (
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=attack
            increase_damage=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase=5
            increase_total=5
        [/effect]        
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 9 _"Speed Potion" "items/potion-grey.png" _"Gain 1 more movement" (
    [object]
        duration=forever
        silent=yes
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 10 _"Random Skin" "items/box.png~SCALE(50,50)~GS()~BLEND(0,0,255,0.3)" _"Get a random skin (recolor effect on your unit, replaces any previous skins. Purely visual, no gameplay effects)" (

        {VARIABLE_OP tmp_skin_type_rand rand 1..12}
        [switch]
            variable=tmp_skin_type_rand
            [case]
                value=1
                {VARIABLE tmp_imagemod "~GS()"}
            [/case]
            [case]
                value=2
                {VARIABLE tmp_imagemod "~NEG()"}
            [/case]
            [case]
                value=3
                {VARIABLE tmp_imagemod "~BW(100)"}
            [/case]
            [case]
                value=4
                {VARIABLE tmp_imagemod "~BLEND(0,0,0,1)"}
            [/case]
            [case]
                value=5
                {VARIABLE tmp_imagemod "~GS()~BLEND(255,0,0,0.3)"}
            [/case]
            [case]
                value=6
                {VARIABLE tmp_imagemod "~GS()~BLEND(0,255,0,0.3)"}
            [/case]
            [case]
                value=7
                {VARIABLE tmp_imagemod "~GS()~BLEND(0,0,255,0.3)"}
            [/case]
            [case]
                value=8
                {VARIABLE tmp_imagemod "~BLEND(255,255,255,1)"}
            [/case]
            [case]
                value=9
                {VARIABLE tmp_imagemod "~SEPIA()"}
            [/case]
            [case]
                value=10
                {VARIABLE tmp_imagemod "~FL(vert)"}
            [/case]
            [case]
                value=11
                {VARIABLE tmp_imagemod "~GS()~BLEND(200,0,255,0.3)"}
            [/case]
            [case]
                value=12
                {VARIABLE tmp_imagemod "~GS()~BLEND(255,200,0,0.3)"}
            [/case]
        [/switch]

        [object]
            duration=forever
            silent=yes
            [filter]
                x,y=$|x1,$|y1
            [/filter]
            [effect]
                apply_to=image_mod
#                add=$|tmp_imagemod
                replace=$|tmp_imagemod
            [/effect]
        [/object]


        {CLEAR_VARIABLE tmp_skin_type_rand}
        {CLEAR_VARIABLE tmp_imagemod}

    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 11 _"Legendary Fragment" "items/talisman-ankh.png" _"If you collect 4 of these fragments (can be carried by different units), you will get a legendary item. Unlike most other items, this one can be dropped on death after being picked up." (
    [modify_unit]
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        {VARIABLE_OP battleroyale_fragments add 1}
    [/modify_unit]
    #TODO: do a foreach loop of all units of this side, if there is enough fragments for the legendary, remove the fragment variables and spawn a legendary (TODO: maybe spawn a specific one)

    [store_unit]
        [filter]
            side=$|side_number
        [/filter]
        variable=tmp_fragment_units
        kill=no
    [/store_unit]

    [foreach]
        array=tmp_fragment_units
        index_var=i
        [do]
            {VARIABLE_OP tmp_current_side_fragments add $|unit.variables.battleroyale_fragments}
        [/do]
    [/foreach]

    {IF_VAR tmp_current_side_fragments greater_than_equal_to 4 (
    [then]
        {VARIABLE tmp_leftover_fragments $|tmp_current_side_fragments}
        {VARIABLE_OP tmp_leftover_fragments sub 4}

        {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED $|tmp_leftover_fragments $|x1 $|y1 (
            {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON $this_item.x $this_item.y 11}#spawns one fragment
        )}

        [foreach]
            array=tmp_fragment_units
            index_var=i
            [do]
                [modify_unit]
                    [filter]
                        id=$|this_item.id
                    [/filter]
                    {CLEAR_VARIABLE battleroyale_fragments}
                [/modify_unit]
            [/do]
        [/foreach]

        [sound]
            name={SOUND_LIST:HOLY}
        [/sound]
        [sound]
            name=lightning.ogg
        [/sound]

        [floating_text]
           x,y=$x1,$y1
           text=_"<span color='#ffff00'>fragments merged!</span>"
        [/floating_text]

        {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 1 $|x1 $|y1 (
            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
        )}
    [/then]
    )}

    {CLEAR_VARIABLE tmp_current_side_fragments,tmp_fragment_units,tmp_leftover_fragments}

    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 12 _"Portal" "scenery/whirlpool.png" _"Teleports you to a random location, avoiding the void" (

    [sound]
        name=magic-faeriefire.ogg
    [/sound]

#first try to teleport to desirable tiles, if that fails, teleport anywhere that isn't void or about to be consumed by void

    [store_locations]
        [not]
            terrain=X*^*,Ur^Efm#never teleports units to the void, or tiles about to be consumed by void
        [/not]
        #teleporting too close to the portal kinda defeats the purpose of it, after all
        [not]
            x,y=$|x1,$|y1
            radius=5
        [/not]
        [and]
            find_in=battle_royale_loot_tiles
            radius=3
        [/and]
        variable=battleroyale_portal_locs
    [/store_locations]

    {IF_VAR battleroyale_portal_locs.length greater_than 0 (
    [else]
    [store_locations]
        [not]
            terrain=X*^*,Ur^Efm#never teleports units to the void, or tiles about to be consumed by void
        [/not]
        variable=battleroyale_portal_locs
    [/store_locations]
    [/else]
    )}

    {VARIABLE tmp_portal_random_limit $|battleroyale_portal_locs.length}
    {VARIABLE_OP tmp_portal_random_limit sub 1}
    {RANDOM 0..$|tmp_portal_random_limit}

    {TELEPORT_UNIT x,y=$|x1,$|y1 $|battleroyale_portal_locs[$|random].x $|battleroyale_portal_locs[$|random].y}
    [redraw]
        clear_shroud=yes
    [/redraw]
    [scroll_to]
        side=$|side_number
        x,y=$|battleroyale_portal_locs[$|random].x,$|battleroyale_portal_locs[$|random].y
    [/scroll_to]
    {CLEAR_VARIABLE tmp_portal_random_limit}

    )}

    [/switch]
[/event]
[event]
    name=battleroyale_spawn_item_rare
    first_time_only=no
    {IF_VAR battle_royale_force_specific_itemspawn not_equals yes (
    [then]
        {VARIABLE_OP battle_royale_item_type rand 1..12}
    [/then]
    )}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_RARE 1 _"Spectral Cloak" "items/cloak-green.png~GS()~O(60%)" _"Wearing the spectral cloak gives you the following benefits: 
-nightstalk
-skirmisher
-1 more movement
-1 movement cost on flat/forest/sand/hills/mountains/frozen/cave terrain" (
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]

                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            flat=1
                            forest=1
                            sand=1
                            hills=1
                            mountains=1
                            frozen=1
                            cave=1
                        [/movement_costs]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_NIGHTSTALK}
                            {ABILITY_SKIRMISHER}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
                    [effect]
                        apply_to=image_mod
                        add="~O(70%)"
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 2 _"Lootbox" "items/box.png" _"The lootbox drops three random items next to is tile - they can be common, rare, or even legendary!" (

                    {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 3 $|x1 $|y1 (
#                        [chat]
#                            message="$this_item.x|,$this_item.y|"
#                        [/chat]
#                        [chat]
#                            message="$|this_item.x|,$|this_item.y|"
#                        [/chat]
                        {VARIABLE_OP tmp_lootbox_type_rand rand 1..10}
                        {IF_VAR tmp_lootbox_type_rand equals 1 (
                        [then]
                            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                        [/then]
                        [elseif]
                            {VARIABLE_CONDITIONAL tmp_lootbox_type_rand less_than_equal_to 3}
                            [then]
                            {BATTLE_ROYALE_SPAWN_ITEM_RARE $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                            [/then]
                        [/elseif]
                        [else]
                            {BATTLE_ROYALE_SPAWN_ITEM_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                        [/else]
                        )}
                        {CLEAR_VARIABLE tmp_lootbox_type_rand}
                    )}

                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 3 _"Berserker Axe" "items/axe.png" _"A powerful axe used by dwarven berserkers, it allows the wielder to attack extremely quickly" (
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=berserker axe
                        description= _"berserker axe"
                        type=blade
                        range=melee
                        [specials]
                            {WEAPON_SPECIAL_BERSERK}
                        [/specials]
                        icon=attacks/frenzy.png
                        damage=6
                        number=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=berserker axe
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=berserker axe
                            [/filter_attack]
                    
                            start_time=-200
                    
                            [frame]
                            duration=300
                            [/frame]
                    
                            {SOUND:HIT_AND_MISS axe.ogg {SOUND_LIST:MISS} -100}
                        [/attack_anim]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 4 _"Mausoleum" "misc/blank-hex.png~BLIT(scenery/mausoleum01.png~CROP(36,30,80,80))" _"Summoned a Wraith" (
                    [sound]
                        name=wail.wav
                    [/sound]
                    [unit]
                        type=Wraith
                        generate_name=yes
                        random_traits=yes
                        placement=map
                        passable=yes
                        x,y=$|x1,$|y1
                        side=$|side_number
                    [/unit]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 5 _"Vampire Amulet" "items/necklace-bone.png" _"All your attacks gain drain, including weapons picked up after taking this item." (
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {WEAPON_SPECIAL_DRAIN}
                        [/abilities]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 6 _"Iris Potion" "items/potion-blue.png~BLEND(200,0,255,0.3)" _"Potion brewed from iris flowers, swaps the unit's gender" (
                [if]
                    [have_unit]
                        x,y=$|x1,$|y1
                        gender=female
                    [/have_unit]
                    [then]
                        {MODIFY_UNIT x,y=$|x1,$|y1 gender male}
                    [/then]
                    [else]
                        {MODIFY_UNIT x,y=$|x1,$|y1 gender female}
                    [/else]
                [/if]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 7 _"Elven Bow" "items/bow-elven.png" _"A powerful bow used by elven marksmen, it is capable of shooting quite accurately" (
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=elven bow
                        description= _"elven bow"
                        type=pierce
                        range=ranged
                        [specials]
                            {WEAPON_SPECIAL_MARKSMAN}
                        [/specials]
                        icon=attacks/bow-elven-magic.png
                        damage=6
                        number=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=elven bow
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=elven bow
                            [/filter_attack]
                            start_time=-250
                            missile_start_time=-150
                    
                            [missile_frame]
                                duration=150
                                image="projectiles/missile-n.png"
                                image_diagonal="projectiles/missile-ne.png"
                            [/missile_frame]
                    
                            [frame]
                                duration=300
                            [/frame]
                    
                            {SOUND:HIT_AND_MISS bow.ogg bow-miss.ogg -225}
                        [/attack_anim]
                    [/effect]
                [/object]
                )}

               {BATTLE_ROYAL_ITEM_CASE_RARE 8 _"Charger Amulet" "items/ankh-necklace.png~GS()~BLEND(255,0,0,0.3)" _"All your current attacks gain charge, +6 max hp" (
               [object]
                   duration=forever
                   silent=yes
                   [filter]
                       x,y=$|x1,$|y1
                   [/filter]
                   [effect]
                       apply_to=attack
                       [set_specials]
                           mode=append
                           {WEAPON_SPECIAL_CHARGE}
                       [/set_specials]
                   [/effect]
                   [effect]
                       apply_to=hitpoints
                       increase=6
                       increase_total=6
                   [/effect]        
               [/object]
               )}

                {BATTLE_ROYAL_ITEM_CASE_RARE 9 _"Temple" "scenery/temple1.png" _"A White Mage joins your team" (
                    [sound]
                        name={SOUND_LIST:HOLY}
                    [/sound]
                    [unit]
                        type=White Mage
                        generate_name=yes
                        random_traits=yes
                        random_gender=yes
                        placement=map
                        passable=yes
                        x,y=$|x1,$|y1
                        side=$|side_number
                    [/unit]
                )}

                {BATTLE_ROYAL_ITEM_CASE_RARE 10 "Potion Chest" "items/chest-plain-closed.png" _"You find several potions in the chest" (
                    {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 4 $|x1 $|y1 (
                        #numerical ids of heal potion, exp potion, strength potion and speed potion
                        #(iris potion excluded for now, as making the random code for multiple rarities would be a bit tedious)
                        {VARIABLE_OP tmp_potion_type rand 1,2,8,9}
                        {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y $|tmp_potion_type}
                    )}
                    {CLEAR_VARIABLE tmp_potion_type}
                )}


                {BATTLE_ROYAL_ITEM_CASE_RARE 11 "Armor Chest" "items/chest-plain-closed.png~GS()" _"You find some armor in the chest" (

                    {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 3 $|x1 $|y1 (
                        #numerical ids of armor and warding amulet
                        {VARIABLE_OP tmp_itemrand_type rand 6,7}
                        {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y $|tmp_itemrand_type}
                    )}
                    {CLEAR_VARIABLE tmp_itemrand_type}
                )}

                {BATTLE_ROYAL_ITEM_CASE_RARE 12 _"Druid Staff" "items/staff-druid.png" _"Used by elven druids, this staff allows the wielder to slow foes, heal allies, and regenerate health each turn" (
                [sound]
                    name=entangle.wav
                [/sound]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_CURES}
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_attack
                        name=druid staff ensnare
                        description= _"ensnare"
                        type=impact
                        range=ranged
                        [specials]
                            {WEAPON_SPECIAL_SLOW}
                        [/specials]
                        icon=attacks/entangle.png
                        damage=2
                        number=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=druid staff ensnare
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=druid staff ensnare
                            [/filter_attack]
                            missile_start_time=-200
                            [missile_frame]
                                offset=1.0
                                duration=200
                                image="projectiles/entangle.png"
                                image_diagonal="projectiles/entangle.png"
                            [/missile_frame]
                            start_time=-300
                            [frame]
                                duration=600
                                halo="halo/elven/nature-halo[1~8].png"
                                halo_x,halo_y=0,-12
                            [/frame]
                            attack_sound_start_time=-75
                            [attack_sound_frame]
                                sound=entangle.wav
                            [/attack_sound_frame]
                        [/attack_anim]
                    [/effect]
                [/object]
                )}

            [/switch]
[/event]
[event]
    name=battleroyale_spawn_item_legendary
    first_time_only=no
    {IF_VAR battle_royale_force_specific_itemspawn not_equals yes (
    [then]
        {VARIABLE_OP battle_royale_item_type rand 1..8}
    [/then]
    )}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 1 _"Sceptre of Fire" "items/sceptre-of-fire.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(255,0,0,1):150" _"This ancient Sceptre was forged by the great Dwarves of the Heart Mountains. A symbol of the kingship of Wesnoth, the Sceptre has the power to shoot fireballs at enemies of the bearer!" (
                [sound]
                    name=fire.wav
                [/sound]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=sceptre of fire
                        description= _"sceptre of fire"
                        type=fire
                        range=ranged
                        [specials]
                            {WEAPON_SPECIAL_MAGICAL}
                        [/specials]
                        icon=attacks/fireball.png
                        damage=8
                        number=4
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=sceptre of fire
                        increase_damage=3
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=sceptre of fire
                            [/filter_attack]
                            {MISSILE_FRAME_FIREBALL_XY -16 -21}
                            start_time=-300
                            [frame]
                                sound=fire.wav
                                duration=200
                            [/frame]
                        [/attack_anim]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 2 _"Cloning Circle" "scenery/summoning-center.png~BLEND(0,255,0,0.5)" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(0,255,0,1):150" _"Summoned an identical copy of $|unit.name|" (
                [sound]
                    name=magic-faeriefire.ogg
                [/sound]
                [store_unit]
                   [filter]
                       id=$|unit.id
                   [/filter]
                   variable=tmp_cloned_unit
                   kill=no
                [/store_unit]
                [unstore_unit]
                   variable=tmp_cloned_unit
                   find_vacant=yes
                [/unstore_unit]
                {CLEAR_VARIABLE tmp_cloned_unit}
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 3 _"Lightbringer" "items/sword-holy.png" "halo/illuminates-aura.png" _"The Lightbringer is an ancient paladin sword, capable of slicing through any unholy abominations with ease. Wielding this holy blade also grants the following passive benefits:
- illuminates ability
- alignment is set to lawful
- +30% arcane resistance" (
                [sound]
                    name={SOUND_LIST:HOLY}
                [/sound]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=lightbringer
                        description=_"lightbringer"
                        icon=attacks/sword-holy.png
                        type=arcane
                        range=melee
                        [specials]
                            {WEAPON_SPECIAL_MAGICAL}
                        [/specials]
                        damage=8
                        number=3
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=lightbringer
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=lightbringer
                            [/filter_attack]
                        
                            start_time=-200
                        
                            [frame]
                            duration=300
                            sound={SOUND_LIST:HOLY_MISS}
                            [/frame]
                        
                            {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                        [/attack_anim]
                    [/effect]
                    [effect]
                        apply_to=alignment
                        set=lawful
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_ILLUMINATES}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=halo
                        halo="halo/illuminates-aura.png"
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            arcane=-30
                        [/resistance]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 4 _"Necronomicon" "items/book5.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(0,0,0,1):150" _"When a living unit (either ally or enemy) dies in a 2-tile radius from this unit, they are revived as a soul thrall of the resurrecting unit's side. Soul thralls have -40% damage/max hitpoints/exp/max exp, their level is reduced by 1, and the alignment changes to chaotic." (
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=battle_royale_necronomicon
                                name=_"necronomicon"
                                description= _"When a living unit (either ally or enemy) dies in a 2-tile radius from this unit, they are revived as a soul thrall of the resurrecting unit's side. Soul thralls have -40% damage/max hitpoints/exp/max exp, their level is reduced by 1, and the alignment changes to chaotic. If a dying unit is the radius of both an ally and enemy unit with this ability, the ally takes priority."
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 5 _"Big Lootbox" "items/box.png~SCALE(108,108)~CROP(17,29,72,72)" () _"The lootbox drops five random items next to is tile - they can be common, rare, or even legendary!" (

                    {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED 5 $|x1 $|y1 (
#                        [chat]
#                            message="$this_item.x|,$this_item.y|"
#                        [/chat]
#                        [chat]
#                            message="$|this_item.x|,$|this_item.y|"
#                        [/chat]
                        {VARIABLE_OP tmp_lootbox_type_rand rand 1..10}
                        {IF_VAR tmp_lootbox_type_rand equals 1 (
                        [then]
                            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                        [/then]
                        [elseif]
                            {VARIABLE_CONDITIONAL tmp_lootbox_type_rand less_than_equal_to 3}
                            [then]
                            {BATTLE_ROYALE_SPAWN_ITEM_RARE $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                            [/then]
                        [/elseif]
                        [else]
                            {BATTLE_ROYALE_SPAWN_ITEM_COMMON $|tmp_unoccupied_item.x $|tmp_unoccupied_item.y}
                        [/else]
                        )}
                        {CLEAR_VARIABLE tmp_lootbox_type_rand}
                    )}

                )}

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 6 _"Phoenix's Heart" "items/ball-magenta.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(255,0,0,1):150" _"On death, you revive once with full hitpoints (but if you pick up multiple phoenix hearts you can revive multiple times). +20% fire resistance. Does NOT protect from dying to the void." (
                [sound]
                    name=fire.wav
                [/sound]
                [modify_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    {VARIABLE_OP battleroyale_phoenixrevives add 1}
                [/modify_unit]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            fire=-20
                        [/resistance]
                    [/effect]
                [/object]
                )}

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 7 _"All-seeing Eye" "items/ball-blue.png" "halo/misc/leadership-flare-[1~13].png:50" _"All your attacks gain 30% chance to hit (including weapons picked up after this item), and your vision range is massively increased." (
                [sound]
                    name=magic-faeriefire-miss.ogg
                [/sound]
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=vision
                        set=99
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [chance_to_hit]
                                id=battle_royale_all_seeing_eye
                                name=_"all seeing eye"
                                description=_"All attacks gain 30% more chance to hit."
                                add=30
                            [/chance_to_hit]
                        [/abilities]
                    [/effect]
                [/object]
                [redraw]
                    clear_shroud=yes
                [/redraw]
                )}

                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 8 _"Ring of Fury" "items/ring-red.png" "halo/misc/leadership-flare-[1~13].png~BLEND(255,0,0,1):50" _"You can attack 1 more time per turn (including different targets). Your moves and attacks are restored for this turn." (
                [object]
                    duration=forever
                    silent=yes
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=max_attacks
                        increase=1
                    [/effect]
                [/object]
                [heal_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    restore_attacks=yes
                    restore_statuses=no
                    moves=full
                [/heal_unit]
                )}

            [/switch]
[/event]
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_COMMON NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| common items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
                [or]
                    find_in=battle_royale_loot_tiles#to ensure items can't accidentally spawn on the same tile
                [/or]
            [/not]
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_COMMON $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_RARE NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| rare items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
                [or]
                    find_in=battle_royale_loot_tiles#to ensure items can't accidentally spawn on the same tile
                [/or]
            [/not]
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_RARE $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| legendary items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
                [or]
                    find_in=battle_royale_loot_tiles#to ensure items can't accidentally spawn on the same tile
                [/or]
            [/not]
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef


#define BATTLE_ROYALE_SHRINK_MAP TURN_WARN TURN RADIUS
[event]
    name=turn {TURN_WARN}
    delayed_variable_substitution=no
    [terrain]
        [not]
            x,y=$($map_size.width|/2),$($map_size.height|/2)
            radius={RADIUS}
        [/not]
        [not]
            terrain=Xv
        [/not]
        terrain=Ur^Efm
        layer=both
    [/terrain]
    [sound]
        name=rumble.ogg
    [/sound]
[/event]
[event]
    name=turn {TURN}
    delayed_variable_substitution=no
    [terrain]
        [not]
            x,y=$($map_size.width|/2),$($map_size.height|/2)
            radius={RADIUS}
        [/not]
        terrain=Xv
        layer=both
    [/terrain]
    [sound]
        name=magic-dark-big.ogg
    [/sound]

#clear all items on void

#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$|battle_royale_loot_tiles.length
    [/variable]
    [do]
#        [chat]
#            message="while loop"
#        [/chat]
#        [chat]
#            message="$|battle_royale_loot_tiles[$|c].x|,$|battle_royale_loot_tiles[$|c].y|"
#        [/chat]
        [if]
        [have_location]
            x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            terrain=Xv
        [/have_location]
        [then]
            [remove_item]
                x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            [/remove_item]
            [label]
                text=""
                x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            [/label]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$|c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        [/if]
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}
    [kill]
        [filter_location]
            terrain=Xv
        [/filter_location]
        animate=yes
        fire_event=yes
    [/kill]
[/event]
#enddef

#define BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC
[event]
    name=start
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
    [then]

    {VARIABLE max_radius "$(($map_size.width| + $map_size.height|) / 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 2 "$($max_radius)"}
#    {BATTLE_ROYALE_SHRINK_MAP 3 "$($max_radius - 2)"}
#    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius - 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 5 "$($max_radius - 6)"}
    [event]
        name=turn 2
        [chat]
            speaker="Battle Royale"
            message="WARNING: the map will start shrinking every two turns at turn 4, stay away from the edge of the map or you'll get killed!"
        [/chat]        
    [/event]

    {BATTLE_ROYALE_SHRINK_MAP 3 4 "$($max_radius)"}
    {BATTLE_ROYALE_SHRINK_MAP 5 6 "$($max_radius * 0.9)"}
    {BATTLE_ROYALE_SHRINK_MAP 7 8 "$($max_radius * 0.8)"}
    {BATTLE_ROYALE_SHRINK_MAP 9 10 "$($max_radius * 0.7)"}
    {BATTLE_ROYALE_SHRINK_MAP 11 12 "$($max_radius * 0.6)"}
    {BATTLE_ROYALE_SHRINK_MAP 13 14 "$($max_radius * 0.5)"}
    {BATTLE_ROYALE_SHRINK_MAP 15 16 "$($max_radius * 0.4)"}
    {BATTLE_ROYALE_SHRINK_MAP 17 18 "$($max_radius * 0.3)"}
    [/then]
    [/if]
[/event]
#enddef

#define BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC_MORE_FORGIVING
[event]
    name=start
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
    [then]

    {VARIABLE max_radius "$(($map_size.width| + $map_size.height|) / 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 2 "$($max_radius)"}
#    {BATTLE_ROYALE_SHRINK_MAP 3 "$($max_radius - 2)"}
#    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius - 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 5 "$($max_radius - 6)"}
    [event]
        name=turn 2
        [chat]
            speaker="Battle Royale"
            message="WARNING: the map will start shrinking every two turns at turn 4, stay away from the edge of the map or you'll get killed!"
        [/chat]        
    [/event]

    {BATTLE_ROYALE_SHRINK_MAP 3 4 "$($max_radius * 1.15)"}
    {BATTLE_ROYALE_SHRINK_MAP 5 6 "$($max_radius)"}
    {BATTLE_ROYALE_SHRINK_MAP 7 8 "$($max_radius * 0.9)"}
    {BATTLE_ROYALE_SHRINK_MAP 9 10 "$($max_radius * 0.8)"}
    {BATTLE_ROYALE_SHRINK_MAP 11 12 "$($max_radius * 0.7)"}
    {BATTLE_ROYALE_SHRINK_MAP 13 14 "$($max_radius * 0.6)"}
    {BATTLE_ROYALE_SHRINK_MAP 15 16 "$($max_radius * 0.5)"}
    {BATTLE_ROYALE_SHRINK_MAP 17 18 "$($max_radius * 0.4)"}
    {BATTLE_ROYALE_SHRINK_MAP 19 20 "$($max_radius * 0.3)"}
    [/then]
    [/if]
[/event]
#enddef

#define BATTLE_ROYALE_SPAWNENEMEIES TURN NUMBER TYPE
    [event]
       name=side turn {TURN}
       [filter_condition]
            {VARIABLE_CONDITIONAL side_number equals $battle_royale_enemyside}
       [/filter_condition]
        {SCATTER_UNITS {NUMBER} {TYPE} 2 (

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                terrain=_off^_usr,Q*,W*,*^X*,X*,*^V*,Ce*,Ch,Ch*,Cv*,Co*,Cu*,Ct*#,K*
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=$battle_royale_enemyside
            generate_name=yes
            random_traits=yes
            placement=map
            passable=yes
        )}
    [/event]
#enddef

#define BATTLE_ROYALE_SIDES
    [side]
        side=1
        team_name=1
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=9
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
        hidden=yes
        no_leader=yes
        color=teal

        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYLAE_BOT_SIDE NUM
    [side]
        side={NUM}
        team_name={NUM}
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
        controller=ai
        controller_lock=yes
        color=battle_royale_yellow
        x,y=1,1
        placement=map
        passable=yes
    [/side]
#enddef

#define BATTLE_ROYALE_SIDES_20
    [side]
        side=1
        team_name=1
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    #bot-locked sides:
    {BATTLE_ROYLAE_BOT_SIDE 9}
    {BATTLE_ROYLAE_BOT_SIDE 10}
    {BATTLE_ROYLAE_BOT_SIDE 11}
    {BATTLE_ROYLAE_BOT_SIDE 12}
    {BATTLE_ROYLAE_BOT_SIDE 13}
    {BATTLE_ROYLAE_BOT_SIDE 14}
    {BATTLE_ROYLAE_BOT_SIDE 15}
    {BATTLE_ROYLAE_BOT_SIDE 16}
    {BATTLE_ROYLAE_BOT_SIDE 17}
    {BATTLE_ROYLAE_BOT_SIDE 18}
    {BATTLE_ROYLAE_BOT_SIDE 19}
    [side]
        side=20
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
        hidden=yes
        no_leader=yes
        color=teal
        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYALE_SIDES_40
    [side]
        side=1
        team_name=1
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    #bot-locked sides:
    {BATTLE_ROYLAE_BOT_SIDE 9}
    {BATTLE_ROYLAE_BOT_SIDE 10}
    {BATTLE_ROYLAE_BOT_SIDE 11}
    {BATTLE_ROYLAE_BOT_SIDE 12}
    {BATTLE_ROYLAE_BOT_SIDE 13}
    {BATTLE_ROYLAE_BOT_SIDE 14}
    {BATTLE_ROYLAE_BOT_SIDE 15}
    {BATTLE_ROYLAE_BOT_SIDE 16}
    {BATTLE_ROYLAE_BOT_SIDE 17}
    {BATTLE_ROYLAE_BOT_SIDE 18}
    {BATTLE_ROYLAE_BOT_SIDE 19}
    {BATTLE_ROYLAE_BOT_SIDE 20}
    {BATTLE_ROYLAE_BOT_SIDE 21}
    {BATTLE_ROYLAE_BOT_SIDE 22}
    {BATTLE_ROYLAE_BOT_SIDE 23}
    {BATTLE_ROYLAE_BOT_SIDE 24}
    {BATTLE_ROYLAE_BOT_SIDE 25}
    {BATTLE_ROYLAE_BOT_SIDE 26}
    {BATTLE_ROYLAE_BOT_SIDE 27}
    {BATTLE_ROYLAE_BOT_SIDE 28}
    {BATTLE_ROYLAE_BOT_SIDE 29}
    {BATTLE_ROYLAE_BOT_SIDE 30}
    {BATTLE_ROYLAE_BOT_SIDE 31}
    {BATTLE_ROYLAE_BOT_SIDE 32}
    {BATTLE_ROYLAE_BOT_SIDE 33}
    {BATTLE_ROYLAE_BOT_SIDE 34}
    {BATTLE_ROYLAE_BOT_SIDE 35}
    {BATTLE_ROYLAE_BOT_SIDE 36}
    {BATTLE_ROYLAE_BOT_SIDE 37}
    {BATTLE_ROYLAE_BOT_SIDE 38}
    {BATTLE_ROYLAE_BOT_SIDE 39}
    [side]
        side=40
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
#        hidden=yes
        no_leader=yes
        color=teal
        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYALE_SIDES_100
    [side]
        side=1
        team_name=1
        user_team_name=_""
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name=_""
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    #bot-locked sides:
    {BATTLE_ROYLAE_BOT_SIDE 9}
    {BATTLE_ROYLAE_BOT_SIDE 10}
    {BATTLE_ROYLAE_BOT_SIDE 11}
    {BATTLE_ROYLAE_BOT_SIDE 12}
    {BATTLE_ROYLAE_BOT_SIDE 13}
    {BATTLE_ROYLAE_BOT_SIDE 14}
    {BATTLE_ROYLAE_BOT_SIDE 15}
    {BATTLE_ROYLAE_BOT_SIDE 16}
    {BATTLE_ROYLAE_BOT_SIDE 17}
    {BATTLE_ROYLAE_BOT_SIDE 18}
    {BATTLE_ROYLAE_BOT_SIDE 19}
    {BATTLE_ROYLAE_BOT_SIDE 20}
    {BATTLE_ROYLAE_BOT_SIDE 21}
    {BATTLE_ROYLAE_BOT_SIDE 22}
    {BATTLE_ROYLAE_BOT_SIDE 23}
    {BATTLE_ROYLAE_BOT_SIDE 24}
    {BATTLE_ROYLAE_BOT_SIDE 25}
    {BATTLE_ROYLAE_BOT_SIDE 26}
    {BATTLE_ROYLAE_BOT_SIDE 27}
    {BATTLE_ROYLAE_BOT_SIDE 28}
    {BATTLE_ROYLAE_BOT_SIDE 29}
    {BATTLE_ROYLAE_BOT_SIDE 30}
    {BATTLE_ROYLAE_BOT_SIDE 31}
    {BATTLE_ROYLAE_BOT_SIDE 32}
    {BATTLE_ROYLAE_BOT_SIDE 33}
    {BATTLE_ROYLAE_BOT_SIDE 34}
    {BATTLE_ROYLAE_BOT_SIDE 35}
    {BATTLE_ROYLAE_BOT_SIDE 36}
    {BATTLE_ROYLAE_BOT_SIDE 37}
    {BATTLE_ROYLAE_BOT_SIDE 38}
    {BATTLE_ROYLAE_BOT_SIDE 39}
    {BATTLE_ROYLAE_BOT_SIDE 40}
    {BATTLE_ROYLAE_BOT_SIDE 41}
    {BATTLE_ROYLAE_BOT_SIDE 42}
    {BATTLE_ROYLAE_BOT_SIDE 43}
    {BATTLE_ROYLAE_BOT_SIDE 44}
    {BATTLE_ROYLAE_BOT_SIDE 45}
    {BATTLE_ROYLAE_BOT_SIDE 46}
    {BATTLE_ROYLAE_BOT_SIDE 47}
    {BATTLE_ROYLAE_BOT_SIDE 48}
    {BATTLE_ROYLAE_BOT_SIDE 49}
    {BATTLE_ROYLAE_BOT_SIDE 50}
    {BATTLE_ROYLAE_BOT_SIDE 51}
    {BATTLE_ROYLAE_BOT_SIDE 52}
    {BATTLE_ROYLAE_BOT_SIDE 53}
    {BATTLE_ROYLAE_BOT_SIDE 54}
    {BATTLE_ROYLAE_BOT_SIDE 55}
    {BATTLE_ROYLAE_BOT_SIDE 56}
    {BATTLE_ROYLAE_BOT_SIDE 57}
    {BATTLE_ROYLAE_BOT_SIDE 58}
    {BATTLE_ROYLAE_BOT_SIDE 59}
    {BATTLE_ROYLAE_BOT_SIDE 60}
    {BATTLE_ROYLAE_BOT_SIDE 61}
    {BATTLE_ROYLAE_BOT_SIDE 62}
    {BATTLE_ROYLAE_BOT_SIDE 63}
    {BATTLE_ROYLAE_BOT_SIDE 64}
    {BATTLE_ROYLAE_BOT_SIDE 65}
    {BATTLE_ROYLAE_BOT_SIDE 66}
    {BATTLE_ROYLAE_BOT_SIDE 67}
    {BATTLE_ROYLAE_BOT_SIDE 68}
    {BATTLE_ROYLAE_BOT_SIDE 69}
    {BATTLE_ROYLAE_BOT_SIDE 70}
    {BATTLE_ROYLAE_BOT_SIDE 71}
    {BATTLE_ROYLAE_BOT_SIDE 72}
    {BATTLE_ROYLAE_BOT_SIDE 73}
    {BATTLE_ROYLAE_BOT_SIDE 74}
    {BATTLE_ROYLAE_BOT_SIDE 75}
    {BATTLE_ROYLAE_BOT_SIDE 76}
    {BATTLE_ROYLAE_BOT_SIDE 77}
    {BATTLE_ROYLAE_BOT_SIDE 78}
    {BATTLE_ROYLAE_BOT_SIDE 79}
    {BATTLE_ROYLAE_BOT_SIDE 80}
    {BATTLE_ROYLAE_BOT_SIDE 81}
    {BATTLE_ROYLAE_BOT_SIDE 82}
    {BATTLE_ROYLAE_BOT_SIDE 83}
    {BATTLE_ROYLAE_BOT_SIDE 84}
    {BATTLE_ROYLAE_BOT_SIDE 85}
    {BATTLE_ROYLAE_BOT_SIDE 86}
    {BATTLE_ROYLAE_BOT_SIDE 87}
    {BATTLE_ROYLAE_BOT_SIDE 88}
    {BATTLE_ROYLAE_BOT_SIDE 89}
    {BATTLE_ROYLAE_BOT_SIDE 90}
    {BATTLE_ROYLAE_BOT_SIDE 91}
    {BATTLE_ROYLAE_BOT_SIDE 92}
    {BATTLE_ROYLAE_BOT_SIDE 93}
    {BATTLE_ROYLAE_BOT_SIDE 94}
    {BATTLE_ROYLAE_BOT_SIDE 95}
    {BATTLE_ROYLAE_BOT_SIDE 96}
    {BATTLE_ROYLAE_BOT_SIDE 97}
    {BATTLE_ROYLAE_BOT_SIDE 98}
    {BATTLE_ROYLAE_BOT_SIDE 99}
    [side]
        side=100
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
#        hidden=yes
        no_leader=yes
        color=teal
        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYALE_EVENTS ENEMYSIDE
    [event]
        name=start
        [objectives]
            [objective]
                description= _ "Eliminate all other leaders"
                show_turn_counter=yes
                condition=win
            [/objective]
            [objective]
                description= _ "Death of your leader"
                condition=lose
            [/objective]
            [note]
                description=_"There are various items scattered across the map, which provides powerful buffs when stepped on. Additionally, killed side $battle_royale_enemyside| enemies drop an item (stronger enemies drop rarer loot, level 0 enemies drop nothing. However, there is a 1 in 5 chance for enemies to drop loot from one level higher than their own)"
                [show_if]
                    {VARIABLE_CONDITIONAL battleroyale_noloot not_equals yes}
                [/show_if]
            [/note]
            [note]
                description=_"Items have three different rarities shown by their color - <span color='#6464ff'>Common</span>, <span color='#c800ff'>Rare</span> and <span color='#ffff00'>Legendary</span>"
                [show_if]
                    {VARIABLE_CONDITIONAL battleroyale_noloot not_equals yes}
                [/show_if]
            [/note]
            [note]
                description=_"Starting at turn 4, the map will shrink every two turns. The map shrinks in a hexagonal shape, so corners are erased first."
                [show_if]
                    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
                [/show_if]
            [/note]
            [note]
                description=_"Dead leaders eventually turn into side $battle_royale_enemyside| ghosts"
                [show_if]
                    {VARIABLE_CONDITIONAL battleroyale_noghost not_equals yes}
                [/show_if]
            [/note]
            delayed_variable_substitution=yes
        [/objectives]
    [/event]
    [event]
       name=prestart
        [store_unit]
                [filter]
                canrecruit=yes
                [/filter]
                variable=contestants
                kill=no
        [/store_unit]
        [store_map_dimensions]
        [/store_map_dimensions]
        {VARIABLE battle_royale_enemyside {ENEMYSIDE}}
        {FOREACH contestants i}

        {VARIABLE_OP teleportx rand 1..$map_size.width}
        {VARIABLE_OP teleporty rand 1..$map_size.height}
        {TELEPORT_UNIT id=$contestants[$i].id $teleportx $teleporty}
        {NEXT i}
        {CLEAR_VARIABLE contestants}
        {CLEAR_VARIABLE teleportx}
        {CLEAR_VARIABLE teleporty}
        [store_map_dimensions]
        [/store_map_dimensions]
        {VARIABLE tmp_ai_index 1}
        [while]
            {VARIABLE_CONDITIONAL tmp_ai_index less_than_equal_to {ENEMYSIDE}}
            [do]
                {BATTLE_ROYALE_MICROAI $tmp_ai_index {ENEMYSIDE}}
                {VARIABLE_OP tmp_ai_index add 1}
            [/do]
        [/while]
        [micro_ai]
            side=9
#            ai_type=hang_out
            ai_type=goto
            action=add
            id=battleroyale_movetocenter_when_near_void_enemy
            [filter]
##commented out, so that spawned allies also flee from void
##                canrecruit=yes
#            [filter_location]
#            [not]
#                x,y=$($map_size.width|/2),$($map_size.height|/2)
#                radius=5
#            [/not]
#            [and]
#                terrain=Xv
#                radius=4
#            [/and]
#            [/filter_location]
            [filter_location]
                terrain=Ur^Efm
            [/filter_location]
            [/filter]
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=2
            [/filter_location]
            ca_score=195000#very high CA score, as fleeing from the void is more important than combat/items
            unique_goals=no
            remove_movement=no
        [/micro_ai]

#        {BATTLE_ROYALE_MICROAI 1 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 2 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 3 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 4 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 5 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 6 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 7 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 8 {ENEMYSIDE}}
#        {BATTLE_ROYALE_MICROAI 9 {ENEMYSIDE}}
        {CLEAR_VARIABLE tmp_ai_index}
    [/event]
    [event]
        name=start
        id=battleroyale_leader_quick_buff
        #gives leaders with less than 6 moves (except units with 0 moves just in case to avoid breaking other add-ons) the quick trait to make them more viable:

        [modify_unit]
            [filter]
                canrecruit=yes
                formula="max_moves < 6"
            [/filter]
            {TRAIT_QUICK}
        [/modify_unit]
        #hacky workaround in case the side 1 gains the extra move
        [heal_unit]
            [filter]
                canrecruit=yes
                formula="moves < max_moves"
            [/filter]
            moves=full
            animate=no
        [/heal_unit]
    [/event]
    [event]
       name=die
       id=battleroyale_fogclear_event
       first_time_only=no
       [if]
       [have_unit]
            side=$unit.side
            [not]
                [filter_location]
                    terrain=Xv
                [/filter_location]
            [/not]
       [/have_unit]
       [else]
       [modify_side]
            side=$unit.side
            fog=no
       [/modify_side]
       [redraw]
           clear_shroud=yes
       [/redraw]
       [/else]
       [/if]
    [/event]
    [event]
       name=die
       id=battleroyale_elimination_event
       first_time_only=no
       [filter]
         canrecruit=yes
       [/filter]
       #TODO: maybe only show the elimination message once all leaders are dead
       [if]
       [have_unit]
        id=$second_unit.id
        canrecruit=yes
       [not]
        side={ENEMYSIDE}
       [/not]
       [/have_unit]
       [and]
       [not]
       [have_unit]
        id=$unit.id
        terrain=Xv
       [/have_unit]        
       [/not]
       [/and]
       [then]
       [chat]
       speaker="Battle Royale"
       message="$second_unit.name| eliminated $unit.name|"
       [/chat]
       [/then]
       [elseif]
       [have_unit]
        id=$unit.id
        terrain=Xv
       [/have_unit]
       [then]
       [chat]
       speaker="Battle Royale"
       message="$unit.name| has been consumed by the void at the map border"
       [/chat]
       [/then]
       [/elseif]
       [else]
       [chat]
       speaker="Battle Royale"
       message="$unit.name| has been eliminated"
       [/chat]
       [/else]
       [/if]
       {IF_VAR battleroyale_noghost not_equals yes (
       [then]
       [store_unit]
                [filter]
                x,y=$x1,$y1
                [not]
                   race=undead
                [/not]
                [/filter]
                variable=contestant_ghost
                kill=no
                mode=append
        [/store_unit]
        [/then])}
    [/event]
    [event]
        #using turn refresh, so ghosts spawn AFTER map shrinks
        name=turn refresh
        first_time_only=no
        [if]
        {VARIABLE_CONDITIONAL turn_number greater_than_equal_to $battle_royale_ghostturn}
        [then]
        [foreach]
           array=contestant_ghost
           index_var=i
           [do]

       {VARIABLE this_item.side {ENEMYSIDE}}
#       {VARIABLE_OP this_item.max_hitpoints multiply 0.8}
       {VARIABLE this_item.hitpoints $this_item.max_hitpoints}
       {VARIABLE this_item.race undead}
       {VARIABLE this_item.canrecruit no}

        [random_placement]
             num_items=1
             variable=random_placement_location
             allow_less=yes
             min_distance=0
             [filter_location]
                 include_borders=no
                 [not]
                     terrain=X*,Q*,W*,_off^_usr
                 [/not]
             [/filter_location]
             [command]
                {VARIABLE this_item.x $random_placement_location.x}
                {VARIABLE this_item.y $random_placement_location.y}
             [/command]
        [/random_placement]

        {CLEAR_VARIABLE random_placement_location}
       [unstore_unit]
            variable=this_item
            find_vacant=yes
       [/unstore_unit]
       [object]
        silent=yes
        duration=forever
        [filter]
           id=$this_item.id
        [/filter]
        [effect]
           apply_to=image_mod
           add="~O(60%)~CS(-20,-70,0)"
        [/effect]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                arcane=30#arcane resistance nerf for realism, since they are undead
            [/resistance]
        [/effect]
       [/object]
       [modify_unit]
        [filter]
           id=$this_item.id
        [/filter]
        {TRAIT_UNDEAD}
       [/modify_unit]
       [sound]
            name=wail.wav
       [/sound]
       [delay]
            time=200
       [/delay]
           [/do]
        [/foreach]
       {CLEAR_VARIABLE contestant_ghost}
        [/then]
        [/if]
    [/event]
#now configured in scenario files
#    {BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC}
    [event]
        name=start
        id=battleroyale_scatteritems

        {IF_VAR battleroyale_noloot not_equals yes (
        [then]

        #calculate the area of the map, distribute the number of items accordingly
        {VARIABLE br_map_area "$($map_size.width| * $map_size.height|)"}

        {VARIABLE br_tmp_loot "$($br_map_area| * (6 + ({ENEMYSIDE}) / 3 ) / 9)"}#the more sides there is, the higher loot chance, but it scales somewhat slowly
        {VARIABLE br_tmp_loot "$($br_tmp_loot| / 80)"} 

#        {BATTLE_ROYALE_SCATTER_ITEMS_COMMON "$($br_map_area / 80)"}
#        {BATTLE_ROYALE_SCATTER_ITEMS_RARE "$($br_map_area / 240)"}
#        {BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY "$(1 + $br_map_area / 900)"}
        {BATTLE_ROYALE_SCATTER_ITEMS_COMMON "$($br_tmp_loot|)"}
        {BATTLE_ROYALE_SCATTER_ITEMS_RARE "$($br_tmp_loot| / 3)"}
        {BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY "$(1 + $br_tmp_loot| / 11)"}

        {CLEAR_VARIABLE br_map_area}

        {CLEAR_VARIABLE br_tmp_loot}

        [/then]
        )}
    [/event]
    {BATTLE_ROYALE_ITEM_SPAWN_EVENTS}
[event]
    name=die
    id=battle_royale_necronomicon_event
    first_time_only=no
    [filter]
        [not]
            [filter_wml]
                [status]
                    not_living="yes"
                [/status]
            [/filter_wml]
        [/not]
        [filter_location]
            [filter]
                ability=battle_royale_necronomicon
#            [filter_side]
#            [allied_with]
#                side=$unit.side
#            [/allied_with]
#            [/filter_side]
            [not]
                id=$unit.id #to prevent the unit from self-reviving
            [/not]
            [/filter]
            radius=2
        [/filter_location]
    [/filter]

    #workaround to make loot drop even from enemies killed with necronomicon

    [fire_event]
        id=battleroyale_deathloot_event
        [primary_unit]
            x,y=$x1,$y1
        [/primary_unit]
    [/fire_event]

#do several different [store_unit]s by priority: if there is a resurrecter of same side, use him, if not, check if there is an ally resurrecter, if not, pick any including enemy

    [store_unit]
        [filter]
            side=$unit.side
            ability=battle_royale_necronomicon
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]

    {IF_VAR battle_royale_necronomiconer.length greater_than 0 (
    [else]
    [store_unit]
        [filter]
            ability=battle_royale_necronomicon
            [filter_side]
            [allied_with]
                side=$unit.side
            [/allied_with]
            [/filter_side]
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]
    [/else]
    )}

    {IF_VAR battle_royale_necronomiconer.length greater_than 0 (
    [else]
    [store_unit]
        [filter]
            ability=battle_royale_necronomicon
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]
    [/else]
    )}

    [if]
    [have_unit]
        id=$battle_royale_necronomiconer[0].id
    [/have_unit]
    [then]

    [sound]
        name=magic-dark-big.ogg
    [/sound]

    {VARIABLE unit.side $battle_royale_necronomiconer[0].side}
    {IF_VAR unit.level greater_than 0 (
    [then]
    {VARIABLE_OP unit.level sub 1}
    [/then]
    )}
    [unstore_unit]
        variable=unit
        find_vacant=no
    [/unstore_unit]

    [modify_unit]
        [filter]
            id=$unit.id
            [not]
                trait=undead
            [/not]
        [/filter]
        {TRAIT_UNDEAD}
    [/modify_unit]

        [heal_unit]
            [filter]
                id=$unit.id
            [/filter]
            amount=full
            animate=no
            restore_statuses=yes
        [/heal_unit]

    [object]
        silent=yes
        duration=forever

        [filter]
            id=$unit.id
        [/filter]

        [effect]
            apply_to=hitpoints
            increase=-40%
            increase_total=-40%
        [/effect]        

        [effect]
            apply_to=attack
            increase_damage=-40%
        [/effect]

        [effect]
            apply_to=new_ability
            [abilities]
                [dummy]
                    id=battle_royale_shade#for reducing level on post advance
                [/dummy]
            [/abilities]
        [/effect]

        [effect]
            apply_to=alignment
            set=chaotic
        [/effect]

        [effect]
            apply_to=image_mod
            add="~GS()~BLEND(125,0,125,0.4)~O(50%)"
        [/effect]

        [effect]
            apply_to=experience
            increase=-40%
        [/effect]

        [effect]
            apply_to=max_experience
            increase=-40%
        [/effect]

    [/object]

    [/then]
    [/if]

    {CLEAR_VARIABLE battle_royale_necronomiconer}
[/event]
#event to ensure amlas don't reduce soul level
[event]
    name=pre advance
    id=battle_royale_necronomicon_shade_reduce_level_pre
    first_time_only=no
    [filter]
        ability=battle_royale_shade
        [not]
            [filter_wml]
                advances_to=""
            [/filter_wml]
        [/not]
    [/filter]
    {VARIABLE tmp_battle_royale_reduce_soul_level yes}
[/event]
#reduces shade level by 1 during post advance, as variable changes don't persist on levelup:
[event]
    name=post advance
    id=battle_royale_necronomicon_shade_reduce_level
    first_time_only=no
    [filter]
        ability=battle_royale_shade
    [/filter]

    {IF_VAR unit.level greater_than 0 (
    [and]
    {VARIABLE_CONDITIONAL tmp_battle_royale_reduce_soul_level equals yes}
    [/and]
    [then]
    {VARIABLE_OP unit.level sub 1}
    [/then]
    )}

    [unstore_unit]
        variable=unit
        find_vacant=no
    [/unstore_unit]

    {CLEAR_VARIABLE tmp_battle_royale_reduce_soul_level}
[/event]
[event]
    name=last breath
    id=battle_royale_phoenixheart_event
    first_time_only=no
    [filter]
        [filter_location]
            terrain=Xv#the phoenix heart does not save players from void
        [/filter_location]
    [/filter]
    {IF_VAR unit.variables.battleroyale_phoenixrevives greater_than 0 (
    [then]
        [modify_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            {VARIABLE_OP battleroyale_phoenixrevives sub 1}
        [/modify_unit]
        [floating_text]
           x,y=$x1,$y1
           text=_"<span color='#00ff00'>revived</span>"
        [/floating_text]
        {IF_VAR unit.variables.battleroyale_phoenixrevives greater_than 0 (
        [then]
        [delay]
            time=150
        [/delay]
        [floating_text]
           x,y=$x1,$y1
           text=_"$unit.variables.battleroyale_phoenixrevives| revives left"
        [/floating_text]
        [/then]
        )}
        [heal_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=full
            animate=yes
        [/heal_unit]
    [/then]
    )}
[/event]
{BATTLE_ROYALE_ITEMDROP_EVENTS}
#enddef

#define BATTLE_ROYALE_ITEMDROP_EVENTS
[event]
    name=die
    id=battleroyale_deathloot_event
    first_time_only=no
    [filter]
        side=$battle_royale_enemyside
        #enemies killed by void do not drop items
        [not]
        [filter_location]
            terrain=Xv
        [/filter_location]
        [/not]
    [/filter]
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noloot not_equals yes}
    [then]
    {VARIABLE tmp_loot_level $unit.level}

    {VARIABLE_OP tmp_br_bonus_loot rand 1..5}
    {IF_VAR tmp_br_bonus_loot equals 1 (
    [then]
        {VARIABLE_OP tmp_loot_level add 1}
        [sound]
            name={SOUND_LIST:HOLY}
        [/sound]
        [floating_text]
           x,y=$x1,$y1
           text=_"<span color='#ffff00'>bonus loot!</span>"
        [/floating_text]
    [/then]
    )}
    {CLEAR_VARIABLE tmp_br_bonus_loot}


    [switch]
        variable=tmp_loot_level
        [case]
            value=0
            #no loot unless a player gets lucky and successfully for bonus loot, in which case drops a common item
        [/case]
        [case]
            value=1
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_COMMON $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=2
#            {BATTLE_ROYALE_SPAWN_ITEM_RARE $x1 $y1}
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_RARE $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=3
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=4
#            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $x1 $y1}
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 1 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_RARE $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=5
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 2 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
        [case]
            value=6
            {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT 3 $x1 $y1 (
                    {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $tmp_unoccupied_item.x $tmp_unoccupied_item.y}
            )}
        [/case]
    [/switch]
    {CLEAR_VARIABLE tmp_loot_level}
    [/then]
    [/if]
[/event]

[event]
    name=die
    id=battleroyale_deathfragment_event
    first_time_only=no
    [filter]
        [not]
        [filter_location]
            terrain=Xv
        [/filter_location]
        [/not]
    [/filter]
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noloot not_equals yes}
    [and]
        {VARIABLE_CONDITIONAL unit.variables.battleroyale_fragments greater_than 0}
    [/and]
    [then]
        {BATTLE_ROYALE_PLACE_ITEM_ON_UNOCCUPIED_ALT $unit.variables.battleroyale_fragments $x1 $y1 (
            {BATTLE_ROYALE_SPAWN_ITEM_SPECIFIC_COMMON $tmp_unoccupied_item.x $tmp_unoccupied_item.y 11}#spawns one fragment
        )}
    [/then]
    [/if]
[/event]
#enddef
