#textdomain wesnoth-multiplayer

#change between human/ai for testing

#define BATTLE_ROYALE_CONTROLLER
human#enddef

#define BATTLE_ROYALE_SIDE_SETTINGS
        gold=50
        income=-2
        village_gold=1
        [ai]
        leader_ignores_keep=yes
        aggression=1.0

    [goal]
        [criteria]
            canrecruit=yes
        [/criteria]
        value=25
    [/goal]
        village_value=0.1
        [/ai]        
#enddef

#define BATTLE_ROYALE_MICROAI SIDE
        [micro_ai]
            side={SIDE}
            ai_type=hang_out
            action=add
            id=battleroyale_movetocenter
            [filter]
                canrecruit=yes
            [filter_location]
            [not]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=5
            [/not]
            [/filter_location]
            [/filter]
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=2
            [/filter_location]
        [/micro_ai]
        [micro_ai]
            side={SIDE}
            ai_type=hang_out
            action=add
            id=battleroyale_chaseenemy
            [filter]
                canrecruit=yes
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=5
            [/filter_location]
            [/filter]
            [filter_location]
            [filter]
            canrecruit=yes
            [filter_side]
            [enemy_of]
            side={SIDE}
            [/enemy_of]
            [/filter_side]
            [/filter]
            [/filter_location]
        [/micro_ai]
#enddef

#define BATTLE_ROYALE_SETTINGS
[options]
#        [checkbox]
#            id=battleroyale_respawn
#            default=yes
#            name="Enable Ghosts"
#            description="When players die, AI-controlled ghosts of their unit are spawned some time after."
#        [/checkbox]
        [checkbox]
            id=battleroyale_noghost
            default=no
            name="Disable Ghosts"
            description="Disables the AI-controlled ghosts that spawn some time after players die."
        [/checkbox]
        [checkbox]
            id=battleroyale_noshrink
            default=no
            name="Disable Shrinking Map"
            description="Disables the map shrinking over the course of the match"
        [/checkbox]
        [checkbox]
            id=battleroyale_noloot
            default=no
            name="Disable Loot"
            description="Disables random items that spawn on the map."
        [/checkbox]
[/options]
#enddef

#define BATTLE_ROYALE_SPAWNITEM X Y TEXT TEXT_COLOR IMAGE EFFECT
{VARIABLE br_tmp_x {X}}
{VARIABLE br_tmp_y {Y}}
[label]
    text={TEXT}
    x,y=$br_tmp_x,$br_tmp_y
    color={TEXT_COLOR}
[/label]
[set_variables]
    name=battle_royale_loot_tiles
    mode=append
    [value]
        x=$br_tmp_x
        y=$br_tmp_y
    [/value]
[/set_variables]
[item]
    x=$br_tmp_x
    y=$br_tmp_y
    name=battleroyale_item_{IMAGE}
    image={IMAGE}
[/item]
[event]
    name=moveto
    delayed_variable_substitution=no
    [filter]
        x,y=$br_tmp_x,$br_tmp_y
        [not]
            side=9#AI side
        [/not]
    [/filter]
    {EFFECT}
    [remove_item]
        x,y=$br_tmp_x,$br_tmp_y
        image=battleroyale_item_{IMAGE}
    [/remove_item]
    [label]
        text=""
        x,y=$br_tmp_x,$br_tmp_y
    [/label]
#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$battle_royale_loot_tiles.length
    [/variable]
    [do]
        {IF_VAR battle_royale_loot_tiles[$|c].x equals $br_tmp_x (
        [and]
            {VARIABLE_CONDITIONAL battle_royale_loot_tiles[$|c].y equals $br_tmp_y}
        [/and]
        [then]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$|c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        )}
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}
[/event]
{CLEAR_VARIABLE br_tmp_x,br_tmp_y}
#enddef

#different item rarities have different colors

#define BATTLE_ROYAL_ITEM_CASE_COMMON NUM TEXT IMAGE CODE
[case]
   value={NUM}
   {BATTLE_ROYALE_SPAWNITEM $random_placement_location.x $random_placement_location.y {TEXT} 100,100,255 {IMAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYAL_ITEM_CASE_RARE NUM TEXT IMAGE CODE
[case]
   value={NUM}
   {BATTLE_ROYALE_SPAWNITEM $random_placement_location.x $random_placement_location.y {TEXT} 200,0,255 {IMAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYAL_ITEM_CASE_LEGENDARY NUM TEXT IMAGE CODE
[case]
   value={NUM}
   {BATTLE_ROYALE_SPAWNITEM $random_placement_location.x $random_placement_location.y {TEXT} 255,255,0 {IMAGE} {CODE}}
[/case]
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_COMMON NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    [random_placement]
        num_items={NUMBER}
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
            [/not]
        [/filter_location]
        [command]
            {VARIABLE_OP battle_royale_item_type rand 1..5}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_COMMON 1 _"Heal Potion (Common)" "items/potion-red.png" (
                [sound]
                    name=potion.ogg
                [/sound]
                [heal_unit]
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    amount=full
                    animate=yes
                [/heal_unit]
                )}
                {BATTLE_ROYAL_ITEM_CASE_COMMON 2 _"EXP Potion (Common)" "items/potion-blue.png" (
                [sound]
                    name=potion.ogg
                [/sound]
                [store_unit]
                   [filter]
                       id=$|unit.id
                   [/filter]
                   variable=tmp_exppotion_unit
                [/store_unit]
                {VARIABLE_OP exp_drained_unit.experience add 16}
                [unstore_unit]
                   variable=tmp_exppotion_unit
                   find_vacant=no
                [/unstore_unit]
                {CLEAR_VARIABLE tmp_exppotion_unit}
                )}
                {BATTLE_ROYAL_ITEM_CASE_COMMON 3 _"Elven Cloak (Common)" "items/cloak-green.png" (
                [object]
                    name= _ "Elven Cloak"
                    image=items/cloak-green.png
                    duration=forever
                    description= _ "Wearing an elven cloak allows you to hide in forests, sets your forest defense to 70%, and sets forest movecost to 1"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=defense
                        replace=yes
                        [defense]
                            forest=30
                        [/defense]
                    [/effect]
                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            forest=1
                        [/movement_costs]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_AMBUSH}
                        [/abilities]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_COMMON 4 _"Poison Bottle (Common)" "items/potion-poison.png" (
                [object]
                    name= _ "Poison bottle"
                    image=items/potion-poison.png
                    duration=forever
                    description= _ "All your attacks gain poison"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=attack
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_POISON}
                        [/set_specials]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_COMMON 5 _"Rat Cage (Common)" "units/monsters/giant-rat.png~BLIT(items/cage.png)" (
                    {REPEAT 4 (
                       {GENERIC_UNIT $|unit.side (Giant Rat) $|x1 $|y1}
                    )}
                )}
            [/switch]
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location}
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_RARE NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    [random_placement]
        num_items={NUMBER}
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
            [/not]
        [/filter_location]
        [command]
            {VARIABLE_OP battle_royale_item_type rand 1..3}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_RARE 1 _"Spectral Cloak (Rare)" "items/cloak-green.png~GS()~O(60%)" (
                [object]
                    name= _ "Spectral Cloak"
                    image=items/cloak-green.png
                    duration=forever
                    description= _ "Wearing the spectral cloak gives you the following benefits: 
-nightstalk
-skirmisher
-1 more movement
-you can move freely over unwalkable/impassable terrain"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=defense
                        replace=yes
                        [defense]
                            impassable=50
                            unwalkable=50
                        [/defense]
                    [/effect]
                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            impassable=1
                            unwalkable=1
                        [/movement_costs]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_NIGHTSTALK}
                            {ABILITY_SKIRMISHER}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
                    [effect]
                        apply_to=image_mod
                        add="~O(70%)"
                    [/effect]
                [/object]
                )}

            [/switch]
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location}
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    [random_placement]
        num_items={NUMBER}
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
            [/not]
        [/filter_location]
        [command]
            {VARIABLE_OP battle_royale_item_type rand 1..3}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 1 _"Sceptre of Fire (Legendary)" "items/sceptre-of-fire.png" (
                [sound]
                    name=fire.wav
                [/sound]
                [object]
                    name= _ "Sceptre of Fire"
                    image=items/sceptre-of-fire.png
                    duration=forever
                    description= _ "This ancient Sceptre was forged by the great Dwarves of the Heart Mountains. A symbol of the kingship of Wesnoth, the Sceptre has the power to shoot fireballs at enemies of the bearer!"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=sceptre of fire
                        description= _"sceptre of fire"
                        type=fire
                        range=ranged
                        [specials]
                            {WEAPON_SPECIAL_MAGICAL}
                        [/specials]
                        icon=attacks/fireball.png
                        damage=8
                        number=4
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=sceptre of fire
                        increase_damage=3
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=sceptre of fire
                            [/filter_attack]
                            {MISSILE_FRAME_FIREBALL_XY -16 -21}
                            start_time=-300
                            [frame]
                                sound=fire.wav
                                duration=200
                            [/frame]
                        [/attack_anim]
                    [/effect]
                [/object]
                )}
            [/switch]
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location}
#enddef


#define BATTLE_ROYALE_SHRINK_MAP TURN RADIUS
#TODO: make this erase loot too
[event]
    name=turn {TURN}
    delayed_variable_substitution=no
    [terrain]
        [not]
            x,y=$($map_size.width|/2),$($map_size.height|/2)
            radius={RADIUS}
        [/not]
        terrain=Xv
        layer=both
    [/terrain]

#clear all items on void

#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$battle_royale_loot_tiles.length
    [/variable]
    [do]
        [if]
        [have_location]
            x,y=$battle_royale_loot_tiles[$c].x,$battle_royale_loot_tiles[$c].y
        [/have_location]
        [then]
            [remove_item]
                x,y=$battle_royale_loot_tiles[$c].x,$battle_royale_loot_tiles[$c].y
            [/remove_item]
            [label]
                text=""
                x,y=$battle_royale_loot_tiles[$c].x,$battle_royale_loot_tiles[$c].y
            [/label]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        [/if]
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}
    [kill]
        [filter_location]
            terrain=Xv
        [/filter_location]
        animate=yes
        fire_event=yes
    [/kill]
[/event]
#enddef

#define BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC
[event]
    name=start
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
    [then]

    {VARIABLE max_radius "$(($map_size.width| + $map_size.height|) / 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 2 "$($max_radius)"}
#    {BATTLE_ROYALE_SHRINK_MAP 3 "$($max_radius - 2)"}
#    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius - 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 5 "$($max_radius - 6)"}
    [event]
        name=turn 2
        [chat]
            speaker="Battle Royale"
            message="WARNING: the map will start shrinking every two turns at turn 4, stay away from the edge of the map or you'll get killed!"
        [/chat]        
    [/event]

    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius)"}
    {BATTLE_ROYALE_SHRINK_MAP 6 "$($max_radius * 0.9)"}
    {BATTLE_ROYALE_SHRINK_MAP 8 "$($max_radius * 0.8)"}
    {BATTLE_ROYALE_SHRINK_MAP 10 "$($max_radius * 0.7)"}
    {BATTLE_ROYALE_SHRINK_MAP 12 "$($max_radius * 0.6)"}
    {BATTLE_ROYALE_SHRINK_MAP 14 "$($max_radius * 0.5)"}
    {BATTLE_ROYALE_SHRINK_MAP 16 "$($max_radius * 0.4)"}
    {BATTLE_ROYALE_SHRINK_MAP 18 "$($max_radius * 0.3)"}
    [/then]
    [/if]
[/event]
#enddef


#define BATTLE_ROYALE_SPAWNENEMEIES TURN NUMBER TYPE
    [event]
       name=side 9 turn {TURN}
        {SCATTER_UNITS {NUMBER} {TYPE} 2 (

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                terrain=_off^_usr,Q*,W*,*^X*,X*,*^V*,Ce*,Ch,Ch*,Cv*,Co*,Cu*,Ct*#,K*
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=9
            generate_name=yes
            random_traits=yes
        )}
    [/event]
#enddef

#define BATTLE_ROYALE_SIDES
    [side]
        side=1
        team_name=1
        user_team_name= _ "teamname^Team 1"
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name= _ "teamname^Team 2"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name= _ "teamname^Team 3"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name= _ "teamname^Team 4"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name= _ "teamname^Team 5"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name= _ "teamname^Team 6"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name= _ "teamname^Team 7"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name= _ "teamname^Team 8"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=9
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
        hidden=yes
        no_leader=yes
        color=teal

        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYALE_EVENTS
    [event]
       name=prestart
        [store_unit]
                [filter]
                canrecruit=yes
                [/filter]
                variable=contestants
                kill=no
        [/store_unit]
        [store_map_dimensions]
        [/store_map_dimensions]
        {FOREACH contestants i}
        {VARIABLE_OP teleportx rand 1..$map_size.width}
        {VARIABLE_OP teleporty rand 1..$map_size.height}
        {TELEPORT_UNIT id=$contestants[$i].id $teleportx $teleporty}
        {NEXT i}
        {CLEAR_VARIABLE contestants}
        {CLEAR_VARIABLE teleportx}
        {CLEAR_VARIABLE teleporty}
        [store_map_dimensions]
        [/store_map_dimensions]
        {BATTLE_ROYALE_MICROAI 1}
        {BATTLE_ROYALE_MICROAI 2}
        {BATTLE_ROYALE_MICROAI 3}
        {BATTLE_ROYALE_MICROAI 4}
        {BATTLE_ROYALE_MICROAI 5}
        {BATTLE_ROYALE_MICROAI 6}
        {BATTLE_ROYALE_MICROAI 7}
        {BATTLE_ROYALE_MICROAI 8}
        {BATTLE_ROYALE_MICROAI 9}
    [/event]
    [event]
       name=die
       id=battleroyale_ghost
       first_time_only=no
       [filter]
         canrecruit=yes
       [/filter]
       [modify_side]
         side=$unit.side
         fog=no
       [/modify_side]
       [if]
       [have_unit]
        id=$second_unit.id
        canrecruit=yes
       [not]
        side=9
       [/not]
       [/have_unit]
       [then]
       [chat]
       speaker="Battle Royale"
       message="$second_unit.name| eliminated $unit.name|"
       [/chat]
       [/then]
       [else]
       [chat]
       speaker="Battle Royale"
       message="$unit.name| has been eliminated"
       [/chat]
       [/else]
       [/if]
       {IF_VAR battleroyale_noghost not_equals yes (
       [then]
       [store_unit]
                [filter]
                x,y=$x1,$y1
                [not]
                   race=undead
                [/not]
                [/filter]
                variable=contestant_ghost
                kill=no
                mode=append
        [/store_unit]
        [/then])}
    [/event]
    [event]
        name=turn 12,turn 20,turn 28,turn 32
        first_time_only=no
        [foreach]
           array=contestant_ghost
           index_var=i
           [do]

       {VARIABLE this_item.side 9}
#       {VARIABLE_OP this_item.max_hitpoints multiply 0.8}
       {VARIABLE this_item.hitpoints $this_item.max_hitpoints}
       {VARIABLE this_item.race undead}
       {VARIABLE this_item.canrecruit no}
        [store_map_dimensions]
        [/store_map_dimensions]
        {VARIABLE_OP teleportx rand 1..$map_size.width}
        {VARIABLE_OP teleporty rand 1..$map_size.height}
       {VARIABLE this_item.x $teleportx}
       {VARIABLE this_item.y $teleporty}
       [unstore_unit]
            variable=this_item
            find_vacant=yes
       [/unstore_unit]
       [object]
        silent=yes
        duration=forever
        [filter]
           id=$this_item.id
        [/filter]
        [effect]
           apply_to=image_mod
           add="~O(60%)~CS(-20,-70,0)"
        [/effect]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                arcane=-30#arcane resistance nerf for realism, since they are undead
            [/resistance]
        [/effect]
       [/object]
       [modify_unit]
        [filter]
           id=$this_item.id
        [/filter]
        {TRAIT_UNDEAD}
       [/modify_unit]
       [sound]
            name=wail.wav
       [/sound]
       [delay]
            time=200
       [/delay]
           [/do]
        [/foreach]
       {CLEAR_VARIABLE contestant_ghost}
        {CLEAR_VARIABLE teleportx}
        {CLEAR_VARIABLE teleporty}
    [/event]
    {BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC}
    [event]
        name=start
        {BATTLE_ROYALE_SCATTER_ITEMS_COMMON 15}#todo: make amount of items proportional to map size
        {BATTLE_ROYALE_SCATTER_ITEMS_RARE 7}#todo: make amount of items proportional to map size
        {BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY 3}#todo: maybe make amount of items proportional to map size
    [/event]
#enddef