#textdomain wesnoth-multiplayer

#change between human/ai for testing

#define BATTLE_ROYALE_CONTROLLER
human#enddef

#define BATTLE_ROYALE_SIDE_SETTINGS
        gold=50
        income=-2
        village_gold=1
        [ai]
        leader_ignores_keep=yes
        aggression=1.0

    [goal]
        [criteria]
            canrecruit=yes
        [/criteria]
        value=25
    [/goal]
        village_value=0.1
        [/ai]        
#enddef

#define BATTLE_ROYALE_MICROAI SIDE
        [micro_ai]
            side={SIDE}
            ai_type=hang_out
            action=add
            id=battleroyale_movetocenter
            [filter]
                canrecruit=yes
            [filter_location]
            [not]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=5
            [/not]
            [/filter_location]
            [/filter]
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=2
            [/filter_location]
            ca_score=30000#relatively low CA score, as other actions are higher priority
        [/micro_ai]
        [micro_ai]
            side={SIDE}
            ai_type=hang_out
            action=add
            id=battleroyale_chaseenemy
            [filter]
                canrecruit=yes
            [filter_location]
                x,y=$($map_size.width|/2),$($map_size.height|/2)
                radius=5
            [/filter_location]
            [/filter]
            [filter_location]
            [filter]
            canrecruit=yes
            [filter_side]
            [enemy_of]
            side={SIDE}
            [/enemy_of]
            [/filter_side]
            [/filter]
            [/filter_location]
            ca_score=30000#relatively low CA score, as other actions are higher priority
        [/micro_ai]
        [micro_ai]
            side=2
            ai_type=goto
            action=add
            ca_id=battleroyale_get_items
            [filter]
                [not]
                    side=9#AI creatures/ghosts side
                [/not]
                [filter_location]
                    find_in=battle_royale_loot_tiles
                    radius=10
                [/filter_location]
            [/filter]
            [filter_location]
                find_in=battle_royale_loot_tiles
            [/filter_location]
            ca_score=70000#priority is lower than to attack
            remove_movement=no
            unique_goals=yes
        [/micro_ai]
        [micro_ai]
            side=2
            ai_type=goto
            action=add
            ca_id=battleroyale_get_items_near

            [filter]
                [not]
                    side=9#AI creatures/ghosts side
                [/not]
                [filter_location]
                    find_in=battle_royale_loot_tiles
                    radius=3
                [/filter_location]
            [/filter]
            [filter_location]
                find_in=battle_royale_loot_tiles
            [/filter_location]
            ca_score=150000#getting nearby items is higher priority than attack
            remove_movement=no
            unique_goals=yes
        [/micro_ai]#enddef

#define BATTLE_ROYALE_SETTINGS
[options]
#        [checkbox]
#            id=battleroyale_respawn
#            default=yes
#            name="Enable Ghosts"
#            description="When players die, AI-controlled ghosts of their unit are spawned some time after."
#        [/checkbox]
        [checkbox]
            id=battleroyale_noghost
            default=no
            name="Disable Ghosts"
            description="Disables the AI-controlled ghosts that spawn some time after players die."
        [/checkbox]
        [checkbox]
            id=battleroyale_noshrink
            default=no
            name="Disable Shrinking Map"
            description="Disables the map shrinking over the course of the match"
        [/checkbox]
        [checkbox]
            id=battleroyale_noloot
            default=no
            name="Disable Loot"
            description="Disables random items that spawn on the map."
        [/checkbox]
        [checkbox]
            id=battleroyale_see_items_in_fog
            default=yes
            name="Can see items in fog"
            description="If disabled, items will no longer be visible through fog. Good if you want a more realistic/hardcore experience."
        [/checkbox]
[/options]
#enddef

#define BATTLE_ROYALE_SPAWNITEM X Y TEXT TEXT_COLOR IMAGE HALO EFFECT
{VARIABLE br_tmp_x {X}}
{VARIABLE br_tmp_y {Y}}
[label]
    text={TEXT}
    x,y=$br_tmp_x,$br_tmp_y
    color={TEXT_COLOR}
    visible_in_fog=$battleroyale_see_items_in_fog
[/label]
[set_variables]
    name=battle_royale_loot_tiles
    mode=append
    [value]
        x=$br_tmp_x
        y=$br_tmp_y
    [/value]
[/set_variables]
[item]
    x=$br_tmp_x
    y=$br_tmp_y
    name=battleroyale_item_{IMAGE}
    image={IMAGE}
    halo={HALO}
    visible_in_fog=$battleroyale_see_items_in_fog
[/item]
[event]
    name=moveto
    delayed_variable_substitution=no
    [filter]
        x,y=$br_tmp_x,$br_tmp_y
        [not]
            side=9#AI creatures/ghosts side
        [/not]
    [/filter]
    {EFFECT}
    [remove_item]
        x,y=$br_tmp_x,$br_tmp_y
        image=battleroyale_item_{IMAGE}
    [/remove_item]
    [label]
        text=""
        x,y=$br_tmp_x,$br_tmp_y
    [/label]
#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$|battle_royale_loot_tiles.length
    [/variable]
    [do]
        {IF_VAR battle_royale_loot_tiles[$|c].x equals $br_tmp_x (
        [and]
            {VARIABLE_CONDITIONAL battle_royale_loot_tiles[$|c].y equals $br_tmp_y}
        [/and]
        [then]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$|c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        )}
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}
[/event]
{CLEAR_VARIABLE br_tmp_x,br_tmp_y}
#enddef

#different item rarities have different colors

#define BATTLE_ROYAL_ITEM_CASE_COMMON NUM TEXT IMAGE CODE
[case]
   value={NUM}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Common)" 100,100,255 {IMAGE} () {CODE}}
[/case]
#enddef

#define BATTLE_ROYAL_ITEM_CASE_RARE NUM TEXT IMAGE CODE
[case]
   value={NUM}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Rare)" 200,0,255 {IMAGE} () {CODE}}
[/case]
#enddef

#define BATTLE_ROYAL_ITEM_CASE_LEGENDARY NUM TEXT IMAGE HALO CODE
[case]
   value={NUM}
   {BATTLE_ROYALE_SPAWNITEM $tmp_itemplace_x $tmp_itemplace_y {TEXT}+_" (Legendary)" 255,255,0 {IMAGE} {HALO} {CODE}}
[/case]
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_COMMON X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    name=battleroyale_spawn_item_common
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_RARE X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    name=battleroyale_spawn_item_rare
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef

#define BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY X Y
{VARIABLE tmp_itemplace_x {X}}
{VARIABLE tmp_itemplace_y {Y}}
[fire_event]
    name=battleroyale_spawn_item_legendary
[/fire_event]
{CLEAR_VARIABLE tmp_itemplace_x,tmp_itemplace_y}
#enddef


#using events/fire_event instead of macros, as macros create crash-causing macro recursion issues with lootbox
#define BATTLE_ROYALE_ITEM_SPAWN_EVENTS
[event]
    name=battleroyale_spawn_item_common
    first_time_only=no
{VARIABLE_OP battle_royale_item_type rand 1..8}
[switch]
    variable=battle_royale_item_type
    {BATTLE_ROYAL_ITEM_CASE_COMMON 1 _"Heal Potion" "items/potion-red.png" (
    [sound]
        name=potion.ogg
    [/sound]
    [heal_unit]
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        amount=full
        animate=yes
    [/heal_unit]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 2 _"EXP Potion" "items/potion-blue.png" (
    [sound]
        name=potion.ogg
    [/sound]
    [store_unit]
       [filter]
           id=$|unit.id
       [/filter]
       variable=tmp_exppotion_unit
    [/store_unit]
    {VARIABLE_OP tmp_exppotion_unit.experience add 16}
    [unstore_unit]
       variable=tmp_exppotion_unit
       find_vacant=no
    [/unstore_unit]
    {CLEAR_VARIABLE tmp_exppotion_unit}
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 3 _"Elven Cloak" "items/cloak-green.png" (
    [object]
        name= _ "Elven Cloak"
        image=items/cloak-green.png
        duration=forever
        description= _ "Wearing an elven cloak allows you to hide in forests, sets your forest defense to 70%, and sets forest movecost to 1"
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=defense
            replace=yes
            [defense]
                forest=30
            [/defense]
        [/effect]
        [effect]
            apply_to=movement_costs
            replace=yes
            [movement_costs]
                forest=1
            [/movement_costs]
        [/effect]
        [effect]
            apply_to=new_ability
            [abilities]
                {ABILITY_AMBUSH}
            [/abilities]
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 4 _"Poison Bottle" "items/potion-poison.png" (
    [object]
        name= _ "Poison bottle"
        image=items/potion-poison.png
        duration=forever
        description= _ "All your attacks gain poison"
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=attack
            [set_specials]
                mode=append
                {WEAPON_SPECIAL_POISON}
            [/set_specials]
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 5 _"Rat Cage" "units/monsters/giant-rat.png~BLIT(items/cage.png)" (
        {REPEAT 4 (
           [unit]
               type=Giant Rat
               generate_name=yes
               random_traits=yes
               placement=map
               passable=yes
               x,y=$|x1,$|y1
           [/unit]
        )}
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 6 _"Iron Armor" "items/armor.png" (
    [object]
        name= _ "Iron Armor"
        image=items/armor.png
        duration=forever
        description= _ "Increases your physical resistances by 10%"
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                blade=-10
                pierce=-10
                impact=-10
            [/resistance]
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 7 _"Warding Amulet" "items/ankh-necklace.png" (
    [object]
        name= _ "Warding Amulet"
        image=items/ankh-necklace.png
        duration=forever
        description= _ "Increases your magical resistances by 10%"
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                arcane=-10
                fire=-10
                cold=-10
            [/resistance]
        [/effect]
    [/object]
    )}
    {BATTLE_ROYAL_ITEM_CASE_COMMON 8 _"Strength Potion" "items/potion-yellow.png" (
    [object]
        name= _ "Strength Potion"
        image=items/potion-yellow.png
        duration=forever
        description= _ "All your attacks gain 1 more damage. You gain 5 more max HP"
        [filter]
            x,y=$|x1,$|y1
        [/filter]
        [effect]
            apply_to=attack
            increase_damage=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase=5
            increase_total=5
        [/effect]        
    [/object]
    )}[/switch]
[/event]
[event]
    name=battleroyale_spawn_item_rare
    first_time_only=no
            {VARIABLE_OP battle_royale_item_type rand 1..5}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_RARE 1 _"Spectral Cloak" "items/cloak-green.png~GS()~O(60%)" (
                [object]
                    name= _ "Spectral Cloak"
                    image=items/cloak-green.png
                    duration=forever
                    description= _ "Wearing the spectral cloak gives you the following benefits: 
-nightstalk
-skirmisher
-1 more movement
-1 movement cost on flat/forest/sand/hills/mountains/frozen/cave terrain"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]

                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            flat=1
                            forest=1
                            sand=1
                            hills=1
                            mountains=1
                            frozen=1
                            cave=1
                        [/movement_costs]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_NIGHTSTALK}
                            {ABILITY_SKIRMISHER}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
                    [effect]
                        apply_to=image_mod
                        add="~O(70%)"
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 2 _"Lootbox" "items/box.png" (
                [object]
                    name= _ "Lootbox"
                    image=items/box.png
                    duration=forever
                    description= _ "The lootbox drops three random items next to is tile - they can be common, rare, or even legendary!"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                [/object]
                {REPEAT 3 (
                   [unit]
                       type=Fog Clearer
                       x,y=$|x1,$|y1
                       placement=map
                       passable=yes
                       hidden=yes
                       [modifications]
                            [object]
                                silent=yes
                                duration=scenario
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                      [dummy]
                                         id=battleroyale_itemplace_dummy#for filtering
                                      [/dummy]
                                    [/abilities]
                                [/effect]
                            [/object]
                       [/modifications]
                   [/unit]
                )}

                [store_unit]
                    [filter]
                        ability=battleroyale_itemplace_dummy
                    [/filter]
                    variable=itemplace_locs
                    kill=yes
                [/store_unit]

                [foreach]
                    array=itemplace_locs
                    index_var=i
                    [do]
#                    [chat]
#                        message="$this_item.x|,$this_item.y|"
#                    [/chat]
#                    [chat]
#                        message="$|this_item.x|,$|this_item.y|"
#                    [/chat]
                    {VARIABLE_OP tmp_lootbox_type_rand rand 1..10}
                    {IF_VAR tmp_lootbox_type_rand equals 1 (
                    [then]
                        {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $|this_item.x $|this_item.y}
                    [/then]
                    [elseif]
                        {VARIABLE_CONDITIONAL tmp_lootbox_type_rand less_than_equal_to 3}
                        [then]
                        {BATTLE_ROYALE_SPAWN_ITEM_RARE $|this_item.x $|this_item.y}
                        [/then]
                    [/elseif]
                    [else]
                        {BATTLE_ROYALE_SPAWN_ITEM_COMMON $|this_item.x $|this_item.y}
                    [/else]
                    )}
                    {CLEAR_VARIABLE tmp_lootbox_type_rand}
                    [/do]
                [/foreach]

                {CLEAR_VARIABLE itemplace_locs}

                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 3 _"Berserker Axe" "items/axe.png" (
                [object]
                    name= _ "Berserker Axe"
                    image=items/axe.png
                    duration=forever
                    description= _ "A powerful axe used by dwarven berserkers, it allows the wielder to attack extremely quickly"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=berserker axe
                        description= _"berserker axe"
                        type=blade
                        range=melee
                        [specials]
                            {WEAPON_SPECIAL_BERSERK}
                        [/specials]
                        icon=attacks/frenzy.png
                        damage=6
                        number=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=berserker axe
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=berserker axe
                            [/filter_attack]
                    
                            start_time=-200
                    
                            [frame]
                            duration=300
                            [/frame]
                    
                            {SOUND:HIT_AND_MISS axe.ogg {SOUND_LIST:MISS} -100}
                        [/attack_anim]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 4 _"Mausoleum" "misc/blank-hex.png~BLIT(scenery/mausoleum01.png~CROP(36,30,80,80))" (
                    [sound]
                        name=wail.wav
                    [/sound]
                    [unit]
                        type=Wraith
                        generate_name=yes
                        random_traits=yes
                        placement=map
                        passable=yes
                        x,y=$|x1,$|y1
                    [/unit]
                )}
                {BATTLE_ROYAL_ITEM_CASE_RARE 5 _"Vampire Amulet" "items/necklace-bone.png" (
                [object]
                    name= _ "Vampire Amulet"
                    image=items/necklace-bone.png
                    duration=forever
                    description= _ "All your attacks gain drain"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=attack
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_DRAIN}
                        [/set_specials]
                    [/effect]
                [/object]
                )}
            [/switch]
[/event]
[event]
    name=battleroyale_spawn_item_legendary
    first_time_only=no
            {VARIABLE_OP battle_royale_item_type rand 1..4}
            [switch]
                variable=battle_royale_item_type
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 1 _"Sceptre of Fire" "items/sceptre-of-fire.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(255,0,0,1):150" (
                [sound]
                    name=fire.wav
                [/sound]
                [object]
                    name= _ "Sceptre of Fire"
                    image=items/sceptre-of-fire.png
                    duration=forever
                    description= _ "This ancient Sceptre was forged by the great Dwarves of the Heart Mountains. A symbol of the kingship of Wesnoth, the Sceptre has the power to shoot fireballs at enemies of the bearer!"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=sceptre of fire
                        description= _"sceptre of fire"
                        type=fire
                        range=ranged
                        [specials]
                            {WEAPON_SPECIAL_MAGICAL}
                        [/specials]
                        icon=attacks/fireball.png
                        damage=8
                        number=4
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=sceptre of fire
                        increase_damage=3
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=sceptre of fire
                            [/filter_attack]
                            {MISSILE_FRAME_FIREBALL_XY -16 -21}
                            start_time=-300
                            [frame]
                                sound=fire.wav
                                duration=200
                            [/frame]
                        [/attack_anim]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 2 _"Cloning Circle" "scenery/summoning-center.png~BLEND(0,255,0,0.5)" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(0,255,0,1):150" (
                [sound]
                    name=magic-faeriefire.ogg
                [/sound]
                [store_unit]
                   [filter]
                       id=$|unit.id
                   [/filter]
                   variable=tmp_cloned_unit
                   kill=no
                [/store_unit]
                [unstore_unit]
                   variable=tmp_cloned_unit
                   find_vacant=yes
                [/unstore_unit]
                {CLEAR_VARIABLE tmp_cloned_unit}
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 3 _"Lightbringer" "items/sword-holy.png" "halo/illuminates-aura.png" (
                [sound]
                    name={SOUND_LIST:HOLY}
                [/sound]
                [object]
                    name= _ "Lightbringer"
                    image=items/sword-holy.png
                    duration=forever
                    description= _ "The Lightbringer is an ancient paladin sword, capable of slicing through any unholy abominations with ease. Wielding this holy blade also grants the following passive benefits:
- illuminates ability
- alignment is set to lawful
- +30% arcane resistance"
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=lightbringer
                        description=_"lightbringer"
                        icon=attacks/sword-holy.png
                        type=arcane
                        range=melee
                        [specials]
                            {WEAPON_SPECIAL_MAGICAL}
                        [/specials]
                        damage=8
                        number=3
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=lightbringer
                        increase_damage=1
                        increase_attacks=1
                        times=per level
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=lightbringer
                            [/filter_attack]
                        
                            start_time=-200
                        
                            [frame]
                            duration=300
                            sound={SOUND_LIST:HOLY_MISS}
                            [/frame]
                        
                            {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                        [/attack_anim]
                    [/effect]
                    [effect]
                        apply_to=alignment
                        set=lawful
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_ILLUMINATES}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=halo
                        halo="halo/illuminates-aura.png"
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            arcane=-30
                        [/resistance]
                    [/effect]
                [/object]
                )}
                {BATTLE_ROYAL_ITEM_CASE_LEGENDARY 4 _"Necronomicon" "items/book5.png" "halo/elven/shyde-stationary-halo[1~6].png~BLEND(0,0,0,1):150" (
                [object]
                    name= _ "Necronomicon"
                    image=items/book5.png
                    duration=forever
                    description= _ "When a living unit (either ally or enemy) dies in a 2-tile radius from this unit, they are revived as a soul thrall of the resurrecting unit's side. Soul thralls have -40% damage/max hitpoints/exp/max exp, their level is reduced by 1, and the alignment changes to chaotic."
                    [filter]
                        x,y=$|x1,$|y1
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=battle_royale_necronomicon
                                name=_"necronomicon"
                                description= _"When a living unit (either ally or enemy) dies in a 2-tile radius from this unit, they are revived as a soul thrall of the resurrecting unit's side. Soul thralls have -40% damage/max hitpoints/exp/max exp, their level is reduced by 1, and the alignment changes to chaotic. If a dying unit is the radius of both an ally and enemy unit with this ability, the ally takes priority."
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                )}

            [/switch]
[/event]
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_COMMON NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| common items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
                [or]
                    find_in=battle_royale_loot_tiles#to ensure items can't accidentally spawn on the same tile
                [/or]
            [/not]
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_COMMON $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_RARE NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| rare items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
                [or]
                    find_in=battle_royale_loot_tiles#to ensure items can't accidentally spawn on the same tile
                [/or]
            [/not]
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_RARE $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef

#define BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY NUMBER
#using a custom [random_placement] based on the default scatter unit macro
    {VARIABLE rounded_num {NUMBER}}
    {VARIABLE_OP rounded_num round floor}
    [chat]
        message="spawning $rounded_num| legendary items"
    [/chat]
    [random_placement]
        num_items=$rounded_num
        variable=random_placement_location
        allow_less=yes
        min_distance=1
        [filter_location]
            include_borders=no
            #prevent items from spawning too close to a player
            [not]
                [filter]
                [/filter]
                radius=2
            [/not]
            [not]
                terrain=X*,Q*,W*,_off^_usr
                [or]
                    find_in=battle_royale_loot_tiles#to ensure items can't accidentally spawn on the same tile
                [/or]
            [/not]
        [/filter_location]
        [command]
            {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $random_placement_location.x $random_placement_location.y}
        [/command]
    [/random_placement]

    {CLEAR_VARIABLE random_placement_location,rounded_num}
#enddef


#define BATTLE_ROYALE_SHRINK_MAP TURN RADIUS
#TODO: make this erase loot too
[event]
    name=turn {TURN}
    delayed_variable_substitution=no
    [terrain]
        [not]
            x,y=$($map_size.width|/2),$($map_size.height|/2)
            radius={RADIUS}
        [/not]
        terrain=Xv
        layer=both
    [/terrain]

#clear all items on void

#using a while loop (original deprecated FOREACH implementation) instead of foreach as it's better for deleting array elements

{VARIABLE c 0}
[while]
    [variable]
    name=c
    less_than=$|battle_royale_loot_tiles.length
    [/variable]
    [do]
#        [chat]
#            message="while loop"
#        [/chat]
#        [chat]
#            message="$|battle_royale_loot_tiles[$|c].x|,$|battle_royale_loot_tiles[$|c].y|"
#        [/chat]
        [if]
        [have_location]
            x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            terrain=Xv
        [/have_location]
        [then]
            [remove_item]
                x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            [/remove_item]
            [label]
                text=""
                x,y=$|battle_royale_loot_tiles[$|c].x,$|battle_royale_loot_tiles[$|c].y
            [/label]
            {CLEAR_VARIABLE battle_royale_loot_tiles[$|c]}
            {VARIABLE_OP c sub 1}#this is to fix weirdness when something in an array is deleted
        [/then]
        [/if]
    [set_variable]
    name=c
    add=1
    [/set_variable]
    [/do]
[/while]
{CLEAR_VARIABLE c}
    [kill]
        [filter_location]
            terrain=Xv
        [/filter_location]
        animate=yes
        fire_event=yes
    [/kill]
[/event]
#enddef

#define BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC
[event]
    name=start
    [if]
    {VARIABLE_CONDITIONAL battleroyale_noshrink not_equals yes}
    [then]

    {VARIABLE max_radius "$(($map_size.width| + $map_size.height|) / 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 2 "$($max_radius)"}
#    {BATTLE_ROYALE_SHRINK_MAP 3 "$($max_radius - 2)"}
#    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius - 4)"}
#    {BATTLE_ROYALE_SHRINK_MAP 5 "$($max_radius - 6)"}
    [event]
        name=turn 2
        [chat]
            speaker="Battle Royale"
            message="WARNING: the map will start shrinking every two turns at turn 4, stay away from the edge of the map or you'll get killed!"
        [/chat]        
    [/event]

    {BATTLE_ROYALE_SHRINK_MAP 4 "$($max_radius)"}
    {BATTLE_ROYALE_SHRINK_MAP 6 "$($max_radius * 0.9)"}
    {BATTLE_ROYALE_SHRINK_MAP 8 "$($max_radius * 0.8)"}
    {BATTLE_ROYALE_SHRINK_MAP 10 "$($max_radius * 0.7)"}
    {BATTLE_ROYALE_SHRINK_MAP 12 "$($max_radius * 0.6)"}
    {BATTLE_ROYALE_SHRINK_MAP 14 "$($max_radius * 0.5)"}
    {BATTLE_ROYALE_SHRINK_MAP 16 "$($max_radius * 0.4)"}
    {BATTLE_ROYALE_SHRINK_MAP 18 "$($max_radius * 0.3)"}
    [/then]
    [/if]
[/event]
#enddef


#define BATTLE_ROYALE_SPAWNENEMEIES TURN NUMBER TYPE
    [event]
       name=side 9 turn {TURN}
        {SCATTER_UNITS {NUMBER} {TYPE} 2 (

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                terrain=_off^_usr,Q*,W*,*^X*,X*,*^V*,Ce*,Ch,Ch*,Cv*,Co*,Cu*,Ct*#,K*
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=9
            generate_name=yes
            random_traits=yes
        )}
    [/event]
#enddef

#define BATTLE_ROYALE_SIDES
    [side]
        side=1
        team_name=1
        user_team_name= _ "teamname^Team 1"
        canrecruit=yes
        controller=human
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=2
        team_name=2
        user_team_name= _ "teamname^Team 2"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name= _ "teamname^Team 3"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=4
        team_name=4
        user_team_name= _ "teamname^Team 4"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=5
        team_name=5
        user_team_name= _ "teamname^Team 5"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=6
        team_name=6
        user_team_name= _ "teamname^Team 6"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=7
        team_name=7
        user_team_name= _ "teamname^Team 7"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=8
        team_name=8
        user_team_name= _ "teamname^Team 8"
        canrecruit=yes
        controller={BATTLE_ROYALE_CONTROLLER}
        fog=yes
        {BATTLE_ROYALE_SIDE_SETTINGS}
    [/side]
    [side]
        side=9
        controller=ai
        team_name=monster
        controller_lock=yes
        faction_lock=yes
        leader_lock=yes
        team_lock=yes
        user_team_name= _ "team_name^Monsters"
        hidden=yes
        no_leader=yes
        color=teal

        gold=0
        income=0
        [ai]
        [/ai]
    [/side]
#enddef

#define BATTLE_ROYALE_EVENTS
    [event]
       name=prestart
        [store_unit]
                [filter]
                canrecruit=yes
                [/filter]
                variable=contestants
                kill=no
        [/store_unit]
        [store_map_dimensions]
        [/store_map_dimensions]
        {FOREACH contestants i}
        {VARIABLE_OP teleportx rand 1..$map_size.width}
        {VARIABLE_OP teleporty rand 1..$map_size.height}
        {TELEPORT_UNIT id=$contestants[$i].id $teleportx $teleporty}
        {NEXT i}
        {CLEAR_VARIABLE contestants}
        {CLEAR_VARIABLE teleportx}
        {CLEAR_VARIABLE teleporty}
        [store_map_dimensions]
        [/store_map_dimensions]
        {BATTLE_ROYALE_MICROAI 1}
        {BATTLE_ROYALE_MICROAI 2}
        {BATTLE_ROYALE_MICROAI 3}
        {BATTLE_ROYALE_MICROAI 4}
        {BATTLE_ROYALE_MICROAI 5}
        {BATTLE_ROYALE_MICROAI 6}
        {BATTLE_ROYALE_MICROAI 7}
        {BATTLE_ROYALE_MICROAI 8}
        {BATTLE_ROYALE_MICROAI 9}
    [/event]
    [event]
       name=die
       id=battleroyale_elimination_event
       first_time_only=no
       [filter]
         canrecruit=yes
       [/filter]
       [modify_side]
         side=$unit.side
         fog=no
       [/modify_side]
       [if]
       [have_unit]
        id=$second_unit.id
        canrecruit=yes
       [not]
        side=9
       [/not]
       [/have_unit]
       [and]
       [not]
       [have_unit]
        id=$unit.id
        terrain=Xv
       [/have_unit]        
       [/not]
       [/and]
       [then]
       [chat]
       speaker="Battle Royale"
       message="$second_unit.name| eliminated $unit.name|"
       [/chat]
       [/then]
       [elseif]
       [have_unit]
        id=$unit.id
        terrain=Xv
       [/have_unit]
       [then]
       [chat]
       speaker="Battle Royale"
       message="$unit.name| has been consumed by the void at the map border"
       [/chat]
       [/then]
       [/elseif]
       [else]
       [chat]
       speaker="Battle Royale"
       message="$unit.name| has been eliminated"
       [/chat]
       [/else]
       [/if]
       {IF_VAR battleroyale_noghost not_equals yes (
       [then]
       [store_unit]
                [filter]
                x,y=$x1,$y1
                [not]
                   race=undead
                [/not]
                [/filter]
                variable=contestant_ghost
                kill=no
                mode=append
        [/store_unit]
        [/then])}
    [/event]
    [event]
        #ghosts spawn AFTER map shrinks
        name=turn 12 refresh,turn 20 refresh,turn 28 refresh,turn 32 refresh
        first_time_only=no
        [foreach]
           array=contestant_ghost
           index_var=i
           [do]

       {VARIABLE this_item.side 9}
#       {VARIABLE_OP this_item.max_hitpoints multiply 0.8}
       {VARIABLE this_item.hitpoints $this_item.max_hitpoints}
       {VARIABLE this_item.race undead}
       {VARIABLE this_item.canrecruit no}
        [store_map_dimensions]
        [/store_map_dimensions]
        {VARIABLE_OP teleportx rand 1..$map_size.width}
        {VARIABLE_OP teleporty rand 1..$map_size.height}
       {VARIABLE this_item.x $teleportx}
       {VARIABLE this_item.y $teleporty}
       [unstore_unit]
            variable=this_item
            find_vacant=yes
       [/unstore_unit]
       [object]
        silent=yes
        duration=forever
        [filter]
           id=$this_item.id
        [/filter]
        [effect]
           apply_to=image_mod
           add="~O(60%)~CS(-20,-70,0)"
        [/effect]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                arcane=-30#arcane resistance nerf for realism, since they are undead
            [/resistance]
        [/effect]
       [/object]
       [modify_unit]
        [filter]
           id=$this_item.id
        [/filter]
        {TRAIT_UNDEAD}
       [/modify_unit]
       [sound]
            name=wail.wav
       [/sound]
       [delay]
            time=200
       [/delay]
           [/do]
        [/foreach]
       {CLEAR_VARIABLE contestant_ghost}
        {CLEAR_VARIABLE teleportx}
        {CLEAR_VARIABLE teleporty}
    [/event]
    {BATTLE_ROYALE_SHRINK_MAP_AUTOMATIC}
    [event]
        name=start
        id=battleroyale_scatteritems

        {IF_VAR battleroyale_noloot not_equals yes (
        [then]

        #calculate the area of the map, distribute the number of items accordingly
        {VARIABLE br_map_area "$($map_size.width| * $map_size.height|)"}

        {BATTLE_ROYALE_SCATTER_ITEMS_COMMON "$($br_map_area / 80)"}
        {BATTLE_ROYALE_SCATTER_ITEMS_RARE "$($br_map_area / 240)"}
        {BATTLE_ROYALE_SCATTER_ITEMS_LEGENDARY "$(1 + $br_map_area / 900)"}

        {CLEAR_VARIABLE br_map_area}

        [/then]
        )}
    [/event]
    {BATTLE_ROYALE_ITEM_SPAWN_EVENTS}
#enddef

#define BATTLE_ROYALE_SPAWN_MINIBOSS ID TYPE
[event]
    name=start
    [unit]
        id={ID}
        type={TYPE}
        side=9
        generate_name=yes
        x,y=$($map_size.width|/2),$($map_size.height|/2)
        placement=map
        passable=yes
    [/unit]
    [modify_unit]
        [filter]
            id={ID}
        [/filter]
        {TRAIT_LOYAL_HERO}
        [trait]
            id=battle_royale_miniboss
            male_name=_"miniboss"
            female_name=_"female^miniboss"
            description=_"This unit drops a legendary item on death"
        [/trait]
    [/modify_unit]
[/event]
[event]
    name=die
    [filter]
        id={ID}
    [/filter]
    {BATTLE_ROYALE_SPAWN_ITEM_LEGENDARY $x1 $y1}
[/event]
[event]
    name=die
    id=battle_royale_necronomicon_event
    first_time_only=no
    [filter]
        [not]
            [filter_wml]
                [status]
                    not_living="yes"
                [/status]
            [/filter_wml]
        [/not]
        [filter_location]
            [filter]
                ability=battle_royale_necronomicon
#            [filter_side]
#            [allied_with]
#                side=$unit.side
#            [/allied_with]
#            [/filter_side]
            [not]
                id=$unit.id #to prevent the unit from self-reviving
            [/not]
            [/filter]
            radius=2
        [/filter_location]
    [/filter]

#do several different [store_unit]s by priority: if there is a resurrecter of same side, use him, if not, check if there is an ally resurrecter, if not, pick any including enemy

    [store_unit]
        [filter]
            side=$unit.side
            ability=battle_royale_necronomicon
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]

    {IF_VAR battle_royale_necronomiconer.length greater_than 0 (
    [else]
    [store_unit]
        [filter]
            ability=battle_royale_necronomicon
            [filter_side]
            [allied_with]
                side=$unit.side
            [/allied_with]
            [/filter_side]
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]
    [/else]
    )}

    {IF_VAR battle_royale_necronomiconer.length greater_than 0 (
    [else]
    [store_unit]
        [filter]
            ability=battle_royale_necronomicon
            [filter_location]
                x,y=$x1,$y1
                radius=2
            [/filter_location]
        [/filter]
        variable=battle_royale_necronomiconer
        kill=no
    [/store_unit]
    [/else]
    )}

    [if]
    [have_unit]
        id=$battle_royale_necronomiconer[0].id
    [/have_unit]
    [then]

    [sound]
        name=magic-dark-big.ogg
    [/sound]

    {VARIABLE unit.side $battle_royale_necronomiconer[0].side}
    {IF_VAR unit.level greater_than 0 (
    [then]
    {VARIABLE_OP unit.level sub 1}
    [/then]
    )}
    [unstore_unit]
        variable=unit
        find_vacant=no
    [/unstore_unit]

    [modify_unit]
        [filter]
            id=$unit.id
            [not]
                trait=undead
            [/not]
        [/filter]
        {TRAIT_UNDEAD}
    [/modify_unit]

        [heal_unit]
            [filter]
                id=$unit.id
            [/filter]
            amount=full
            animate=no
            restore_statuses=yes
        [/heal_unit]

    [object]
        silent=yes
        duration=forever

        [filter]
            id=$unit.id
        [/filter]

        [effect]
            apply_to=hitpoints
            increase=-40%
            increase_total=-40%
        [/effect]        

        [effect]
            apply_to=attack
            increase_damage=-40%
        [/effect]

        [effect]
            apply_to=new_ability
            [abilities]
                [dummy]
                    id=battle_royale_shade#for reducing level on post advance
                [/dummy]
            [/abilities]
        [/effect]

        [effect]
            apply_to=alignment
            set=chaotic
        [/effect]

        [effect]
            apply_to=image_mod
            add="~GS()~BLEND(125,0,125,0.4)~O(50%)"
        [/effect]

        [effect]
            apply_to=experience
            increase=-40%
        [/effect]

        [effect]
            apply_to=max_experience
            increase=-40%
        [/effect]

    [/object]

    [/then]
    [/if]

    {CLEAR_VARIABLE battle_royale_necronomiconer}
[/event]
#event to ensure amlas don't reduce soul level
[event]
    name=pre advance
    id=battle_royale_necronomicon_shade_reduce_level_pre
    first_time_only=no
    [filter]
        ability=battle_royale_shade
        [not]
            [filter_wml]
                advances_to=""
            [/filter_wml]
        [/not]
    [/filter]
    {VARIABLE tmp_battle_royale_reduce_soul_level yes}
[/event]
#reduces shade level by 1 during post advance, as variable changes don't persist on levelup:
[event]
    name=post advance
    id=battle_royale_necronomicon_shade_reduce_level
    first_time_only=no
    [filter]
        ability=battle_royale_shade
    [/filter]

    {IF_VAR unit.level greater_than 0 (
    [and]
    {VARIABLE_CONDITIONAL tmp_battle_royale_reduce_soul_level equals yes}
    [/and]
    [then]
    {VARIABLE_OP unit.level sub 1}
    [/then]
    )}

    [unstore_unit]
        variable=unit
        find_vacant=no
    [/unstore_unit]

    {CLEAR_VARIABLE tmp_battle_royale_reduce_soul_level}
[/event]
#enddef